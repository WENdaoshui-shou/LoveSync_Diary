{% extends 'mall/mall_base.html' %}

{% block title %}我的订单 - LoveSync{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
        .order-card-hover {
            transition: all 0.3s ease;
        }
        .order-card-hover:hover {
            box-shadow: 0 10px 25px -5px rgba(255, 107, 139, 0.1), 0 10px 10px -5px rgba(255, 107, 139, 0.04);
            transform: translateY(-2px);
        }
    }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="fa-solid fa-chevron-right text-gray-400 mx-2 text-xs"></i>
        <span class="text-primary font-medium text-sm">我的订单</span>
    </div>
</li>
{% endblock %}

{% block content_body %}
<div class="py-8">
    <!-- 订单状态筛选 -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-8">
        <div class="flex flex-wrap justify-center gap-4">
            <a href="{% url 'mall:order_list' %}"
                class="px-6 py-2 rounded-full {% if not status %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-list-ul mr-2"></i>全部
            </a>
            <a href="{% url 'mall:order_list' %}?status=pending"
                class="px-6 py-2 rounded-full {% if status == 'pending' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-clock mr-2"></i>待付款
            </a>
            <a href="{% url 'mall:order_list' %}?status=paid"
                class="px-6 py-2 rounded-full {% if status == 'paid' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-box mr-2"></i>待发货
            </a>
            <a href="{% url 'mall:order_list' %}?status=shipped"
                class="px-6 py-2 rounded-full {% if status == 'shipped' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-truck mr-2"></i>待收货
            </a>
            <a href="{% url 'mall:order_list' %}?status=delivered"
                class="px-6 py-2 rounded-full {% if status == 'delivered' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-check-circle mr-2"></i>已完成
            </a>
            <a href="{% url 'mall:order_list' %}?status=cancelled"
                class="px-6 py-2 rounded-full {% if status == 'cancelled' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                <i class="fa-solid fa-times-circle mr-2"></i>已取消
            </a>
        </div>
    </div>

    <!-- 订单列表 -->
    <div class="space-y-6">
        {% if orders %}
        {% for order in orders %}
        <div class="bg-white rounded-xl shadow-sm overflow-hidden order-card-hover">
            <!-- 订单头部 -->
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <div class="flex items-center">
                    <span class="text-gray-500">订单编号：</span>
                    <span class="font-medium ml-2">{{ order.order_number }}</span>
                </div>
                <div class="flex items-center">
                    <span class="text-gray-500 mr-2">下单时间：</span>
                    <span>{{ order.created_at|date:'Y-m-d H:i' }}</span>
                    <span
                        class="ml-4 px-3 py-1 rounded-full text-sm {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif order.status == 'paid' %}bg-blue-100 text-blue-800{% elif order.status == 'shipped' %}bg-green-100 text-green-800{% elif order.status == 'delivered' %}bg-purple-100 text-purple-800{% elif order.status == 'cancelled' %}bg-gray-100 text-gray-800{% endif %}">
                        {{ order.get_status_display }}
                    </span>
                </div>
            </div>

            <!-- 订单商品 -->
            <div class="px-6 py-4">
                <div class="space-y-4">
                    {% for item in order.items.all %}
                    <div class="flex space-x-4">
                        <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}"
                            class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ item.product.name }}</h3>
                            {% if item.sku %}
                            <p class="text-sm text-gray-500 mt-1">规格：{{ item.sku.name }}</p>
                            {% endif %}
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-primary font-bold">¥{{ item.price }}</span>
                                <span class="text-gray-500">x{{ item.quantity }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- 订单底部 -->
            <div class="px-6 py-4 border-t border-gray-100 flex flex-wrap justify-between items-center">
                <div class="text-gray-500 mb-4 md:mb-0">
                    <span>共 {{ order.items.count }} 件商品</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right mr-4">
                        <span class="text-gray-500">实付款：</span>
                        <span class="text-xl font-bold text-primary">¥{{ order.total_amount }}</span>
                    </div>
                    <div class="flex gap-2">
                        {% if order.status == 'pending' %}
                        <a href="{% url 'mall:order_detail' order.order_number %}"
                            class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </a>
                        <a href="#"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fa-solid fa-credit-card mr-1"></i>立即支付
                        </a>
                        {% elif order.status == 'paid' %}
                        <a href="{% url 'mall:order_detail' order.order_number %}"
                            class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </a>
                        {% elif order.status == 'shipped' %}
                        <a href="{% url 'mall:order_detail' order.order_number %}"
                            class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </a>
                        <a href="{% url 'mall:logistics_track' order.order_number %}"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fa-solid fa-truck mr-1"></i>查看物流
                        </a>
                        <a href="#"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fa-solid fa-check mr-1"></i>确认收货
                        </a>
                        {% elif order.status == 'delivered' %}
                        <a href="{% url 'mall:order_detail' order.order_number %}"
                            class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </a>
                        <a href="{% url 'mall:order_review' order.id %}"
                            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            <i class="fa-solid fa-comment mr-1"></i>评价
                        </a>
                        {% else %}
                        <a href="{% url 'mall:order_detail' order.order_number %}"
                            class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                            <i class="fa-solid fa-eye mr-1"></i>查看详情
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <!-- 空订单状态 -->
        <div class="bg-white rounded-xl shadow-sm p-16 text-center">
            <div class="w-24 h-24 mx-auto mb-6 flex items-center justify-center rounded-full bg-gray-100">
                <i class="fa-solid fa-box-open text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-xl font-medium mb-4">暂无订单</h3>
            <p class="text-gray-500 mb-6">您还没有任何订单，快去商城逛逛吧</p>
            <a href="{% url 'mall:mall' %}"
                class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors inline-flex items-center">
                <i class="fa-solid fa-shopping-bag mr-2"></i>去商城逛逛
            </a>
        </div>
        {% endif %}
    </div>

    <!-- 分页 -->
    {% if orders.has_other_pages %}
    <div class="flex justify-center mt-10">
        <nav class="inline-flex rounded-md shadow">
            {% if orders.has_previous %}
            <a href="?page={{ orders.previous_page_number }}{% if status %}&status={{ status }}{% endif %}"
                class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            {% else %}
            <span class="px-3 py-2 rounded-l-md border border-gray-300 bg-gray-50 text-gray-400">
                <i class="fa-solid fa-chevron-left"></i>
            </span>
            {% endif %}

            {% for i in orders.paginator.page_range %}
            {% if orders.number == i %}
            <span class="px-3 py-2 border border-primary bg-primary text-white">
                {{ i }}
            </span>
            {% else %}
            <a href="?page={{ i }}{% if status %}&status={{ status }}{% endif %}"
                class="px-3 py-2 border border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                {{ i }}
            </a>
            {% endif %}
            {% endfor %}

            {% if orders.has_next %}
            <a href="?page={{ orders.next_page_number }}{% if status %}&status={{ status }}{% endif %}"
                class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="px-3 py-2 rounded-r-md border border-gray-300 bg-gray-50 text-gray-400">
                <i class="fa-solid fa-chevron-right"></i>
            </span>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock content_body %}

{% block extra_js %}
<script>
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function () {
        // 辅助函数：选择包含特定文本的元素
        function getElementsContainingText(selector, text) {
            const elements = document.querySelectorAll(selector);
            return Array.from(elements).filter(element =>
                element.textContent.includes(text)
            );
        }

        // 确认收货功能
        const confirmReceiptBtns = getElementsContainingText('a', '确认收货');
        confirmReceiptBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                // 这里可以添加确认收货的API调用
                showToast('操作成功', '已确认收货', true);
                // 刷新页面
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            });
        });

        // 立即支付功能
        const payBtns = getElementsContainingText('a', '立即支付');
        payBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                showToast('提示', '支付功能正在开发中', true);
            });
        });

        // 评价功能 - 已实现，无需阻止默认行为
        // 移除阻止评价按钮的代码，让用户能够正常跳转到评价页面
    });
</script>
{% endblock %}