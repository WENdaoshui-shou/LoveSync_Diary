{% extends 'mall/mall_base.html' %}

{% block title %}{{ product.name }} - LoveSync 情侣商城{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bg-gradient-love {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .hover-scale {
                transition: transform 0.3s ease;
            }

            .hover-scale:hover {
                transform: scale(1.03);
            }

            .form-input-focus {
                transition: all 0.3s ease;
            }

            .form-input-focus:focus {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(255, 107, 139, 0.1), 0 10px 10px -5px rgba(255, 107, 139, 0.04);
            }

            .btn-pulse {
                animation: pulse 2s infinite;
            }

            /* 添加淡入动画 */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fade-in {
                animation: fadeIn 0.5s ease forwards;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(255, 107, 139, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0);
                }
            }

            .float-animation {
                animation: float 6s ease-in-out infinite;
            }

            @keyframes float {
                0% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-20px);
                }
                100% {
                    transform: translateY(0px);
                }
            }

            .product-card {
                transition: all 0.3s ease;
            }

            .product-card:hover {
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
                transform: translateY(-5px);
            }

            /* 自定义收藏和购物车图标样式 */
            .custom-icon {
                font-size: 1.8rem; /* 直接设置字体大小，控制图标尺寸，根据需要改 */
            }

            /* 自定义徽章样式 */
            .custom-badge {
                width: 16px;
                height: 16px;
                font-size: 10px; /* 调整徽章内数字的大小 */
                line-height: 16px; /* 让数字垂直居中 */
            }

            .category-active {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
                color: white;
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .card-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            }
        }
</style>
{% endblock %}

{% block breadcrumb_items %}
<li>
    <div class="flex items-center">
        <i class="fa-solid fa-chevron-right text-xs text-neutral-400 mx-2"></i>
        <span class="text-neutral-800 font-medium text-sm">{{ product.name }}</span>
    </div>
</li>
{% endblock %}

{% block content_body %}
<div class="py-4 relative z-10">
    <!-- 商品详情区域 -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-12">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-6 md:p-8">
            <!-- 商品图片 -->
            <div class="relative">
                {% if product.main_image %}
                <img src="{{ product.main_image.url }}" alt="{{ product.name }}"
                    class="w-full h-auto max-h-96 object-contain rounded-xl hover-scale">
                {% else %}
                <img src="https://picsum.photos/id/1011/500/500" alt="{{ product.name }}"
                    class="w-full h-auto max-h-96 object-contain rounded-xl hover-scale">
                {% endif %}
                <button
                    class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center text-neutral-500 hover:text-primary transition-custom">
                    <i class="fa-regular fa-heart text-lg"></i>
                </button>
            </div>

            <!-- 商品信息 -->
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-neutral-800 mb-4">{{ product.name }}</h1>

                <!-- 评分和销量 -->
                <div class="flex items-center mb-6">
                    <div class="flex items-center text-yellow-400">
                        {% with full_stars=product.rating|floatformat:0|add:0 %}
                        {% for _ in ""|center:full_stars %}
                        <i class="fa-solid fa-star"></i>
                        {% endfor %}
                        {% endwith %}
                        {% if product.rating|floatformat:1|slice:"-2:" == ".5" %}
                        <i class="fa-solid fa-star-half-stroke"></i>
                        {% endif %}
                        <span class="text-neutral-600 ml-2">{{ product.rating|floatformat:1 }}</span>
                    </div>
                    <span class="mx-4 text-neutral-400">|</span>
                    <span class="text-neutral-600">月销 {{ product.monthly_sales }}</span>
                    <span class="mx-4 text-neutral-400">|</span>
                    <span class="text-neutral-600">库存 {{ product.product_stock }}</span>
                </div>

                <!-- 价格 -->
                <div class="mb-6">
                    <div class="flex items-baseline">
                        <span class="text-3xl font-bold text-primary">¥{{ product.price }}</span>
                        {% if product.old_price %}
                        <span class="text-neutral-400 text-lg line-through ml-4">¥{{ product.old_price }}</span>
                        <span class="ml-4 px-2 py-1 bg-primary/10 text-primary text-sm rounded">
                            省¥{{ product.old_price }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- 商品描述 -->
                {% if product.description %}
                <div class="mb-8">
                    <h3 class="font-medium text-neutral-800 mb-2">商品描述</h3>
                    <p class="text-neutral-600 leading-relaxed">{{ product.description }}</p>
                </div>
                {% endif %}

                <!-- 购买数量和按钮 -->
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6">
                    <!-- 数量选择 -->
                    <div class="flex items-center">
                        <span class="text-neutral-700 mr-4">数量</span>
                        <div class="flex items-center border border-neutral-200 rounded-lg overflow-hidden">
                            <button
                                class="w-10 h-10 flex items-center justify-center text-neutral-600 hover:bg-neutral-100 transition-custom"
                                id="decreaseQuantity">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                            <input type="number" value="1" min="1" max="{{ product.product_stock }}"
                                class="w-16 h-10 text-center border-none focus:outline-none form-input-focus"
                                id="quantityInput">
                            <button
                                class="w-10 h-10 flex items-center justify-center text-neutral-600 hover:bg-neutral-100 transition-custom"
                                id="increaseQuantity">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 购买按钮 -->
                    <div class="flex space-x-4">
                        <button id="addToCartBtn"
                            class="px-8 py-3 bg-primary/10 text-primary font-medium rounded-lg hover:bg-primary hover:text-white transition-custom flex items-center">
                            <i class="fa-solid fa-shopping-cart mr-2"></i> 加入购物车
                        </button>
                        <button id="buyNowBtn"
                            class="px-8 py-3 bg-gradient-love text-white font-medium rounded-lg hover:opacity-90 transition-custom flex items-center btn-pulse">
                            <i class="fa-solid fa-bag-shopping mr-2"></i> 立即购买
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 推荐商品 -->
    <div class="mb-12">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-neutral-800">猜你喜欢</h2>
            <a href="{% url 'mall:mall' %}" class="text-primary font-medium hover:underline flex items-center">
                查看更多 <i class="fa-solid fa-angle-right ml-1"></i>
            </a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5">
            {% for product in recommended_products %}
            <a href="{% url 'mall:product_detail' product.id %}"
                class="bg-white rounded-xl overflow-hidden shadow-sm product-card">
                <div class="relative">
                    {% if product.main_image %}
                    <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="w-full h-48 object-cover">
                    {% else %}
                    <img src="https://picsum.photos/id/1011/300/300" alt="{{ product.name }}"
                        class="w-full h-48 object-cover">
                    {% endif %}
                    <button
                        class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-neutral-500 hover:text-primary transition-custom">
                        <i class="fa-solid fa-heart"></i>
                    </button>
                </div>
                <div class="p-3">
                    <h3 class="font-medium text-neutral-800 text-sm line-clamp-2">{{ product.name }}</h3>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="text-primary font-bold">¥{{ product.price|floatformat:2 }}</span>
                        <div class="flex items-center text-yellow-400 text-xs">
                            <i class="fa-solid fa-star"></i>
                            <span class="text-neutral-500 ml-1">{{ product.rating|floatformat:1 }}</span>
                        </div>
                    </div>
                </div>
            </a>
            {% empty %}
            <div class="col-span-full text-center py-10">
                <p class="text-neutral-500">暂无推荐商品</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 热卖商品 -->
    <div class="mb-12">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-neutral-800">热卖商品</h2>
            <a href="{% url 'mall:mall' %}" class="text-primary font-medium hover:underline flex items-center">
                查看更多 <i class="fa-solid fa-angle-right ml-1"></i>
            </a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for product in hot_products %}
            <a href="{% url 'mall:product_detail' product.id %}" class="block">
                <div class="bg-white rounded-xl overflow-hidden shadow-sm product-card" data-id="{{ product.id }}">
                    <div class="relative">
                        {% if product.main_image %}
                        <img src="{{ product.main_image.url }}" alt="{{ product.name }}"
                            class="w-full h-64 object-cover">
                        {% else %}
                        <img src="https://picsum.photos/id/1011/300/300" alt="{{ product.name }}"
                            class="w-full h-64 object-cover">
                        {% endif %}
                        <button
                            class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center text-neutral-500 hover:text-primary transition-custom">
                            <i class="fa-regular fa-heart"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-medium text-neutral-800 line-clamp-1">{{ product.name }}</h3>
                        <div class="flex items-center mt-1">
                            <div class="flex items-center text-yellow-400 text-xs">
                                {% with full_stars=product.rating %}
                                {% for _ in ""|center:full_stars %}
                                <i class="fa-solid fa-star"></i>
                                {% endfor %}
                                {% endwith %}
                                {% if product.rating|floatformat:1|slice:"-2:" == ".5" %}
                                <i class="fa-solid fa-star-half-stroke"></i>
                                {% endif %}
                                <span class="text-neutral-500 ml-1">{{ product.rating|floatformat:1 }}</span>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center justify-between">
                            <div>
                                <span class="text-primary font-bold">¥{{ product.price|floatformat:2 }}</span>
                                {% if product.old_price %}
                                <span class="text-neutral-400 text-sm line-through ml-1">¥{{
                                    product.old_price|floatformat:2 }}</span>
                                {% endif %}
                            </div>
                            <button
                                class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center hover:bg-primary hover:text-white transition-custom add-to-cart"
                                data-id="{{ product.id }}">
                                <i class="fa-solid fa-shopping-cart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </a>
            {% empty %}
            <div class="col-span-full text-center py-10">
                <p class="text-neutral-500">暂无热卖商品</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // 1. 获取CSRF令牌（通用方法，保留）
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 2. 添加商品到购物车（优化异常处理、参数格式）
    function addToCart(productId, quantity = 1) {
        // 基础校验
        if (!productId || quantity < 1) {
            showToast('参数错误', '商品ID或数量无效！', false);
            return;
        }

        // 拼接请求URL（修复模板语法，确保URL正确）
        const addCartUrl = "{% url 'mall:add_to_cart' %}";

        fetch(addCartUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `product_id=${encodeURIComponent(productId)}&quantity=${encodeURIComponent(quantity)}`
        })
            .then(response => {
                // 处理HTTP错误（如404/500）
                if (!response.ok) {
                    throw new Error(`请求失败：${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // 替换alert为更友好的提示
                    showToast(data.message || '加入购物车成功！', 'success');
                    updateCartCount(); // 更新购物车数量
                } else {
                    showToast(data.message || '加入购物车失败，请重试！', 'error');
                }
            })
            .catch(error => {
                // 捕获网络错误/JSON解析错误
                console.error('加入购物车出错：', error);
                showToast('网络异常，请稍后再试！', 'error');
            });
    }

    // 3. 自定义Toast提示（替代alert，提升体验）
    function showToast(message, type = 'info') {
        // 创建toast元素
        const toast = document.createElement('div');
        // 设置样式
        toast.className = `fixed top-20 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
        // 根据类型设置样式
        if (type === 'success') {
            toast.classList.add('bg-green-500', 'text-white');
        } else if (type === 'error') {
            toast.classList.add('bg-red-500', 'text-white');
        } else {
            toast.classList.add('bg-blue-500', 'text-white');
        }
        toast.textContent = message;
        // 添加到页面
        document.body.appendChild(toast);
        // 显示动画
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 10);
        // 3秒后移除
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // 4. 更新购物车数量显示（使用真实API接口）
    function updateCartCount() {
        const cartCountElements = document.querySelectorAll('.fa-shopping-cart + span span');

        // 从后端获取真实数量
        fetch("{% url 'mall:cart_count' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`请求失败：${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const count = data.count || 0;
                    cartCountElements.forEach(el => {
                        el.textContent = count;
                        // 添加数字变化动画
                        el.classList.add('animate-pulse');
                        setTimeout(() => el.classList.remove('animate-pulse'), 500);
                    });
                }
            })
            .catch(err => {
                console.error('获取购物车数量失败：', err);
                // 失败时使用简单自增作为后备方案
                cartCountElements.forEach(el => {
                    const currentCount = parseInt(el.textContent) || 0;
                    el.textContent = currentCount + 1;
                    el.classList.add('animate-pulse');
                    setTimeout(() => el.classList.remove('animate-pulse'), 500);
                });
            });
    }

    // 5. 绑定热卖商品的加入购物车按钮
    function bindHotProductCartButtons() {
        const addCartButtons = document.querySelectorAll('.add-to-cart');
        addCartButtons.forEach(btn => {
            btn.addEventListener('click', function (e) {
                // 阻止默认跳转
                e.preventDefault();
                e.stopPropagation();
                const productId = this.getAttribute('data-id');
                addToCart(productId, 1);
            });
        });
    }

    // 6. 页面加载完成后初始化所有功能
    document.addEventListener('DOMContentLoaded', function () {
        // 6.1 获取DOM元素
        const quantityInput = document.getElementById('quantityInput');
        const decreaseBtn = document.getElementById('decreaseQuantity');
        const increaseBtn = document.getElementById('increaseQuantity');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const buyNowBtn = document.getElementById('buyNowBtn');
        const collectBtn = document.querySelector('.fa-heart').parentElement;
        // 修复：UUID需加引号，避免JS语法错误
        const productId = '{{ product.id }}';
        const productStock = "{{ product.product_stock }}";

        // 6.2 数量选择功能（优化校验逻辑）
        if (decreaseBtn && increaseBtn && quantityInput) {
            // 初始化数量为1（防止输入框为空）
            if (!quantityInput.value || parseInt(quantityInput.value) < 1) {
                quantityInput.value = 1;
            }
            // 修复：补充分号，修正stock赋值逻辑
            if (!quantityInput.max) {
                quantityInput.max = productStock;
            }

            // 减少数量（修复：移到if内部，避免元素不存在时报错）
            decreaseBtn.addEventListener('click', function () {
                let currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });

            // 增加数量（修复：移到if内部，避免元素不存在时报错）
            increaseBtn.addEventListener('click', function () {
                let currentValue = parseInt(quantityInput.value);
                let maxValue = parseInt(quantityInput.max);
                if (currentValue < maxValue) {
                    quantityInput.value = currentValue + 1;
                } else {
                    showToast(`最多只能购买${maxValue}件！`, 'info');
                }
            });

            // 监听输入框手动输入，防止非法值（修复：移到if内部）
            quantityInput.addEventListener('input', function () {
                let value = parseInt(this.value);
                const max = parseInt(this.max);
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > max) {
                    this.value = max;
                }
            });

            // 监听输入框失去焦点，格式化值（修复：移到if内部）
            quantityInput.addEventListener('blur', function () {
                let value = parseInt(this.value);
                const max = parseInt(this.max);
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > max) {
                    this.value = max;
                }
            });
        } // 修复：补全if的闭合大括号

        // 6.3 加入购物车按钮绑定
        if (addToCartBtn && quantityInput && productId) {
            addToCartBtn.addEventListener('click', function () {
                const quantity = parseInt(quantityInput.value) || 1;
                addToCart(productId, quantity);
                // 禁用按钮防止重复点击
                this.disabled = true;
                setTimeout(() => {
                    this.disabled = false;
                }, 1500);
            });
        }

        // 6.4 立即购买按钮绑定
        if (buyNowBtn && productId) {
            buyNowBtn.addEventListener('click', function () {
                const quantity = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;
                // 直接跳转到结算页面，传递商品ID和数量参数
                window.location.href = "{% url 'mall:checkout' %}" + `?direct_purchase=true&product_id=${productId}&quantity=${quantity}`;
            });
        }

        // 6.5 绑定热卖商品的加入购物车按钮
        bindHotProductCartButtons();

        // 6.6 收藏功能
        if (collectBtn) {
            collectBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const isCollected = this.querySelector('.fa-heart').classList.contains('fa-solid');

                if (isCollected) {
                    // 取消收藏
                    fetch("{% url 'mall:remove_mark' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: `product_id=${encodeURIComponent(productId)}`
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`请求失败：${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                showToast(data.message || '取消收藏成功！', 'success');
                                this.querySelector('.fa-heart').classList.remove('fa-solid', 'text-red-500');
                                this.querySelector('.fa-heart').classList.add('fa-regular');
                            } else {
                                showToast(data.message || '取消收藏失败，请重试！', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('取消收藏出错：', error);
                            showToast('网络异常，请稍后再试！', 'error');
                        });
                } else {
                    // 添加收藏
                    fetch("{% url 'mall:add_mark' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: `product_id=${encodeURIComponent(productId)}`
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`请求失败：${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                showToast(data.message || '收藏成功！', 'success');
                                this.querySelector('.fa-heart').classList.remove('fa-regular');
                                this.querySelector('.fa-heart').classList.add('fa-solid', 'text-red-500');
                            } else {
                                showToast(data.message || '收藏失败，请重试！', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('添加收藏出错：', error);
                            showToast('网络异常，请稍后再试！', 'error');
                        });
                }
            });
        }
    });
</script>
{% endblock %}