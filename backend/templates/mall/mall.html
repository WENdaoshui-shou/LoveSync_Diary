{% extends 'mall/mall_base.html' %}

{% block title %}LoveSync 情侣商城 - 为爱定制，共享美好{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bg-gradient-love {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .hover-scale {
                transition: transform 0.3s ease;
            }

            .hover-scale:hover {
                transform: scale(1.03);
            }

            .form-input-focus {
                transition: all 0.3s ease;
            }

            .form-input-focus:focus {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(255, 107, 139, 0.1), 0 10px 10px -5px rgba(255, 107, 139, 0.04);
            }

            .btn-pulse {
                animation: pulse 2s infinite;
            }

            /* 添加淡入动画 */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fade-in {
                animation: fadeIn 0.5s ease forwards;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(255, 107, 139, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0);
                }
            }

            .float-animation {
                animation: float 6s ease-in-out infinite;
            }

            @keyframes float {
                0% {
                    transform: translateY(0px);
                }
                50% {
                    transform: translateY(-20px);
                }
                100% {
                    transform: translateY(0px);
                }
            }

            .product-card {
                transition: all 0.3s ease;
            }

            .product-card:hover {
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
                transform: translateY(-5px);
            }

            /* 自定义收藏和购物车图标样式 */
            .custom-icon {
                font-size: 1.8rem; /* 直接设置字体大小，控制图标尺寸，根据需要改 */
            }

            /* 自定义徽章样式 */
            .custom-badge {
                width: 16px;
                height: 16px;
                font-size: 10px; /* 调整徽章内数字的大小 */
                line-height: 16px; /* 让数字垂直居中 */
            }

            .category-active {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
                color: white;
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .card-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01);
            }
        }
</style>
{% endblock %}

{% block content %}
<main class="flex-grow pt-32 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 轮播图区域 -->
        <div class="rounded-2xl overflow-hidden shadow-lg mb-8 relative">
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    {% for banner in banners %}
                    <div class="swiper-slide">
                        <div
                            class="w-full h-[400px] bg-gradient-to-r from-primary/20 to-secondary/20 flex items-center justify-center">
                            <img src="{{ banner.image.url }}" alt="{{ banner.title }}"
                                class="w-full h-full object-cover">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-black/40 to-transparent flex items-center">
                                <div class="px-8 md:px-16 max-w-lg">
                                    <h2 class="text-[clamp(1.8rem,4vw,3rem)] font-bold text-white leading-tight">
                                        {{ banner.title }}</h2>
                                    {% if banner.link %}
                                    <a href="{{ banner.link }}"
                                        class="mt-6 inline-block px-8 py-3 bg-gradient-love text-white rounded-full font-medium hover:opacity-90 transition-custom shadow-lg">
                                        了解详情 <i class="fa-solid fa-arrow-right ml-2"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
            </div>
        </div>

        <!-- 物品分类导航区 -->
        <div class="grid grid-cols-3 md:grid-cols-6 gap-4 mb-8">
            {% for category in categories %}
            <div class="relative group">
                <a href="{% url 'mall:category_products' category.id %}"
                    class="flex flex-col items-center p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition-all duration-300 hover-scale cursor-pointer">
                    <div
                        class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-2 group-hover:bg-primary group-hover:text-white transition-all duration-300 transform group-hover:scale-110">
                        {% if category.icon %}
                        <img src="{{ category.icon.url }}" alt="{{ category.name }}"
                            class="w-8 h-8 object-contain transition-transform duration-300 group-hover:rotate-6">
                        {% else %}
                        <i class="fa-solid fa-box text-2xl transition-transform duration-300 group-hover:rotate-6"></i>
                        {% endif %}
                    </div>
                    <span class="text-sm font-medium">{{ category.name }}</span>
                </a>
                <!-- 二级导航 -->
                {% if category.children and category.children|length > 0 %}
                <div
                    class="absolute left-1/2 -translate-x-1/2 mt-2 w-56 bg-white rounded-lg shadow-xl py-2 z-20 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform group-hover:scale-100 scale-95 origin-top">
                    <div class="p-1">
                        {% for child in category.children %}
                        <a href="{% url 'mall:category_products' child.id %}"
                            class="block px-4 py-2.5 text-neutral-700 hover:bg-neutral-50 rounded-lg transition-all duration-200 flex items-center group/item">
                            <i
                                class="fa-solid fa-chevron-right text-xs mr-2 text-neutral-400 group-hover/item:text-primary transition-colors"></i>
                            <span class="flex-1">{{ child.name }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- 热卖商品排行榜 -->
        <div class="mb-12">
            <div class="mt-8 bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
                    <h2 class="font-semibold text-lg flex items-center">
                        <i class="fa-solid fa-fire text-red-500 mr-2"></i>
                        {{ hot_desc }}
                    </h2>
                    <div class="flex space-x-2">
                        <a href="?hot_type=7d"
                            class="px-3 py-1 text-sm rounded-full transition-custom {% if hot_type == '7d' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                            7天热卖
                        </a>
                        <a href="?hot_type=30d"
                            class="px-3 py-1 text-sm rounded-full transition-custom {% if hot_type == '30d' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                            30天热卖
                        </a>
                        <a href="?hot_type=new"
                            class="px-3 py-1 text-sm rounded-full transition-custom {% if hot_type == 'new' %}bg-primary text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                            新品热卖
                        </a>
                    </div>
                </div>

                <div class="p-4">
                    <div class="space-y-4">
                        {% for product in hot_products %}
                        <!-- 排行榜商品 -->
                        <a href="{% url 'mall:product_detail' product.id %}"
                            class="flex items-center p-2 hover:bg-neutral-50 rounded-lg transition-custom">
                            <div
                                class="w-8 h-8 rounded-full {% if product.rank_tag == 'first' %}bg-red-500{% elif product.rank_tag == 'second' %}bg-red-400{% elif product.rank_tag == 'third' %}bg-orange-500{% else %}bg-gray-500{% endif %} text-white flex items-center justify-center font-bold mr-4">
                                {{ forloop.counter }}
                            </div>
                            <div class="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                                <img src="{{ product.main_image }}" alt="{{ product.name }}"
                                    class="w-full h-full object-cover">
                            </div>
                            <div class="ml-4 flex-grow">
                                <h3 class="font-medium text-sm line-clamp-1">{{ product.name }}</h3>
                                <div class="flex items-center mt-1">
                                    <div class="flex items-center text-yellow-400">
                                        {% with ''|center:product.rating|floatformat:0|make_list as range %}
                                        {% for _ in range %}
                                        <i class="fa-solid fa-star text-xs"></i>
                                        {% endfor %}
                                        {% endwith %}
                                        {% if product.rating|floatformat:1|slice:"-2:" == ".5" %}
                                        <i class="fa-solid fa-star-half-stroke text-xs"></i>
                                        {% endif %}
                                        <span class="text-neutral-600 text-xs ml-1">{{ product.rating }}</span>
                                    </div>
                                    <span class="text-neutral-500 text-xs ml-2">销量
                                        {{ product.real_sales }}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-primary text-sm">¥{{ product.price }}</p>
                                <button
                                    class="mt-1 px-3 py-1 bg-primary text-white rounded-lg hover:bg-primary/90 transition-custom text-xs add-to-cart"
                                    data-id="{{ product.id }}">
                                    <i class="fa-solid fa-shopping-cart mr-1 add-to-cart-btn"
                                        onclick="addToCart('{{ product.id }}')"></i> 加入购物车
                                </button>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>

            </div>
        </div>

        <!-- 促销区域 -->
        <section class="mb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for flash_sale in current_flash_sales %}
                <div class="rounded-2xl overflow-hidden shadow-lg relative">
                    <img src="{{ flash_sale.cover_image.url }}" alt="{{ flash_sale.name }}"
                        class="w-full h-64 object-cover opacity-70">
                    <div class="absolute inset-0 flex flex-col justify-center p-8">
                        <h3 class="text-white text-2xl font-bold mb-2">{{ flash_sale.name }}</h3>
                        <p class="text-white/90 mb-4">{{ flash_sale.description }}</p>
                        {% if flash_sale.need_countdown %}
                        <div class="flex space-x-2 mb-6 countdown" data-endtime="{{ flash_sale.end_time.isoformat }}">
                            <div
                                class="bg-white/20 backdrop-blur-sm rounded-lg w-12 h-12 flex flex-col items-center justify-center">
                                <span class="text-white font-bold text-lg days">00</span>
                                <span class="text-white/80 text-xs">天</span>
                            </div>
                            <div
                                class="bg-white/20 backdrop-blur-sm rounded-lg w-12 h-12 flex flex-col items-center justify-center">
                                <span class="text-white font-bold text-lg hours">00</span>
                                <span class="text-white/80 text-xs">小时</span>
                            </div>
                            <div
                                class="bg-white/20 backdrop-blur-sm rounded-lg w-12 h-12 flex flex-col items-center justify-center">
                                <span class="text-white font-bold text-lg minutes">00</span>
                                <span class="text-white/80 text-xs">分钟</span>
                            </div>
                            <div
                                class="bg-white/20 backdrop-blur-sm rounded-lg w-12 h-12 flex flex-col items-center justify-center">
                                <span class="text-white font-bold text-lg seconds">00</span>
                                <span class="text-white/80 text-xs">秒</span>
                            </div>
                        </div>
                        <a href="{% url 'mall:flash_sale' %}"
                            class="bg-white text-primary font-medium py-2 px-6 rounded-lg btn-hover scale-hover inline-flex items-center w-fit">
                            <span>立即抢购</span>
                            <i class="fa fa-arrow-right ml-2"></i>
                        </a>
                        {% else %}
                        <a href="{% url 'mall:new_products' %}"
                            class="bg-white text-primary font-medium py-2 px-6 rounded-lg btn-hover scale-hover inline-flex items-center w-fit">
                            <span>查看新品</span>
                            <i class="fa fa-arrow-right ml-2"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- 猜你喜欢区域 -->
        <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-neutral-800">猜你喜欢</h2>
                <a href="#" id="refreshRecommended" class="text-primary font-medium hover:underline flex items-center">
                    换一批 <i class="fa-solid fa-refresh ml-1"></i>
                </a>
            </div>


            <div id="recommendedProductsGrid"
                class="grid grid-cols-1 sm:grid-cols-2     md:grid-cols-3 lg:grid-cols-5 gap-5">
                {% for product in recommended_products %}
                <a href="{% url 'mall:product_detail' product.id %}"
                    class="bg-white rounded-xl overflow-hidden shadow-sm product-card" data-id="{{ product.id }}">
                    <div class="relative">
                        {% if product.main_image %}
                        <img src="{{ product.main_image.url }}" alt="{{ product.name }}"
                            class="w-full h-48 object-cover">
                        {% else %}
                        <img src="https://picsum.photos/id/1011/300/300" alt="{{ product.name }}"
                            class="w-full h-48 object-cover">
                        {% endif %}
                        {% if product.id in user_marks %}
                        <button
                            class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-primary transition-custom add-to-favorite">
                            <i class="fa-solid fa-heart"></i>
                        </button>
                        {% else %}
                        <button
                            class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-neutral-500 hover:text-primary transition-custom add-to-favorite">
                            <i class="fa-regular fa-heart"></i>
                        </button>
                        {% endif %}
                        {% if product.is_new %}
                        <div class="absolute top-2 left-2 bg-secondary text-white text-xs px-2 py-1 rounded">新品
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-3">
                        <h3 class="font-medium text-neutral-800 text-sm line-clamp-2">{{ product.name }}</h3>
                        <div class="mt-2 flex items-center justify-between">
                            <span class="text-primary font-bold">¥{{ product.price }}</span>
                            <div class="flex items-center text-yellow-400 text-xs">
                                <i class="fa-solid fa-star"></i>
                                <span class="text-neutral-500 ml-1">{{ product.rating }}</span>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>

        </div>

        <!-- 商品展示区域 -->
        <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-neutral-800">精选商品</h2>
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <button id="categoryDropdownButton"
                            class="flex items-center justify-between pl-4 pr-10 py-2 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm bg-white hover:shadow-sm transition-all duration-200 cursor-pointer">
                            <span>全部类别</span>
                            <i
                                class="fa-solid fa-chevron-down text-neutral-400 ml-2 transition-transform duration-200"></i>
                        </button>
                        <div id="categoryDropdown"
                            class="absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-30 opacity-0 invisible transform -translate-y-2 transition-all duration-200 pointer-events-none">
                            <a href="#"
                                class="block px-4 py-2 text-neutral-700 hover:bg-primary/5 hover:text-primary transition-colors duration-200 flex items-center">
                                <i class="fa-solid fa-tag mr-2 w-5 text-center"></i>全部类别
                            </a>
                            <a href="#"
                                class="block px-4 py-2 text-neutral-700 hover:bg-primary/5 hover:text-primary transition-colors duration-200 flex items-center">
                                <i class="fa-solid fa-tshirt mr-2 w-5 text-center"></i>服装
                            </a>
                            <a href="#"
                                class="block px-4 py-2 text-neutral-700 hover:bg-primary/5 hover:text-primary transition-colors duration-200 flex items-center">
                                <i class="fa-solid fa-ring mr-2 w-5 text-center"></i>首饰
                            </a>
                            <a href="#"
                                class="block px-4 py-2 text-neutral-700 hover:bg-primary/5 hover:text-primary transition-colors duration-200 flex items-center">
                                <i class="fa-solid fa-couch mr-2 w-5 text-center"></i>家居
                            </a>
                            <a href="#"
                                class="block px-4 py-2 text-neutral-700 hover:bg-primary/5 hover:text-primary transition-colors duration-200 flex items-center">
                                <i class="fa-solid fa-mobile-screen-button mr-2 w-5 text-center"></i>数码
                            </a>
                        </div>
                    </div>

                    <a href="#" class="text-primary font-medium hover:underline flex items-center">
                        查看更多 <i class="fa-solid fa-angle-right ml-1"></i>
                    </a>
                </div>
            </div>

            <!-- 商品展示-->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

                {% for product in hot_products %}
                <a href="{% url 'mall:product_detail' product.id %}" class="block">
                    <div class="bg-white rounded-xl overflow-hidden shadow-sm product-card" data-id="{{ product.id }}">
                        <div class="relative">
                            {% if product.main_image %}
                            <img src="{{ product.main_image }}" alt="{{ product.name }}"
                                class="w-full h-64 object-cover">
                            {% else %}
                            <img src="https://picsum.photos/id/1011/300/300" alt="{{ product.name }}"
                                class="w-full h-64 object-cover">
                            {% endif %}
                            {% if product.is_new %}
                            <div class="absolute top-3 left-3 bg-secondary text-white text-xs px-2 py-1 rounded">新品
                            </div>
                            {% endif %}
                            {% if product.id in user_marks %}
                            <button
                                class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center text-primary transition-custom add-to-favorite">
                                <i class="fa-solid fa-heart"></i>
                            </button>
                            {% else %}
                            <button
                                class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center text-neutral-500 hover:text-primary transition-custom add-to-favorite">
                                <i class="fa-regular fa-heart"></i>
                            </button>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h3 class="font-medium text-neutral-800 line-clamp-1">{{ product.name }}</h3>
                            <div class="flex items-center mt-1">
                                <div class="flex items-center text-yellow-400 text-xs">
                                    {% with full_stars=product.rating|floatformat:0|add:0 %}
                                    {% with ''|center:full_stars|make_list as range %}
                                    {% for _ in range %}
                                    <i class="fa-solid fa-star"></i>
                                    {% endfor %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% if product.rating|floatformat:1|slice:"-2:" == ".5" %}
                                    <i class="fa-solid fa-star-half-stroke"></i>
                                    {% endif %}
                                    <span class="text-neutral-500 ml-1">{{ product.rating|floatformat:1 }}</span>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center justify-between">
                                <div>
                                    <span class="text-primary font-bold">¥{{ product.price }}</span>
                                    <span class="text-neutral-400 text-sm line-through ml-1">¥{{ product.old_price }}</span>
                                </div>
                                <button
                                    class="w-8 h-8 rounded-full bg-primary/10 text-primary flex items-center justify-center hover:bg-primary hover:text-white transition-custom add-to-cart"
                                    data-id="{{ product.id }}">
                                    <i class="fa-solid fa-shopping-cart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 品牌故事 -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-12">
        <div class="grid md:grid-cols-2 gap-0">
            <div class="relative h-[400px]">
                <img src="https://wendaoshuishou.oss-cn-chengdu.aliyuncs.com/mall_images/active/brand_story_img.jpg"
                    alt="品牌故事" class="w-full h-full object-cover">
            </div>
            <div class="p-8 md:p-12 flex flex-col justify-center">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 text-neutral-800">我们的品牌故事</h2>
                <p class="text-neutral-600 mb-6 leading-relaxed">
                    LoveSync 诞生于一个关于爱情的简单理念：每对情侣都有独特的故事值得被纪念。我们致力于设计和提供高品质的情侣商品，帮助恋人们表达爱意，创造共同的美好回忆。
                </p>
                <p class="text-neutral-600 mb-8 leading-relaxed">
                    从情侣装到家居用品，从日常用品到纪念日礼物，我们的每一件产品都凝聚着对爱情的理解和祝福。希望通过 LoveSync，让每一对恋人都能找到属于他们的爱情表达方式。
                </p>
                <a href="#" class="inline-flex items-center text-primary font-medium hover:underline">
                    了解更多 <i class="fa-solid fa-arrow-right ml-2"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- 服务保障 -->
    <div class="bg-white rounded-2xl shadow-sm p-8 mb-12">
        <h2 class="text-2xl font-bold text-neutral-800 mb-8 text-center">我们的服务保障</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-4">
                    <i class="fa-solid fa-shield-halved   text-2xl"></i>
                </div>
                <h3 class="font-medium text-neutral-800 mb-2">品质保证</h3>
                <p class="text-neutral-600 text-sm">所有商品均经过严格质检，确保品质优良</p>
            </div>

            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-4">
                    <i class="fa-solid fa-truck-fast text-2xl"></i>
                </div>
                <h3 class="font-medium text-neutral-800 mb-2">快速配送</h3>
                <p class="text-neutral-600 text-sm">全国大部分地区48小时内送达</p>
            </div>

            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-4">
                    <i class="fa-solid fa-rotate-left text-2xl"></i>
                </div>
                <h3 class="font-medium text-neutral-800 mb-2">七天无理由退换</h3>
                <p class="text-neutral-600 text-sm">收货后七天内可无理由退换货</p>
            </div>

            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary mb-4">
                    <i class="fa-solid fa-headphones text-2xl"></i>
                </div>
                <h3 class="font-medium text-neutral-800 mb-2">24小时客服</h3>
                <p class="text-neutral-600 text-sm">专业客服团队随时为您解答疑问</p>
            </div>
        </div>
    </div>

</main>

<!-- 回到顶部按钮 -->
<button id="backToTop"
    class="fixed bottom-6 right-6 w-12 h-12 rounded-full bg-gradient-love text-white flex items-center justify-center shadow-lg opacity-0 invisible transition-all duration-300 hover:opacity-90 z-50">
    <i class="fa-solid fa-arrow-up"></i>
</button>

<script>
    // 回到顶部按钮逻辑
    const backToTopBtn = document.getElementById('backToTop');

    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.remove('opacity-0', 'invisible');
            backToTopBtn.classList.add('opacity-100', 'visible');
        } else {
            backToTopBtn.classList.remove('opacity-100', 'visible');
            backToTopBtn.classList.add('opacity-0', 'invisible');
        }
    });

    backToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // 购物车和收藏功能
    let cart = [];
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

    // 更新购物车数量显示
    function updateCartCount() {
        const cartCountElements = document.querySelectorAll('.fa-shopping-cart + span span');
        cartCountElements.forEach(el => {
            el.textContent = cart.reduce((total, item) => total + item.quantity, 0);
        });
    }

    // 更新收藏数量显示
    function updateFavoritesCount() {
        const favoritesCountElements = document.querySelectorAll('.fa-heart + span span');
        favoritesCountElements.forEach(el => {
            el.textContent = favorites.length;
        });
    }

    // 获取CSRF令牌
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 添加商品到购物车
    function addToCart(productId, quantity = 1) {
        fetch("{% url 'mall:add_to_cart' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `product_id=${productId}&quantity=${quantity}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    console.error('添加商品到购物车失败：', data.message);
                }
            });
    }

    // 更新购物车商品数量
    // 更新导航栏购物车图标数量
    // 初始化购物车数据
    let cartItems = [];
    async function fetchCartData() {
        try {
            // 从页面中获取数据
            const cartDataElement = document.getElementById('cart-data');
            if (cartDataElement) {
                try {
                    const cartData = JSON.parse(cartDataElement.textContent);
                    // 转换数据格式以匹配前端需要
                    cartItems = Object.keys(cartData).map(productId => ({
                        id: productId,
                        name: cartData[productId].name,
                        price: parseFloat(cartData[productId].price),
                        quantity: cartData[productId].quantity,
                        image: cartData[productId].image,
                        style: '默认',
                        selected: true
                    }));
                } catch (e) {
                    console.error('解析购物车数据失败:', e);
                    cartItems = [];
                }
            } else {
                // 尝试从localStorage获取备份
                const savedCart = localStorage.getItem('lovesync_cart');
                cartItems = savedCart ? JSON.parse(savedCart) : [];
            }
        } catch (error) {
            console.error('获取购物车数据失败:', error);
            // 网络错误时从localStorage获取
            const savedCart = localStorage.getItem('lovesync_cart');
            cartItems = savedCart ? JSON.parse(savedCart) : [];
        }

        // 更新购物车UI
        updateCartUI();
    }
    const cartCountBadge = document.querySelector('.cart-count');
    if (cartCountBadge) {
        cartCountBadge.textContent = cartItems.length;
    }

    // 从购物车移除商品
    async function removeFromCart(productId) {
        try {
            const response = await fetch('/api/cart/remove/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    product_id: productId
                })
            });

            if (!response.ok) {
                throw new Error('Failed to remove from cart');
            }

            cart = await response.json();
            updateCartCount();
            renderCartItems();
        } catch (error) {
            console.error('Error removing from cart:', error);
        }
    }

    // 渲染购物车页面
    function renderCartItems() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');

        if (!cartItemsContainer) return;

        // 清空现有内容
        cartItemsContainer.innerHTML = '';

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<div class="col-span-full text-center py-12"><i class="fa-regular fa-cart-empty text-5xl text-neutral-300 mb-4"></i><p class="text-neutral-500">购物车是空的</p><a href="/" class="inline-block mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">继续购物</a></div>';
            cartTotalElement.textContent = '¥0.00';
            return;
        }

        let total = 0;

        // 生成购物车项目
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            const itemElement = document.createElement('div');
            itemElement.className = 'flex flex-col md:flex-row items-center py-4 border-b border-neutral-200 last:border-0';
            itemElement.innerHTML = `
            <div class="w-20 h-20 flex-shrink-0 overflow-hidden rounded-lg">
                <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
            </div>
            <div class="flex-1 md:ml-4 mt-3 md:mt-0">
                <h3 class="font-medium text-neutral-900">${item.name}</h3>
                <div class="flex items-center mt-2">
                    <div class="text-primary font-bold">¥${item.price.toFixed(2)}</div>
                    <div class="mx-2 text-neutral-400">x</div>
                    <div class="flex items-center border rounded-full px-2 py-1">
                        <button onclick="updateCartItemQuantity('${item.id}', ${item.quantity - 1})" class="w-6 h-6 flex items-center justify-center text-neutral-500 hover:text-primary">
                            <i class="fa-solid fa-minus"></i>
                        </button>
                        <span class="mx-2">${item.quantity}</span>
                        <button onclick="updateCartItemQuantity('${item.id}', ${item.quantity + 1})" class="w-6 h-6 flex items-center justify-center text-neutral-500 hover:text-primary">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <div class="ml-auto font-bold text-primary">¥${itemTotal.toFixed(2)}</div>
                    <button onclick="removeFromCart('${item.id}')" class="ml-4 text-neutral-400 hover:text-red-500">
                        <i class="fa-regular fa-trash-can"></i>
                    </button>
                </div>
            </div>
        `;

            cartItemsContainer.appendChild(itemElement);
        });

        // 更新总计
        cartTotalElement.textContent = `¥${total.toFixed(2)}`;
    }

    // 收藏商品功能
    async function toggleFavorite(productId) {
        try {
            const csrfToken = getCSRFToken();

            const response = await fetch('{% url "mall:add_mark" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId
                })
            });

            if (!response.ok) {
                throw new Error('操作失败');
            }

            const data = await response.json();

            // 调用更新收藏数量的函数
            if (typeof updateCartAndMarkCounts === 'function') {
                updateCartAndMarkCounts();
            }

            return true;
        } catch (error) {
            console.error('收藏操作失败:', error);
            showToast('操作失败', '收藏操作失败，请稍后重试', false);
            return false;
        }
    }

    // 取消收藏商品功能
    async function removeFavorite(productId) {
        try {
            const csrfToken = getCSRFToken();

            const response = await fetch('{% url "mall:remove_mark" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId
                })
            });

            if (!response.ok) {
                throw new Error('操作失败');
            }

            const data = await response.json();

            // 调用更新收藏数量的函数
            if (typeof updateCartAndMarkCounts === 'function') {
                updateCartAndMarkCounts();
            }

            return true;
        } catch (error) {
            console.error('取消收藏操作失败:', error);
            showToast('操作失败', '取消收藏操作失败，请稍后重试', false);
            return false;
        }
    }

    // 获取CSRF令牌（Django需要）
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 初始化事件监听器
    function initEventListeners() {
        // 添加到购物车按钮事件
        document.querySelectorAll('.product-card button:has(.fa-shopping-cart)').forEach(btn => {
            btn.addEventListener('click', function () {
                const productCard = this.closest('.product-card');
                const productId = productCard.dataset.id;

                addToCart(productId, 1);
            });
        });

        // 收藏按钮事件
        document.querySelectorAll('.product-card button:has(.fa-heart)').forEach(btn => {
            btn.addEventListener('click', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                const productCard = this.closest('.product-card');
                const productId = productCard.dataset.id;

                try {
                    // 尝试添加收藏
                    const success = await toggleFavorite(productId);

                    if (success) {
                        // 更新按钮样式为已收藏状态
                        this.innerHTML = '<i class="fa-solid fa-heart text-primary"></i>';
                        showToast('收藏成功', '商品已添加到收藏夹');
                    }
                } catch (error) {
                    console.error('收藏操作失败:', error);
                }
            });
        });

        // 为排行榜和推荐商品的收藏按钮添加事件
        document.querySelectorAll('.add-to-favorite').forEach(btn => {
            btn.addEventListener('click', async function (e) {
                e.preventDefault();
                e.stopPropagation();

                const productCard = this.closest('.product-card');
                const productId = productCard ? productCard.dataset.id : this.getAttribute('data-id');

                if (!productId) {
                    showToast('参数错误', '商品ID无效', false);
                    return;
                }

                try {
                    // 尝试添加收藏
                    const success = await toggleFavorite(productId);

                    if (success) {
                        // 更新按钮样式为已收藏状态
                        this.innerHTML = '<i class="fa-solid fa-heart text-primary"></i>';
                        showToast('收藏成功', '商品已添加到收藏夹');
                    }
                } catch (error) {
                    console.error('收藏操作失败:', error);
                }
            });
        });

        // 排行榜商品添加到购物车
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', function () {
                const productId = this.dataset.id;

                addToCart(productId, 1);
            });
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function () {
        initEventListeners();

        // 调用更新购物车和收藏数量的函数
        if (typeof updateCartAndMarkCounts === 'function') {
            updateCartAndMarkCounts();
        }

        // 如果是购物车页面，获取购物车数据
        if (document.getElementById('cart-items')) {
            fetchCartData();
        } else {
            // 否则从本地存储加载购物车数据
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            updateCartCount();
        }
    });

    // 页面加载完成时将页面滚动到顶部
    window.onload = function () {
        window.scrollTo(0, 0);
    };

    // 图片懒加载实现
    document.addEventListener("DOMContentLoaded", function () {
        const lazyImages = document.querySelectorAll('img');

        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const image = entry.target;
                        image.classList.add("fade-in");
                        imageObserver.unobserve(image);
                    }
                });
            });

            lazyImages.forEach(image => {
                imageObserver.observe(image);
            });
        }
    });

    // 初始化 Swiper
    const swiper = new Swiper('.swiper-container', {
        loop: true,
        autoplay: {
            delay: 2000, // 3秒自动切换一次
            disableOnInteraction: false, // 用户交互后继续自动播放
        },
        pagination: {
            el: '.swiper-pagination',
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
    });

    // 倒计时功能
    function updateCountdown() {
        document.querySelectorAll('.countdown').forEach(countdown => {
            const endTime = new Date(countdown.dataset.endtime).getTime();
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance > 0) {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdown.querySelector('.days').textContent = String(days).padStart(2, '0');
                countdown.querySelector('.hours').textContent = String(hours).padStart(2, '0');
                countdown.querySelector('.minutes').textContent = String(minutes).padStart(2, '0');
                countdown.querySelector('.seconds').textContent = String(seconds).padStart(2, '0');
            } else {
                countdown.innerHTML = '<p class="text-white">活动已结束</p>';
            }
        });
    }

    // 初始化倒计时
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // 猜你喜欢 - 换一批功能
    document.addEventListener('DOMContentLoaded', function () {
        const refreshButton = document.getElementById('refreshRecommended');
        const productsGrid = document.getElementById('recommendedProductsGrid');

        if (refreshButton && productsGrid) {
            refreshButton.addEventListener('click', function (e) {
                e.preventDefault();

                // 显示加载状态
                refreshButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 加载中...';
                refreshButton.style.pointerEvents = 'none';

                // 发送请求获取新的推荐商品
                fetch('/mall/api/recommended/refresh/', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络请求失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // 清空现有商品
                            productsGrid.innerHTML = '';

                            // 添加新商品
                            data.products.forEach(product => {
                                const productCard = document.createElement('a');
                                productCard.href = `/mall/product/${product.id}/`;
                                productCard.className = 'bg-white rounded-xl overflow-hidden shadow-sm product-card';
                                productCard.setAttribute('data-id', product.id);

                                // 构建商品卡片内容
                                let cardContent = `
                                <div class="relative">
                                    <img src="${product.main_image || 'https://picsum.photos/id/1011/300/300'}" alt="${product.name}"
                                        class="w-full h-48 object-cover">
                            `;

                                // 检查是否已收藏
                                if (product.is_marked) {
                                    cardContent += `
                                    <button
                                        class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-primary transition-custom add-to-favorite">
                                        <i class="fa-solid fa-heart"></i>
                                    </button>
                                `;
                                } else {
                                    cardContent += `
                                    <button
                                        class="absolute top-2 right-2 w-8 h-8 rounded-full bg-white/80 flex items-center justify-center text-neutral-500 hover:text-primary transition-custom add-to-favorite">
                                        <i class="fa-regular fa-heart"></i>
                                    </button>
                                `;
                                }

                                // 检查是否是新品
                                if (product.is_new) {
                                    cardContent += `
                                    <div class="absolute top-2 left-2 bg-secondary text-white text-xs px-2 py-1 rounded">新品
                                    </div>
                                `;
                                }

                                cardContent += `
                                </div>
                                <div class="p-3">
                                    <h3 class="font-medium text-neutral-800 text-sm line-clamp-2">${product.name}</h3>
                                    <div class="mt-2 flex items-center justify-between">
                                        <span class="text-primary font-bold">¥${product.price}</span>
                                        <div class="flex items-center text-yellow-400 text-xs">
                                            <i class="fa-solid fa-star"></i>
                                            <span class="text-neutral-500 ml-1">${product.rating}</span>
                                        </div>
                                    </div>
                                </div>
                            `;

                                productCard.innerHTML = cardContent;
                                productsGrid.appendChild(productCard);
                            });

                            // 为新添加的收藏按钮绑定事件
                            document.querySelectorAll('.add-to-favorite').forEach(btn => {
                                btn.addEventListener('click', async function (e) {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    const productCard = this.closest('.product-card');
                                    const productId = productCard ? productCard.dataset.id : this.getAttribute('data-id');

                                    if (!productId) {
                                        showToast('参数错误', '商品ID无效', false);
                                        return;
                                    }

                                    try {
                                        // 尝试添加收藏
                                        const success = await toggleFavorite(productId);

                                        if (success) {
                                            // 更新按钮样式为已收藏状态
                                            this.innerHTML = '<i class="fa-solid fa-heart text-primary"></i>';
                                            showToast('收藏成功', '商品已添加到收藏夹');
                                        }
                                    } catch (error) {
                                        console.error('收藏操作失败:', error);
                                    }
                                });
                            });
                        } else {
                            console.error('获取推荐商品失败:', data.message);
                            showToast('加载失败', '获取推荐商品失败，请重试', false);
                        }
                    })
                    .catch(error => {
                        console.error('错误:', error);
                        showToast('网络错误', '获取推荐商品失败，请检查网络连接', false);
                    })
                    .finally(() => {
                        // 恢复按钮状态
                        refreshButton.innerHTML = '换一批 <i class="fa-solid fa-refresh ml-1"></i>';
                        refreshButton.style.pointerEvents = 'auto';
                    });
            });
        }
    });
</script>
{% endblock %}