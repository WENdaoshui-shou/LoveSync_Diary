{% extends 'base.html' %}

{% block title %}发送私信{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation">
    </div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 页面标题 -->
        <div class="bg-white rounded-xl shadow-lg p-6 hover-scale">
            <div class="flex items-center space-x-3">
                {% if recipient %}
                <a href="{% url 'user:profile' recipient.id %}"
                    class="text-neutral-600 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                {% else %}
                <a href="{% url 'message:list' %}" class="text-neutral-600 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                {% endif %}
                <h2 class="text-2xl font-bold text-neutral-900">发送私信</h2>
            </div>
        </div>

        <!-- 发送私信表单 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <form id="sendPrivateMessageForm" method="post">
                {% csrf_token %}
                <div class="space-y-6">
                    <!-- 接收者选择 -->
                    <div>
                        <label for="recipient" class="block text-sm font-medium text-neutral-700 mb-2">接收者</label>
                        <div class="flex items-center space-x-3">
                            {% if recipient %}
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 rounded-full overflow-hidden">
                                    <img src="{{ recipient.profile.userAvatar.url }}" alt="{{ recipient.name }}"
                                        class="w-full h-full object-cover">
                                </div>
                                <span class="text-neutral-900">{{ recipient.name }}</span>
                            </div>
                            <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                            {% else %}
                            <input type="text" name="recipient_id" id="recipient" placeholder="输入接收者ID"
                                class="flex-1 px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 form-input-focus">
                            {% endif %}
                        </div>
                    </div>

                    <!-- 消息内容 -->
                    <div>
                        <label for="content" class="block text-sm font-medium text-neutral-700 mb-2">消息内容</label>
                        <textarea name="content" id="content" rows="5" placeholder="请输入私信内容..."
                            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 form-input-focus"></textarea>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="flex justify-end">
                        <button type="submit"
                            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors shadow-md hover:shadow-lg">
                            发送私信
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('sendPrivateMessageForm');
        
        // 兼容表单不存在的情况，避免报错
        if (!form) return;

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // 获取表单数据
            const recipientId = form.querySelector('input[name="recipient_id"]').value;
            const content = form.querySelector('textarea[name="content"]').value.trim();

            // 表单验证
            if (!recipientId) {
                showMessage('请输入接收者ID', 'error');
                return;
            }

            if (!content) {
                showMessage('消息内容不能为空', 'error');
                return;
            }

            // 获取CSRF令牌
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // 发送AJAX请求
            fetch("{% url 'message:send_private_message' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'recipient_id': recipientId,
                    'content': content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    form.querySelector('textarea[name="content"]').value = '';
                        setTimeout(() => {
                            window.location.href = "{% url 'message:private_chat_detail' recipient.id %}";
                        }, 1500);
                    
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('发送失败:', error);
                showMessage('发送失败，请重试', 'error');
            });
        });

        // 显示消息提示（修复函数定义位置，避免作用域问题）
        function showMessage(message, type) {
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-20 right-4 px-5 py-4 rounded-xl shadow-lg transform transition-all duration-300 z-50 ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`;
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-lg mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            // 添加到页面
            document.body.appendChild(messageDiv);

            // 3秒后移除
            setTimeout(() => {
                messageDiv.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %}