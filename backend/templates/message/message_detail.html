{% extends 'base.html' %}

{% block title %}消息详情{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation">
    </div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <div class="w-full max-w-4xl mx-auto">
            <!-- 返回按钮 -->
            <div class="mb-6">
                <button onclick="window.location.href='{% url 'message:list' %}'"
                    class="flex items-center text-primary hover:text-primary/80 transition-colors">
                    <i class="fa-solid fa-arrow-left mr-2"></i>
                    返回消息列表
                </button>
            </div>

            <!-- 消息详情卡片 -->
            <div class="bg-white rounded-xl shadow-lg p-6 hover-scale">
                <!-- 消息头部 -->
                <div class="flex items-start mb-4">
                    <div class="w-12 h-12 rounded-full overflow-hidden mr-4 flex-shrink-0">
                        {% if message.type == 'system' %}
                        <img src="https://picsum.photos/200/200?random=100" alt="系统头像"
                            class="w-full h-full object-cover">
                        {% elif message.type == 'private' %}
                        <img src="https://picsum.photos/200/200?random=200" alt="用户头像"
                            class="w-full h-full object-cover">
                        {% else %}
                        <img src="https://picsum.photos/200/200?random=300" alt="业务头像"
                            class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-neutral-900">
                                {{ message.get_type_display }}
                            </h3>
                            <span class="text-neutral-400 text-sm">
                                {{ message.create_time|date:"Y-m-d H:i:s" }}
                            </span>
                        </div>
                        <div class="mt-1">
                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">
                                {{ message.get_type_display }}
                            </span>
                            {% if not message.is_read %}
                            <span class="ml-2 bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">
                                未读
                            </span>
                            {% else %}
                            <span class="ml-2 bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">
                                已读
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 消息内容 -->
                <div class="bg-neutral-50 p-6 rounded-lg mb-6">
                    <p class="text-neutral-800 leading-relaxed whitespace-pre-wrap">
                        {{ message.content }}
                    </p>
                </div>

                <!-- 关联链接 -->
                {% if message.related_url %}
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-neutral-700 mb-2">相关链接</h4>
                    <a href="{{ message.related_url }}" target="_blank"
                        class="inline-flex items-center text-primary hover:text-primary/80 transition-colors">
                        <span>{{ message.related_url|truncatechars:50 }}</span>
                        <i class="fa-solid fa-external-link ml-1"></i>
                    </a>
                </div>
                {% endif %}

                <!-- 操作按钮 -->
                <div class="flex flex-wrap gap-3">
                    <button onclick="markAsRead({{ message.id }})"
                        class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center">
                        <i class="fa-solid fa-check mr-2"></i>
                        标为已读
                    </button>

                    <button onclick="deleteMessage({{ message.id }})"
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center">
                        <i class="fa-solid fa-trash mr-2"></i>
                        删除消息
                    </button>

                    {% if message.type == 'private' %}
                    <button onclick="replyMessage({{ message.id }})"
                        class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors flex items-center">
                        <i class="fa-solid fa-reply mr-2"></i>
                        回复消息
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- 回复表单（针对私信） -->
            {% if message.type == 'private' %}
            <div class="mt-6 bg-white rounded-xl shadow-lg p-6 hover-scale">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4">回复消息</h3>
                <form id="replyForm" method="post" action="#">
                    {% csrf_token %}
                    <div class="mb-4">
                        <textarea name="content" rows="4" placeholder="请输入回复内容..."
                            class="w-full px-4 py-3 rounded-lg border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-colors"></textarea>
                    </div>
                    <button type="submit"
                        class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium">
                        发送回复
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // 标为已读
    function markAsRead(messageId) {
        fetch('{% url 'message: update_status' %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'message_ids[]': messageId,
                'action': 'read'
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新页面状态
                    window.location.reload();
                } else {
                    alert('操作失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
    }

    // 删除消息
    function deleteMessage(messageId) {
        if (confirm('确定要删除这条消息吗？')) {
            fetch('{% url 'message: update_status' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'message_ids[]': messageId,
                    'action': 'delete'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 跳转到消息列表
                        window.location.href = '{% url 'message:list' %}';
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
        }
    }

    // 回复消息
    function replyMessage(messageId) {
        // 滚动到回复表单
        document.getElementById('replyForm').scrollIntoView({ behavior: 'smooth' });
        document.querySelector('textarea[name="content"]').focus();
    }

    // 回复表单提交
    document.addEventListener('DOMContentLoaded', function () {
        const replyForm = document.getElementById('replyForm');
        if (replyForm) {
            replyForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // 这里可以添加回复逻辑
                const content = document.querySelector('textarea[name="content"]').value.trim();
                if (!content) {
                    alert('回复内容不能为空');
                    return;
                }

                // 模拟提交
                alert('回复功能开发中，敬请期待');
                replyForm.reset();
            });
        }
    });
</script>
{% endblock %}