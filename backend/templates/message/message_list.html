{% extends 'base.html' %}

{% block title %}消息中心{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation"></div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 消息列表核心区域 -->
        <div class="w-full space-y-6">
            <!-- 核心标签栏 -->
            <div class="bg-white rounded-xl shadow-lg p-4">
                <div class="flex flex-wrap justify-between items-center gap-3">
                    <div class="flex flex-wrap gap-3">
                        <!-- 所有消息标签 -->
                        <button id="btn-all"
                            class="px-4 py-2 rounded-full {% if not request.GET.filter or request.GET.filter != 'unread' and request.GET.filter != 'system' %}bg-primary text-white{% else %}bg-neutral-100 text-neutral-700 hover:bg-neutral-200{% endif %} text-sm font-medium transition-colors">
                            所有消息 <span class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">{{ total_message_count|default:0 }}</span>
                        </button>
                        <!-- 未读消息标签 -->
                        <button id="btn-unread"
                            class="px-4 py-2 rounded-full {% if request.GET.filter == 'unread' %}bg-primary text-white{% else %}bg-neutral-100 text-neutral-700 hover:bg-neutral-200{% endif %} text-sm font-medium transition-colors">
                            未读消息 <span class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">{{ unread_count|default:0 }}</span>
                        </button>
                        <!-- 系统通知标签 -->
                        <button id="btn-system"
                            class="px-4 py-2 rounded-full {% if request.GET.filter == 'system' %}bg-primary text-white{% else %}bg-neutral-100 text-neutral-700 hover:bg-neutral-200{% endif %} text-sm font-medium transition-colors">
                            系统通知 <span class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">{{ system_count|default:0 }}</span>
                        </button>
                    </div>
                    <!-- 全部已读按钮 -->
                    <button id="btn-mark-all-read"
                        class="px-4 py-2 rounded-full bg-gradient-to-r from-primary to-secondary text-white hover:opacity-90 text-sm font-medium transition-all transform hover:scale-105 shadow-md hover:shadow-lg">
                        <i class="fa-solid fa-check-circle mr-1"></i> 全部已读
                    </button>
                </div>
            </div>

            <!-- 消息内容区域 -->
            <div class="space-y-4">
                <!-- 所有消息面板 -->
                <div id="panel-all" class="bg-white rounded-xl shadow-lg overflow-hidden {% if request.GET.filter == 'unread' or request.GET.filter == 'system' %}hidden{% endif %}">
                    <div class="message-content" data-type="all">
                        {% if grouped_messages %}
                            {% for group_key, msg in grouped_messages.items %}
                            <div class="p-4 border-b border-neutral-100 cursor-pointer transition-all duration-200 hover:bg-neutral-50 hover:translate-x-1 {% if not msg.is_read %}border-l-3 border-primary{% else %}border-l-3 border-transparent{% endif %}"onclick="window.location.href='{% if msg.type == 'private' and msg.private_chat and msg.private_chat.sender %}{% url 'message:private_chat_detail' msg.private_chat.sender.id %}{% else %}{% url 'message:detail' msg.id %}{% endif %}'">
                                <div class="flex">
                                    <!-- 消息图标/头像 -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-4 flex-shrink-0">
                                        {% if msg.type == 'system' %}
                                        <div class="w-full h-full bg-primary/10 rounded-full flex items-center justify-center text-primary">
                                            <i class="fa-solid fa-bell"></i>
                                        </div>
                                        {% elif msg.type == 'private' %}
                                            {% if msg.private_chat and msg.private_chat.sender and msg.private_chat.sender.profile and msg.private_chat.sender.profile.userAvatar %}
                                            <img src="{{ msg.private_chat.sender.profile.userAvatar.url }}" alt="{{ msg.private_chat.sender.name|default:'未知用户' }}"
                                                class="w-full h-full object-cover rounded-full"
                                                onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500\'><i class=\'fa-solid fa-user\'></i></div>'">
                                            {% else %}
                                            <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                <i class="fa-solid fa-user"></i>
                                            </div>
                                            {% endif %}
                                        {% else %}
                                        <div class="w-full h-full bg-secondary/10 rounded-full flex items-center justify-center text-secondary">
                                            <i class="fa-solid fa-briefcase"></i>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <!-- 消息内容 -->
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-neutral-900">
                                                {% if msg.type == 'system' %}系统通知{% elif msg.type == 'private' and msg.private_chat and msg.private_chat.sender %}{{ msg.private_chat.sender.name|default:'未知用户' }}{% else %}业务提醒{% endif %}
                                            </h4>
                                            <span class="text-neutral-400 text-xs">{{ msg.create_time|date:"Y-m-d H:i"|default:"未知时间" }}</span>
                                        </div>
                                        <p class="text-neutral-700 mt-1 line-clamp-2">{{ msg.content|default:"无内容" }}</p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">{{ msg.get_type_display|default:"未知类型" }}</span>
                                            {% if not msg.is_read %}
                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">未读</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <!-- 加载更多 -->
                            <div id="loading-all" class="p-4 text-center hidden">
                                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-primary border-t-transparent"></div>
                                <p class="mt-2 text-neutral-500 text-sm">加载更多...</p>
                            </div>
                            <div id="no-more-all" class="p-4 text-center hidden">
                                <p class="text-neutral-500 text-sm">已加载全部消息</p>
                            </div>
                        {% else %}
                        <!-- 空状态 -->
                        <div class="p-12 text-center">
                            <i class="fa-solid fa-envelope-open text-5xl text-neutral-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-neutral-900 mb-2">暂无消息</h3>
                            <p class="text-neutral-500">您还没有收到任何消息</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 未读消息面板 -->
                <div id="panel-unread" class="bg-white rounded-xl shadow-lg overflow-hidden {% if request.GET.filter != 'unread' %}hidden{% endif %}">
                    <div class="message-content" data-type="unread">
                        {% if unread_messages %}
                            {% for msg in unread_messages %}
                            <div class="p-4 border-b border-neutral-100 cursor-pointer transition-all duration-200 hover:bg-neutral-50 hover:translate-x-1 border-l-3 border-primary"onclick='window.location.href="{% if msg.type == 'private' and msg.private_chat and msg.private_chat.sender %}{% url 'message:private_chat_detail' msg.private_chat.sender.id %}{% else %}{% url 'message:detail' msg.id %}{% endif %}"'>
                                <div class="flex">
                                    <!-- 消息图标/头像 -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-4 flex-shrink-0">
                                        {% if msg.type == 'system' %}
                                            <div class="w-full h-full bg-primary/10 rounded-full flex items-center justify-center text-primary">
                                                <i class="fa-solid fa-bell"></i>
                                            </div>
                                        {% elif msg.type == 'private' %}
                                            {% if msg.private_chat and msg.private_chat.sender and msg.private_chat.sender.profile and msg.private_chat.sender.profile.userAvatar %}
                                                <img 
                                                    src="{{ msg.private_chat.sender.profile.userAvatar.url }}" 
                                                    alt="{{ msg.private_chat.sender.name|default:'未知用户' }}"
                                                    class="w-full h-full object-cover rounded-full"
                                                    onerror='this.onerror=null; this.parentElement.innerHTML="<div class=\"w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500\"><i class=\"fa-solid fa-user\"></i></div>"'>
                                            {% else %}
                                                <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                    <i class="fa-solid fa-user"></i>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <div class="w-full h-full bg-secondary/10 rounded-full flex items-center justify-center text-secondary">
                                                <i class="fa-solid fa-briefcase"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <!-- 消息内容 -->
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-neutral-900">
                                                {% if msg.type == 'system' %}
                                                    系统通知
                                                {% elif msg.type == 'private' and msg.private_chat and msg.private_chat.sender %}
                                                    {{ msg.private_chat.sender.name|default:'未知用户' }}
                                                {% else %}
                                                    业务提醒
                                                {% endif %}
                                            </h4>
                                            <span class="text-neutral-400 text-xs">{{ msg.create_time|date:"Y-m-d H:i"|default:"未知时间" }}</span>
                                        </div>
                                        <p class="text-neutral-700 mt-1 line-clamp-2">{{ msg.content|default:"无内容" }}</p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">{{ msg.get_type_display|default:"未知类型" }}</span>
                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">未读</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <!-- 加载更多 -->
                            <div id="loading-unread" class="p-4 text-center hidden">
                                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-primary border-t-transparent"></div>
                                <p class="mt-2 text-neutral-500 text-sm">加载更多...</p>
                            </div>
                            <div id="no-more-unread" class="p-4 text-center hidden">
                                <p class="text-neutral-500 text-sm">已加载全部未读消息</p>
                            </div>
                        {% else %}
                        <!-- 空状态 -->
                        <div class="p-12 text-center">
                            <i class="fa-solid fa-envelope-open text-5xl text-neutral-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-neutral-900 mb-2">暂无未读消息</h3>
                            <p class="text-neutral-500">您已阅读所有消息</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 系统通知面板 -->
                <div id="panel-system" class="bg-white rounded-xl shadow-lg overflow-hidden {% if request.GET.filter != 'system' %}hidden{% endif %}">
                    <div class="message-content" data-type="system">
                        {% if system_messages %}
                            {% for msg in system_messages %}
                            <div class="p-4 border-b border-neutral-100 cursor-pointer transition-all duration-200 hover:bg-neutral-50 hover:translate-x-1 {% if not msg.is_read %}border-l-3 border-primary{% else %}border-l-3 border-transparent{% endif %}"onclick="window.location.href='{% url 'message:detail' msg.id %}'">
                                <div class="flex">
                                    <!-- 系统通知图标 -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-4 flex-shrink-0">
                                        <div class="w-full h-full bg-primary/10 rounded-full flex items-center justify-center text-primary">
                                            <i class="fa-solid fa-bell"></i>
                                        </div>
                                    </div>
                                    <!-- 消息内容 -->
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-neutral-900">系统通知</h4>
                                            <span class="text-neutral-400 text-xs">{{ msg.create_time|date:"Y-m-d H:i"|default:"未知时间" }}</span>
                                        </div>
                                        <p class="text-neutral-700 mt-1 line-clamp-2">{{ msg.content|default:"无内容" }}</p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">{{ msg.get_type_display|default:"系统通知" }}</span>
                                            {% if not msg.is_read %}
                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">未读</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <!-- 加载更多 -->
                            <div id="loading-system" class="p-4 text-center hidden">
                                <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-primary border-t-transparent"></div>
                                <p class="mt-2 text-neutral-500 text-sm">加载更多...</p>
                            </div>
                            <div id="no-more-system" class="p-4 text-center hidden">
                                <p class="text-neutral-500 text-sm">已加载全部系统通知</p>
                            </div>
                        {% else %}
                        <!-- 空状态 -->
                        <div class="p-12 text-center">
                            <i class="fa-solid fa-bell-slash text-5xl text-neutral-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-neutral-900 mb-2">暂无系统通知</h3>
                            <p class="text-neutral-500">系统通知将显示在这里</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 核心元素获取
        const btnAll = document.getElementById('btn-all');
        const btnUnread = document.getElementById('btn-unread');
        const btnSystem = document.getElementById('btn-system');
        const panelAll = document.getElementById('panel-all');
        const panelUnread = document.getElementById('panel-unread');
        const panelSystem = document.getElementById('panel-system');
        const btnMarkAllRead = document.getElementById('btn-mark-all-read');

        // 滚动状态管理（仅保留三类）
        const scrollStates = {
            all: { isLoading: false, hasMore: true, page: 1 },
            unread: { isLoading: false, hasMore: true, page: 1 },
            system: { isLoading: false, hasMore: true, page: 1 }
        };

        // 获取当前激活的面板类型
        function getActiveType() {
            if (!panelUnread.classList.contains('hidden')) return 'unread';
            if (!panelSystem.classList.contains('hidden')) return 'system';
            return 'all';
        }

        // 标签切换通用方法
        function switchTab(activeBtn, inactiveBtn1, inactiveBtn2, activePanel, inactivePanel1, inactivePanel2, filter) {
            // 更新按钮样式
            activeBtn.classList.remove('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
            activeBtn.classList.add('bg-primary', 'text-white');
            [inactiveBtn1, inactiveBtn2].forEach(btn => {
                btn?.classList.remove('bg-primary', 'text-white');
                btn?.classList.add('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
            });
            // 更新面板显示
            activePanel.classList.remove('hidden');
            [inactivePanel1, inactivePanel2].forEach(panel => panel.classList.add('hidden'));
            // 更新URL参数
            const url = new URL(window.location);
            if (filter) url.searchParams.set('filter', filter);
            else url.searchParams.delete('filter');
            window.history.replaceState({}, document.title, url);
            // 绑定消息项点击事件
            bindMessageClick();
        }

        // 绑定消息项点击动效
        function bindMessageClick() {
            document.querySelectorAll('[onclick^="window.location.href"]').forEach(item => {
                if (!item.hasAttribute('data-bound')) {
                    item.setAttribute('data-bound', 'true');
                    item.addEventListener('click', function () {
                        this.classList.add('opacity-70');
                        setTimeout(() => this.classList.remove('opacity-70'), 200);
                    });
                }
            });
        }

        // 初始绑定
        bindMessageClick();

        // 切换到所有消息
        btnAll?.addEventListener('click', () => {
            switchTab(btnAll, btnUnread, btnSystem, panelAll, panelUnread, panelSystem, '');
        });

        // 切换到未读消息
        btnUnread?.addEventListener('click', () => {
            switchTab(btnUnread, btnAll, btnSystem, panelUnread, panelAll, panelSystem, 'unread');
        });

        // 切换到系统通知
        btnSystem?.addEventListener('click', () => {
            switchTab(btnSystem, btnAll, btnUnread, panelSystem, panelAll, panelUnread, 'system');
        });

        // 标记全部已读
        btnMarkAllRead?.addEventListener('click', function () {
            // 禁用按钮
            btnMarkAllRead.disabled = true;
            btnMarkAllRead.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> 处理中...';

            fetch('/message/mark-all-read/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: ''
            }).then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP错误：${res.status}`);
                }
                return res.json();
            }).then(data => {
                if (data.success) {
                    window.location.reload();
                }
            }).catch(err => {
                console.error('标记已读失败:', err);
                btnMarkAllRead.disabled = false;
                btnMarkAllRead.innerHTML = '<i class="fa-solid fa-check-circle mr-1"></i> 全部已读';
            });
        });

        // 加载更多消息
        function loadMore(type) {
            const state = scrollStates[type];
            const loadingEl = document.getElementById(`loading-${type}`);
            const noMoreEl = document.getElementById(`no-more-${type}`);
            const contentEl = document.querySelector(`.message-content[data-type="${type}"]`);

            if (!contentEl || !loadingEl || !noMoreEl || state.isLoading || !state.hasMore) return;

            state.isLoading = true;
            loadingEl.classList.remove('hidden');

            const filter = type === 'all' ? '' : `&filter=${type}`;
            const url = `/message/list/?page=${state.page + 1}${filter}`;

            fetch(url)
                .then(res => {
                    if (!res.ok) throw new Error('加载失败');
                    return res.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newItems = doc.querySelector(`.message-content[data-type="${type}"]`)?.querySelectorAll('[onclick^="window.location.href"]');
                    
                    if (newItems && newItems.length > 0) {
                        newItems.forEach(item => contentEl.insertBefore(item, loadingEl));
                        bindMessageClick();
                        state.page++;
                    } else {
                        state.hasMore = false;
                        loadingEl.classList.add('hidden');
                        noMoreEl.classList.remove('hidden');
                    }
                })
                .catch(err => {
                    console.error(`加载${type}消息失败:`, err);
                })
                .finally(() => {
                    state.isLoading = false;
                    loadingEl.classList.add('hidden');
                });
        }

        // 滚动加载（防抖）
        window.addEventListener('scroll', function () {
            if (this.scrollTimer) clearTimeout(this.scrollTimer);
            this.scrollTimer = setTimeout(() => {
                const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
                const clientHeight = document.documentElement.clientHeight || window.innerHeight;
                
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    loadMore(getActiveType());
                }
            }, 100);
        });

        // 工具函数 - 获取CSRF Token
        function getCookie(name) {
            let value = null;
            if (document.cookie) {
                document.cookie.split(';').forEach(cookie => {
                    const [k, v] = cookie.trim().split('=');
                    if (k === name) value = decodeURIComponent(v);
                });
            }
            return value;
        }
    });
</script>
{% endblock %}