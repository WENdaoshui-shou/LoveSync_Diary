{% extends 'base.html' %}

{% block title %}消息中心{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation"></div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 左侧消息列表 -->
        <div class="w-full space-y-6">
            <!-- 核心功能标签（消息列表 + 未读消息） -->
            <div class="bg-white rounded-xl shadow-lg p-4 flex flex-wrap gap-3">
                <button id="btn-message-list"
                    class="px-4 py-2 rounded-full {% if not request.GET.filter or request.GET.filter != 'unread' %}bg-primary text-white{% else %}bg-neutral-100 text-neutral-700 hover:bg-neutral-200{% endif %} text-sm font-medium transition-colors">
                    所有消息 <span class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">{{ total_message_count|default:0 }}</span>
                </button>

                <button id="btn-unread-messages"
                    class="px-4 py-2 rounded-full {% if request.GET.filter == 'unread' %}bg-primary text-white{% else %}bg-neutral-100 text-neutral-700 hover:bg-neutral-200{% endif %} text-sm font-medium transition-colors">
                    未读消息 <span class="ml-1 bg-primary text-white text-xs px-2 py-0.5 rounded-full">{{ unread_count|default:0 }}</span>
                </button>
            </div>

            <!-- 标签内容区域 -->
            <div class="space-y-4">
                <!-- 所有消息列表（同一用户仅显示最新一条，按时间倒序） -->
                <div id="tab-message-list"
                    class="bg-white rounded-xl shadow-lg overflow-hidden {% if request.GET.filter == 'unread' %}hidden{% endif %}">
                    <!-- 加载状态 -->
                    <div class="loading-state p-12 text-center hidden">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
                        <p class="mt-4 text-neutral-600">加载中...</p>
                    </div>

                    <!-- 错误状态 -->
                    <div class="error-state p-12 text-center hidden">
                        <i class="fa-solid fa-exclamation-circle text-5xl text-red-400 mb-4"></i>
                        <h3 class="text-xl font-semibold text-neutral-900 mb-2">加载失败</h3>
                        <p class="text-neutral-500 mb-4">无法加载消息列表，请稍后重试</p>
                        <button class="retry-btn px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                            重新加载
                        </button>
                    </div>

                    <!-- 所有消息列表内容 -->
                    <div class="message-list-content">
                        {% if grouped_messages %}
                            {% for group_key, latest_message in grouped_messages.items %}
                            <div class="p-4 border-b border-neutral-100 cursor-pointer transition-all duration-200 hover:bg-neutral-50 hover:translate-x-1 {% if not latest_message.is_read %}border-l-3 border-primary{% else %}border-l-3 border-transparent{% endif %}"
                                onclick="window.location.href='{% if latest_message.type == 'private' and latest_message.private_chat and latest_message.private_chat.sender %}{% url 'message:private_chat_detail' latest_message.private_chat.sender.id %}{% else %}{% url 'message:detail' latest_message.id %}{% endif %}'">
                                <div class="flex">
                                    <!-- 消息类型图标/私信发送者头像 -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-4 flex-shrink-0">
                                        {% if latest_message.type == 'system' %}
                                            <div class="w-full h-full bg-primary/10 rounded-full flex items-center justify-center text-primary">
                                                <i class="fa-solid fa-bell"></i>
                                            </div>
                                        {% elif latest_message.type == 'private' %}
                                            <!-- 私信头像 -->
                                            {% if latest_message.private_chat and latest_message.private_chat.sender %}
                                                {% if latest_message.private_chat.sender.profile and latest_message.private_chat.sender.profile.userAvatar %}
                                                    <img 
                                                        src="{{ latest_message.private_chat.sender.profile.userAvatar.url }}"
                                                        alt="{{ latest_message.private_chat.sender.name|default:latest_message.private_chat.sender.username|default:'未知用户' }}"
                                                        class="w-full h-full object-cover rounded-full"
                                                        onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500\'><i class=\'fa-solid fa-user\'></i></div>'"
                                                    >
                                                {% else %}
                                                    <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                        <i class="fa-solid fa-user"></i>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                    <i class="fa-solid fa-user"></i>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- 其他消息类型图标 -->
                                            <div class="w-full h-full bg-secondary/10 rounded-full flex items-center justify-center text-secondary">
                                                <i class="fa-solid fa-briefcase"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- 消息内容（仅显示最新一条） -->
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-neutral-900">
                                                {% if latest_message.type == 'system' %}
                                                    系统通知
                                                {% elif latest_message.type == 'private' and latest_message.private_chat and latest_message.private_chat.sender %}
                                                    {{ latest_message.private_chat.sender.name|default:latest_message.private_chat.sender.username }}
                                                {% elif latest_message.type == 'private' %}
                                                    用户私信
                                                {% else %}
                                                    业务提醒
                                                {% endif %}
                                            </h4>
                                            <span class="text-neutral-400 text-xs">
                                                {{ latest_message.create_time|date:"Y-m-d H:i"|default:"未知时间" }}
                                            </span>
                                        </div>
                                        <p class="text-neutral-700 mt-1 line-clamp-2">
                                            {{ latest_message.content|default:"无内容" }}
                                        </p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">
                                                {{ latest_message.get_type_display|default:"未知类型" }}
                                            </span>
                                            {% if not latest_message.is_read %}
                                                <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">
                                                    未读
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- 所有消息分页导航（修复：保留筛选状态） -->
                            <div class="p-4 text-center">
                                <div class="flex justify-center items-center gap-2">
                                    {% if page_obj.has_previous %}
                                        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}"
                                            class="px-4 py-2 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                                            上一页
                                        </a>
                                    {% endif %}

                                    <span class="px-4 py-2 bg-primary text-white rounded-lg">
                                        第 {{ page_obj.number|default:1 }} / {{ page_obj.paginator.num_pages|default:1 }} 页
                                    </span>

                                    {% if page_obj.has_next %}
                                        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.filter %}&filter={{ request.GET.filter }}{% endif %}"
                                            class="px-4 py-2 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                                            下一页
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <!-- 所有消息空状态 -->
                            <div class="p-12 text-center">
                                <i class="fa-solid fa-envelope-open text-5xl text-neutral-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-neutral-900 mb-2">暂无消息</h3>
                                <p class="text-neutral-500">您还没有收到任何消息，稍后再来看看吧</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 未读消息列表 -->
                <div id="tab-unread-messages"
                    class="bg-white rounded-xl shadow-lg overflow-hidden {% if not request.GET.filter == 'unread' %}hidden{% endif %}">
                    <div class="message-list-content">
                        {% if unread_messages %}
                            {% for message in unread_messages %}
                            <div class="p-4 border-b border-neutral-100 cursor-pointer transition-all duration-200 hover:bg-neutral-50 hover:translate-x-1 border-l-3 border-primary"
                                onclick="window.location.href='{% if message.type == 'private' and message.private_chat and message.private_chat.sender %}{% url 'message:private_chat_detail' message.private_chat.sender.id %}{% else %}{% url 'message:detail' message.id %}{% endif %}'">
                                <div class="flex">
                                    <!-- 消息类型图标/私信发送者头像 -->
                                    <div class="w-10 h-10 rounded-full overflow-hidden mr-4 flex-shrink-0">
                                        {% if message.type == 'system' %}
                                            <div class="w-full h-full bg-primary/10 rounded-full flex items-center justify-center text-primary">
                                                <i class="fa-solid fa-bell"></i>
                                            </div>
                                        {% elif message.type == 'private' %}
                                            <!-- 私信头像 -->
                                            {% if message.private_chat and message.private_chat.sender %}
                                                {% if message.private_chat.sender.profile and message.private_chat.sender.profile.userAvatar %}
                                                    <img 
                                                        src="{{ message.private_chat.sender.profile.userAvatar.url }}"
                                                        alt="{{ message.private_chat.sender.name|default:message.private_chat.sender.username|default:'未知用户' }}"
                                                        class="w-full h-full object-cover rounded-full"
                                                        onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500\'><i class=\'fa-solid fa-user\'></i></div>'"
                                                    >
                                                {% else %}
                                                    <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                        <i class="fa-solid fa-user"></i>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="w-full h-full bg-neutral-100 rounded-full flex items-center justify-center text-neutral-500">
                                                    <i class="fa-solid fa-user"></i>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- 其他消息类型图标 -->
                                            <div class="w-full h-full bg-secondary/10 rounded-full flex items-center justify-center text-secondary">
                                                <i class="fa-solid fa-briefcase"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- 消息内容 -->
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-semibold text-neutral-900">
                                                {% if message.type == 'system' %}
                                                    系统通知
                                                {% elif message.type == 'private' and message.private_chat and message.private_chat.sender %}
                                                    {{ message.private_chat.sender.name|default:message.private_chat.sender.username }}
                                                {% elif message.type == 'private' %}
                                                    用户私信
                                                {% else %}
                                                    业务提醒
                                                {% endif %}
                                            </h4>
                                            <span class="text-neutral-400 text-xs">
                                                {{ message.create_time|date:"Y-m-d H:i"|default:"未知时间" }}
                                            </span>
                                        </div>
                                        <p class="text-neutral-700 mt-1 line-clamp-2">
                                            {{ message.content|default:"无内容" }}
                                        </p>
                                        <div class="mt-2 flex items-center gap-2">
                                            <span class="bg-primary/10 text-primary text-xs px-2 py-0.5 rounded-full">
                                                {{ message.get_type_display|default:"未知类型" }}
                                            </span>
                                            <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full">
                                                未读
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- 未读消息分页导航 -->
                            <div class="p-4 text-center">
                                <div class="flex justify-center items-center gap-2">
                                    {% if unread_page_obj.has_previous %}
                                        <a href="?filter=unread&page={{ unread_page_obj.previous_page_number }}"
                                            class="px-4 py-2 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                                            上一页
                                        </a>
                                    {% endif %}

                                    <span class="px-4 py-2 bg-primary text-white rounded-lg">
                                        第 {{ unread_page_obj.number|default:1 }} / {{ unread_page_obj.paginator.num_pages|default:1 }} 页
                                    </span>

                                    {% if unread_page_obj.has_next %}
                                        <a href="?filter=unread&page={{ unread_page_obj.next_page_number }}"
                                            class="px-4 py-2 bg-white border border-neutral-300 rounded-lg hover:bg-neutral-50 transition-colors">
                                            下一页
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <!-- 未读消息空状态 -->
                            <div class="p-12 text-center">
                                <i class="fa-solid fa-envelope-open text-5xl text-neutral-300 mb-4"></i>
                                <h3 class="text-xl font-semibold text-neutral-900 mb-2">暂无未读消息</h3>
                                <p class="text-neutral-500">你已经阅读了所有消息</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}


{% block extra_js %}
<script>
    // 消息列表操作
    document.addEventListener('DOMContentLoaded', function () {
        // 标签切换功能
        const btnMessageList = document.getElementById('btn-message-list');
        const btnUnreadMessages = document.getElementById('btn-unread-messages');
        const tabMessageList = document.getElementById('tab-message-list');
        const tabUnreadMessages = document.getElementById('tab-unread-messages');
        // 获取未读消息数量
        const unreadCount = parseInt(document.querySelector('#btn-unread-messages span')?.textContent || 0);

        // 切换到所有消息
        if (btnMessageList) {
            btnMessageList.addEventListener('click', function () {
                // 更新按钮状态
                btnMessageList.classList.remove('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
                btnMessageList.classList.add('bg-primary', 'text-white');

                if (btnUnreadMessages) {
                    btnUnreadMessages.classList.remove('bg-primary', 'text-white');
                    btnUnreadMessages.classList.add('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
                }

                // 更新标签内容显示
                if (tabMessageList) tabMessageList.classList.remove('hidden');
                if (tabUnreadMessages) tabUnreadMessages.classList.add('hidden');

                // 重置URL参数（保留页码）
                const url = new URL(window.location);
                url.searchParams.delete('filter');
                window.history.replaceState({}, document.title, url);
            });
        }

        // 切换到未读消息（新增数量提示）
        if (btnUnreadMessages) {
            btnUnreadMessages.addEventListener('click', function () {
                // 更新按钮状态
                btnUnreadMessages.classList.remove('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
                btnUnreadMessages.classList.add('bg-primary', 'text-white');

                if (btnMessageList) {
                    btnMessageList.classList.remove('bg-primary', 'text-white');
                    btnMessageList.classList.add('bg-neutral-100', 'text-neutral-700', 'hover:bg-neutral-200');
                }

                // 更新标签内容显示
                if (tabUnreadMessages) tabUnreadMessages.classList.remove('hidden');
                if (tabMessageList) tabMessageList.classList.add('hidden');

                // 更新URL参数
                const url = new URL(window.location);
                url.searchParams.set('filter', 'unread');
                window.history.replaceState({}, document.title, url);
            });
        }

        // 加载状态和错误处理
        const loadingState = document.querySelector('.loading-state');
        const errorState = document.querySelector('.error-state');
        const messageListContent = document.querySelector('.message-list-content');
        const retryBtn = document.querySelector('.retry-btn');

        // 重试按钮点击事件
        if (retryBtn) {
            retryBtn.addEventListener('click', function () {
                // 显示加载状态
                if (loadingState) loadingState.classList.remove('hidden');
                if (errorState) errorState.classList.add('hidden');
                if (messageListContent) messageListContent.classList.add('hidden');

                // 模拟重新加载
                setTimeout(function () {
                    if (loadingState) loadingState.classList.add('hidden');
                    if (messageListContent) messageListContent.classList.remove('hidden');
                    window.location.reload();
                }, 1000);
            });
        }

        // 为消息项添加点击效果
        const messageItems = document.querySelectorAll('[onclick^="window.location.href"]');
        messageItems.forEach(item => {
            item.addEventListener('click', function () {
                this.classList.add('opacity-70');
                setTimeout(() => {
                    this.classList.remove('opacity-70');
                }, 200);
            });
        });

        // 提示框函数
        function showToast(message, type = 'info') {
            // 移除已存在的提示
            const existingToast = document.querySelector('.message-toast');
            if (existingToast) existingToast.remove();

            // 创建提示元素
            const toast = document.createElement('div');
            const bgColor = {
                info: 'bg-primary text-white',
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white'
            };
            const icon = {
                info: 'bell',
                success: 'check-circle',
                error: 'exclamation-circle'
            };

            toast.className = `message-toast fixed top-20 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${bgColor[type] || bgColor.info} transition-all duration-300 transform translate-y-0 opacity-100`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-${icon[type]}"></i>
                    <span>${message}</span>
                </div>
            `;

            // 添加到页面
            document.body.appendChild(toast);

            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-10px]');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 新增提示动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateY(-10px); }
                10% { opacity: 1; transform: translateY(0); }
                90% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(-10px); }
            }
            .message-toast {
                animation: fadeInOut 3s ease forwards;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}