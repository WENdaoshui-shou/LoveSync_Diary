{% extends 'base.html' %}

{% block title %}私信 - {{ chat_partner.name }}{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
        .message-bubble-sent {
            background-color: #FF6B8B;
            color: white;
            border-radius: 18px 18px 4px 18px;
            align-self: flex-end;
        }
        .message-bubble-received {
            background-color: #F3F4F6;
            color: #1F2937;
            border-radius: 18px 18px 18px 4px;
            align-self: flex-start;
        }
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 2px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation">
    </div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 页面标题 -->
        <div class="bg-white rounded-xl shadow-lg p-4 flex items-center justify-between hover-scale">
            <div class="flex items-center space-x-3">
                <a href="{% url 'message:list' %}" class="text-neutral-600 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                <div class="w-10 h-10 rounded-full overflow-hidden">
                    {% if chat_partner.profile and chat_partner.profile.userAvatar %}
                    <img src="{{ chat_partner.profile.userAvatar.url }}" alt="{{ chat_partner.name }}"
                        class="w-full h-full object-cover">
                    {% else %}
                    <div
                        class="w-full h-full bg-neutral-200 rounded-full flex items-center justify-center text-neutral-500">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    {% endif %}
                </div>
                <h2 class="text-xl font-bold text-neutral-900">{{ chat_partner.name }}</h2>
            </div>
        </div>

        <!-- 聊天内容区域 -->
        <div class="bg-white rounded-xl shadow-lg mt-6 overflow-hidden">
            <!-- 消息列表 -->
            <div class="h-[60vh] overflow-y-auto p-6 space-y-4" id="chatMessages">
                {% for chat in chat_messages %}
                {% if chat.sender == request.user %}
                <!-- 发送的消息 - 时间在上边 -->
                <div class="flex justify-end mb-4 flex-col items-end">
                    <span class="message-time">{{ chat.message.create_time|date:"Y-m-d H:i" }}</span>
                    <div class="max-w-[80%] message-bubble-sent p-4">
                        <p class="text-sm">{{ chat.message.content }}</p>
                    </div>
                </div>
                {% else %}
                <!-- 接收的消息 - 时间在上边 -->
                <div class="flex justify-start mb-4 flex-col items-start">
                    <span class="message-time">{{ chat.message.create_time|date:"Y-m-d H:i" }}</span>
                    <div class="max-w-[80%] message-bubble-received p-4">
                        <p class="text-sm">{{ chat.message.content }}</p>
                    </div>
                </div>
                {% endif %}
                {% empty %}
                <div class="text-center py-12 text-neutral-500">
                    <i class="fa-solid fa-comment-dots text-4xl mb-4 opacity-50"></i>
                    <p>暂无消息记录</p>
                    <p class="text-sm mt-2">开始和 {{ chat_partner.name }} 聊天吧</p>
                </div>
                {% endfor %}
            </div>

            <!-- 回复输入区域 -->
            <div class="border-t border-neutral-200 p-4">
                <form id="replyForm" class="flex items-end space-x-3">
                    {% csrf_token %}
                    <input type="hidden" name="recipient_id" value="{{ chat_partner.id }}">
                    <div class="flex-1">
                        <textarea name="content" rows="1" placeholder="输入消息..."
                            class="w-full p-3 border border-neutral-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"
                            id="messageInput"></textarea>
                    </div>
                    <button type="submit"
                        class="bg-primary text-white rounded-full p-3 hover:bg-primary/90 transition-colors">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // 工具函数：格式化时间为 Y-m-d H:i 格式
    function formatMessageTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function () {
        // 初始滚动到底部
        scrollToBottom();

        // 表单提交处理
        const replyForm = document.getElementById('replyForm');

        // 监听输入框变化，自动调整高度
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            // 设置初始高度
            messageInput.style.height = 'auto';
            messageInput.style.height = `${messageInput.scrollHeight}px`;
            
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                // 限制最大高度为120px
                const newHeight = Math.min(this.scrollHeight, 120);
                this.style.height = `${newHeight}px`;
            });

            // 回车发送消息
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (replyForm) {
                        replyForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        }

        if (replyForm) {
            replyForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const content = messageInput.value.trim();
                if (!content) {
                    showMessage('消息内容不能为空', 'error');
                    return;
                }

                // 获取CSRF令牌
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrftoken) {
                    showMessage('CSRF令牌缺失，无法发送消息', 'error');
                    return;
                }

                // 禁用提交按钮防止重复提交
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                // 构建表单数据
                const formData = new FormData(this);
                const formDataObj = {};
                formData.forEach((value, key) => {
                    formDataObj[key] = value;
                });

                // 发送AJAX请求
                fetch("{% url 'message:send_private_message' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams(formDataObj)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误，状态码：${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // 清空输入框
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                        messageInput.style.height = `${messageInput.scrollHeight}px`;

                        // 添加新消息到聊天记录（时间在上边）
                        const chatMessages = document.getElementById('chatMessages');
                        const newMessage = document.createElement('div');
                        newMessage.className = 'flex justify-end mb-4 flex-col items-end';
                        
                        // 使用统一的时间格式化函数
                        const currentTime = formatMessageTime(new Date());
                        
                        newMessage.innerHTML = `
                            <span class="message-time">${currentTime}</span>
                            <div class="max-w-[80%] message-bubble-sent p-4">
                                <p class="text-sm">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            </div>
                        `;
                        chatMessages.appendChild(newMessage);
                        scrollToBottom();
                    } else {
                        showMessage(data.message || '发送失败，请重试', 'error');
                    }
                })
                .catch(error => {
                    console.error('发送失败:', error);
                    showMessage('网络错误，消息发送失败', 'error');
                })
                .finally(() => {
                    // 恢复提交按钮状态
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
                });
            });
        }
    });

    // 滚动到底部函数（优化版）
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            // 使用requestAnimationFrame确保滚动更平滑
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
    }

    // 显示消息提示函数
    function showMessage(message, type) {
        // 移除已存在的提示
        const existingToast = document.querySelector('.message-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-toast fixed top-20 right-4 px-5 py-4 rounded-xl shadow-lg transform transition-all duration-300 z-50 ${
            type === 'success' 
                ? 'bg-green-100 text-green-700 border border-green-200' 
                : 'bg-red-100 text-red-700 border border-red-200'
        }`;
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-lg mr-2"></i>
                <span>${message}</span>
            </div>
        `;

        // 添加到页面
        document.body.appendChild(messageDiv);

        // 显示动画
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateY(0)';
        }, 10);

        // 3秒后移除
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}