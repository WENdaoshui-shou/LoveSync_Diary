{% extends 'base.html' %}

{% block title %}私信 - {{ chat_partner.name }}{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
        .message-bubble-sent {
            background-color: #FF6B8B;
            color: white;
            border-radius: 18px 18px 4px 18px;
            align-self: flex-end;
        }
        .message-bubble-received {
            background-color: #F3F4F6;
            color: #1F2937;
            border-radius: 18px 18px 18px 4px;
            align-self: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 背景装饰元素 -->
<div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation">
    </div>
    <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
        style="animation-delay: -2s;"></div>
    <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
        style="animation-delay: -4s;"></div>
</div>

<!-- 主内容区 -->
<main class="flex-grow pt-24 pb-16 relative z-10">
    <div class="container mx-auto px-4">
        <!-- 页面标题 -->
        <div class="bg-white rounded-xl shadow-lg p-4 flex items-center justify-between hover-scale">
            <div class="flex items-center space-x-3">
                <a href="{% url 'message:private_chat_list' %}"
                    class="text-neutral-600 hover:text-primary transition-colors">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                <div class="w-10 h-10 rounded-full overflow-hidden">
                    <img src="{{ chat_partner.profile.userAvatar.url }}" alt="{{ chat_partner.name }}"
                        class="w-full h-full object-cover">
                </div>
                <h2 class="text-xl font-bold text-neutral-900">{{ chat_partner.name }}</h2>
            </div>
        </div>

        <!-- 聊天内容区域 -->
        <div class="bg-white rounded-xl shadow-lg mt-6 overflow-hidden">
            <!-- 消息列表 -->
            <div class="h-[60vh] overflow-y-auto p-6 space-y-4" id="chatMessages">
                {% for chat in chat_messages %}
                {% if chat.sender == request.user %}
                <!-- 发送的消息 -->
                <div class="flex justify-end mb-4">
                    <div class="max-w-[80%] message-bubble-sent p-4">
                        <p class="text-sm">{{ chat.message.content }}</p>
                        <span class="text-xs opacity-80 block mt-1 text-right">{{ chat.message.create_time|date:"Y-m-d
                            H:i" }}</span>
                    </div>
                </div>
                {% else %}
                <!-- 接收的消息 -->
                <div class="flex justify-start mb-4">
                    <div class="max-w-[80%] message-bubble-received p-4">
                        <p class="text-sm">{{ chat.message.content }}</p>
                        <span class="text-xs opacity-70 block mt-1 text-right">{{ chat.message.create_time|date:"Y-m-d
                            H:i" }}</span>
                    </div>
                </div>
                {% endif %}
                {% empty %}
                <div class="text-center py-12 text-neutral-500">
                    <i class="fa-solid fa-comment-dots text-4xl mb-4 opacity-50"></i>
                    <p>暂无消息记录</p>
                    <p class="text-sm mt-2">开始和 {{ chat_partner.name }} 聊天吧</p>
                </div>
                {% endfor %}
            </div>

            <!-- 回复输入区域 -->
            <div class="border-t border-neutral-200 p-4">
                <form id="replyForm" class="flex items-end space-x-3">
                    {% csrf_token %}
                    <input type="hidden" name="recipient_id" value="{{ chat_partner.id }}">
                    <div class="flex-1">
                        <textarea name="content" rows="1" placeholder="输入消息..."
                            class="w-full p-3 border border-neutral-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"
                            id="messageInput"></textarea>
                    </div>
                    <button type="submit"
                        class="bg-primary text-white rounded-full p-3 hover:bg-primary/90 transition-colors">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    // 页面加载完成后滚动到底部
    document.addEventListener('DOMContentLoaded', function () {
        scrollToBottom();

        // 监听输入框变化，自动调整高度
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // 表单提交
        const replyForm = document.getElementById('replyForm');
        replyForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const content = messageInput.value.trim();
            if (!content) {
                alert('消息内容不能为空');
                return;
            }

            // 获取CSRF令牌
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // 发送AJAX请求
            fetch('{% url 'message: send_private_message' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams(new FormData(this))
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空输入框
                        messageInput.value = '';
                        messageInput.style.height = 'auto';

                        // 添加新消息到聊天记录
                        const chatMessages = document.getElementById('chatMessages');
                        const newMessage = document.createElement('div');
                        newMessage.className = 'flex justify-end mb-4';
                        newMessage.innerHTML = `
                        <div class="max-w-[80%] message-bubble-sent p-4">
                            <p class="text-sm">${content}</p>
                            <span class="text-xs opacity-80 block mt-1 text-right">${new Date().toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                    `;
                        chatMessages.appendChild(newMessage);
                        scrollToBottom();

                        // 显示成功提示
                        showMessage('私信发送成功', 'success');
                    } else {
                        // 显示错误提示
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('发送失败:', error);
                    showMessage('发送失败，请重试', 'error');
                });
        });
    });

    // 滚动到底部
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 显示消息提示
    function showMessage(message, type) {
        // 创建消息元素
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-20 right-4 px-5 py-4 rounded-xl shadow-lg transform transition-all duration-300 z-50 ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-red-100 text-red-700 border border-red-200'}`;
        messageDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} text-lg mr-2"></i>
                <span>${message}</span>
            </div>
        `;

        // 添加到页面
        document.body.appendChild(messageDiv);

        // 3秒后移除
        setTimeout(() => {
            messageDiv.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}