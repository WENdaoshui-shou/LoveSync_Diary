{% extends 'base.html' %}
{% load static %}

{% block title %}关注 - LoveSync{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 页面标题 -->
    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-neutral-800 mb-2">关注</h1>
    </div>

    <!-- 内容区域 -->
    <div class="max-w-4xl mx-auto">
        <!-- 标签页导航 -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="flex border-b border-neutral-200">
                <button id="followingTab"
                    class="flex-1 py-4 text-center font-medium transition-all duration-300 {% if list_type == 'following' %}text-primary border-b-2 border-primary{% else %}text-neutral-600 hover:text-primary{% endif %}"
                    onclick="switchTab('following')">
                    我的关注 ({{ following_count }})
                </button>
                <button id="followerTab"
                    class="flex-1 py-4 text-center font-medium transition-all duration-300 {% if list_type == 'follower' %}text-primary border-b-2 border-primary{% else %}text-neutral-600 hover:text-primary{% endif %}"
                    onclick="switchTab('follower')">
                    我的粉丝 ({{ follower_count }})
                </button>
            </div>
        </div>

        <!-- 空状态 -->
        {% if not user_list %}
        <div class="text-center py-16 bg-white rounded-xl shadow-lg">
            <div class="w-20 h-20 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-user-slash text-4xl text-neutral-400"></i>
            </div>
            <h3 class="text-lg font-medium text-neutral-700 mb-2">暂无{% if list_type == 'following' %}关注{% else %}粉丝{% endif %}</h3>
            <p class="text-neutral-500">
                {% if list_type == 'following' %}
                你还没有关注任何人，去社区看看吧
                {% else %}
                还没有人关注你，快去分享更多动态吧
                {% endif %}
            </p>
            <a href="{% url 'community' %}"
                class="mt-4 inline-block px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-300">
                去社区看看
            </a>
        </div>
        {% else %}
            <!-- 替换用户列表的循环部分 -->
            <div class="grid grid-cols-1 gap-4">
                {% for item in user_list %}
                    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
                        <div class="p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <a href="{% url 'core:user_profile' item.user.username %}" class="block w-12 h-12 rounded-full overflow-hidden">
                                        {% if item.user.profile.userAvatar %}
                                        <img src="{{ item.user.profile.userAvatar.url }}" alt="{{ item.user.name }}的头像" class="w-full h-full object-cover">
                                        {% else %}
                                        <div class="w-full h-full bg-neutral-200 flex items-center justify-center text-neutral-500">
                                            <i class="fa-solid fa-user text-xl"></i>
                                        </div>
                                        {% endif %}
                                    </a>
                                    <div>
                                        <a href="{% url 'core:user_profile' item.user.username %}" class="font-medium text-neutral-800 hover:text-primary transition-colors">{{ item.user.name }}
                                        </a>
                                        <p class="text-neutral-500 text-xs">@{{ item.user.username }}</p>
                                        <p class="text-neutral-400 text-xs mt-1">
                                            {% if list_type == 'following' %}
                                            关注于 {{ item.follow_time|date:"Y-m-d H:i" }}
                                            {% else %}
                                            关注你于 {{ item.follow_time|date:"Y-m-d H:i" }}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>

                                <!-- 操作按钮 -->
                                {% if list_type == 'following' %}
                                <button data-follow-action data-user-id="{{ item.user.id }}"
                                    class="text-sm bg-neutral-200 text-neutral-700 rounded-full px-3 py-1 hover:bg-neutral-300 transition-all duration-300 flex items-center gap-1">
                                    </i> 取消关注
                                </button>
                                {% else %}
                                {% if item.user != request.user %}
                                {% if item.is_following %}
                                <button data-follow-action data-user-id="{{ item.user.id }}"
                                    class="text-sm bg-neutral-200 text-neutral-700 rounded-full px-3 py-1 hover:bg-neutral-300 transition-all duration-300 flex items-center gap-1">
                                    <i class="fa-solid fa-check text-xs"></i> 已关注
                                </button>
                                {% else %}
                                <button data-follow-action data-user-id="{{ item.user.id }}"
                                    class="text-sm bg-primary text-white rounded-full px-3 py-1 hover:bg-primary/90 transition-all duration-300 flex items-center gap-1">
                                    <i class="fa-solid fa-plus text-xs"></i> 关注
                                </button>
                                {% endif %}
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<!-- 标签页切换脚本 - 修复编辑器语法误报 -->
<script>
    // 提前渲染常量，避免编辑器报错
    const FOLLOWING_LIST_URL = "{% url 'core:following_list' %}";
    const FOLLOWER_LIST_URL = "{% url 'core:follower_list' %}";
    const CURRENT_LIST_TYPE = "{{ list_type }}";
    const FOLLOW_TOGGLE_URL = "{% url 'core:follow_toggle' %}";

    function switchTab(tabType) {
        const url = tabType === 'following' ? FOLLOWING_LIST_URL : FOLLOWER_LIST_URL;
        window.location.href = url;
    }
</script>

<!-- AJAX交互逻辑 - 增强健壮性 -->
<script>
    // 获取CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 关注/取消关注操作 - 完善错误处理和状态恢复
    function toggleFollow(userId, button) {
        // 保存原始状态
        const originalContent = button.innerHTML;
        const originalClass = button.className;
        
        // 显示加载状态
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        button.disabled = true;

        // 发送AJAX请求
        fetch(FOLLOW_TOGGLE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `followed_id=${userId}`
        })
        .then(response => {
            // 处理非200状态码
            if (!response.ok) {
                throw new Error(`请求失败：${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.status === 'followed') {
                    // 关注成功
                    button.innerHTML = '<i class="fa-solid fa-check"></i> 已关注';
                    button.className = 'text-sm bg-neutral-200 text-neutral-700 rounded-full px-3 py-1 hover:bg-neutral-300 transition-all duration-300';
                } else {
                    // 取消关注成功
                    if (CURRENT_LIST_TYPE === 'following') {
                        // 在关注列表中，移除当前用户项
                        const userItem = button.closest('.bg-white');
                        if (userItem) {
                            userItem.classList.add('opacity-0', 'scale-95');
                            setTimeout(() => {
                                userItem.remove();
                                // 更新关注数显示
                                const countElement = document.querySelector('#followingTab');
                                if (countElement) {
                                    const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
                                    countElement.textContent = countElement.textContent.replace(/\(\d+\)/, `(${currentCount - 1})`);
                                }
                            }, 300);
                        }
                    } else {
                        // 在粉丝列表中，更新按钮状态
                        button.innerHTML = '<i class="fa-solid fa-plus"></i> 关注';
                        button.className = 'text-sm bg-primary text-white rounded-full px-3 py-1 hover:bg-primary/90 transition-all duration-300';
                    }
                }
            } else {
                // 操作失败，抛出错误触发catch
                throw new Error(data.message || '操作失败，请重试');
            }
        })
        .catch(error => {
            console.error('操作失败:', error);
            // 恢复原始状态
            button.innerHTML = originalContent;
            button.className = originalClass;
            alert(error.message || '网络错误，请重试');
        })
        .finally(() => {
            // 确保按钮始终恢复可用
            button.disabled = false;
        });
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function () {
        // 为所有关注/取消关注按钮添加事件监听器
        document.querySelectorAll('[data-follow-action]').forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault(); // 防止默认行为
                const userId = this.getAttribute('data-user-id');
                if (userId) {
                    toggleFollow(userId, this);
                } else {
                    alert('用户ID不存在');
                }
            });
        });
    });
</script>
{% endblock %}