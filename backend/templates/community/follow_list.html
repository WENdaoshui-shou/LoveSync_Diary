{% extends 'base.html' %}
{% load static %}

{% block title %}关注 - LoveSync{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 页面标题 -->
    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-neutral-800 mb-2">关注</h1>
    </div>

    <!-- 内容区域 -->
    <div class="max-w-4xl mx-auto">
        <!-- 标签页导航 -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="flex border-b border-neutral-200">
                <button 
                    id="followingTab"
                    class="flex-1 py-4 text-center font-medium transition-all duration-300 {% if list_type == 'following' %}text-primary border-b-2 border-primary{% else %}text-neutral-600 hover:text-primary{% endif %}"
                    onclick="switchTab('following')">
                    我的关注 ({{ request.user.following.count }})
                </button>
                <button 
                    id="followerTab"
                    class="flex-1 py-4 text-center font-medium transition-all duration-300 {% if list_type == 'follower' %}text-primary border-b-2 border-primary{% else %}text-neutral-600 hover:text-primary{% endif %}"
                    onclick="switchTab('follower')">
                    我的粉丝 ({{ request.user.followers.count }})
                </button>
            </div>
        </div>

        <!-- 空状态 -->
        {% if not user_list %}
        <div class="text-center py-16 bg-white rounded-xl shadow-lg">
            <div class="w-20 h-20 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-user-slash text-4xl text-neutral-400"></i>
            </div>
            <h3 class="text-lg font-medium text-neutral-700 mb-2">暂无{% if list_type == 'following' %}关注{% else %}粉丝{% endif %}</h3>
            <p class="text-neutral-500">
                {% if list_type == 'following' %}
                你还没有关注任何人，去社区看看吧
                {% else %}
                还没有人关注你，快去分享更多动态吧
                {% endif %}
            </p>
            <a href="{% url 'community' %}" class="mt-4 inline-block px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all duration-300">
                去社区看看
            </a>
        </div>
        {% else %}
        <!-- 用户列表 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for user in user_list %}
            <!-- 查找对应的关注记录 -->
            {% if list_type == 'following' %}
                {% for follow in follows %}
                    {% if follow.followed == user %}
                        {% with follow_time=follow.created_at %}
                            {% include 'community/follow_user_item.html' with user=user follow_time=follow_time %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            {% else %}
                {% for follow in follows %}
                    {% if follow.follower == user %}
                        {% with follow_time=follow.created_at %}
                            {% include 'community/follow_user_item.html' with user=user follow_time=follow_time %}
                        {% endwith %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- 标签页切换脚本 -->
<script>
function switchTab(tabType) {
    const url = tabType === 'following' ? "{% url 'core:following_list' %}" : "{% url 'core:follower_list' %}";
    window.location.href = url;
}
</script>

<!-- 关注用户项模板 -->
{% comment %}
由于Django模板的限制，我们使用内联模板来避免创建额外文件
{% endcomment %}
{% if False %}
{% include 'community/follow_user_item.html' %}
{% endif %}

<!-- AJAX交互逻辑 -->
<script>
// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 关注/取消关注操作
function toggleFollow(userId, button) {
    // 显示加载状态
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    button.disabled = true;

    // 发送AJAX请求
    fetch('{% url "core:follow_toggle" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `followed_id=${userId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.status === 'followed') {
                // 关注成功
                button.innerHTML = '<i class="fa-solid fa-check"></i> 已关注';
                button.className = 'text-sm bg-neutral-200 text-neutral-700 rounded-full px-3 py-1 hover:bg-neutral-300 transition-all duration-300';
            } else {
                // 取消关注成功
                if ('{{ list_type }}' === 'following') {
                    // 在关注列表中，移除当前用户项
                    const userItem = button.closest('.bg-white');
                    userItem.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        userItem.remove();
                    }, 300);
                } else {
                    // 在粉丝列表中，更新按钮状态
                    button.innerHTML = '<i class="fa-solid fa-plus"></i> 关注';
                    button.className = 'text-sm bg-primary text-white rounded-full px-3 py-1 hover:bg-primary/90 transition-all duration-300';
                }
            }
        } else {
            // 操作失败，恢复原始状态
            button.innerHTML = originalContent;
            alert(data.message || '操作失败，请重试');
        }
    })
    .catch(error => {
        console.error('操作失败:', error);
        button.innerHTML = originalContent;
        alert('网络错误，请重试');
    })
    .finally(() => {
        button.disabled = false;
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为所有关注/取消关注按钮添加事件监听器
    document.querySelectorAll('[data-follow-action]').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            toggleFollow(userId, this);
        });
    });
});
</script>
{% endblock %}