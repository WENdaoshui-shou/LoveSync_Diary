<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LoveSync{% endblock %}</title>
    <!-- 网页图标 -->
    <link rel="icon" type="image/jpg"
        href="https://wendaoshuishou.oss-cn-chengdu.aliyuncs.com/static/images/favicon.ico">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <!-- Swiper JS -->
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B8B', // 爱情粉色作为主色调
                        secondary: '#722ED1', // 紫色作为辅助色
                        neutral: {
                            100: '#F9F9F9',
                            200: '#F0F0F0',
                            300: '#E0E0E0',
                            400: '#BDBDBD',
                            500: '#9E9E9E',
                            600: '#757575',
                            700: '#616161',
                            800: '#424242',
                            900: '#212121',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .bg-gradient-love {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }
            
            /* 确保移动端品牌标识显示为圆形 */
            .md\:hidden .w-6.h-6,
            .md\:hidden .w-8.h-8 {
                border-radius: 50% !important;
            }

            .hover-scale {
                transition: transform 0.3s ease;
            }

            .hover-scale:hover {
                transform: scale(1.03);
            }

            .form-input-focus {
                transition: all 0.3s ease;
            }

            .form-input-focus:focus {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(255, 107, 139, 0.1), 0 10px 10px -5px rgba(255, 107, 139, 0.04);
            }

            .btn-pulse {
                animation: pulse 2s infinite;
            }

            .scroll-smooth {
                scroll-behavior: smooth;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(255, 107, 139, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(255, 107, 139, 0);
                }
            }
        }
    </style>
    <style>
        /* 动画类 */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="font-inter bg-neutral-100 text-neutral-800 min-h-screen scroll-smooth">
    <!-- 导航栏 -->
    {% block navigation %}
    <header class="fixed w-full top-0 z-50 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-sm py-3">
        <div class="container mx-auto px-4">
            <!-- 1. 桌面端导航栏 (md及以上屏幕显示) -->
            <div class="hidden md:flex items-center justify-between gap-4 w-full">
                <!-- 品牌标识 -->
                <a href="{% url 'index' %}" class="flex items-center space-x-2 flex-shrink-0">
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-love flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-heart text-xl"></i>
                    </div>
                    <span class="text-xl font-bold text-neutral-800 tracking-tight">LoveSync</span>
                </a>

                <!-- 桌面端主导航菜单 -->
                <nav class="flex items-center space-x-4 flex-shrink-0">
                    <a href="{% url 'community' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 border-b-2 border-transparent hover:border-primary whitespace-nowrap">爱享公社</a>
                    <a href="{% url 'moments' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 border-b-2 border-transparent hover:border-primary whitespace-nowrap">心动轨迹</a>
                    <a href="{% url 'photo_album' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 border-b-2 border-transparent hover:border-primary whitespace-nowrap">心跳相簿</a>
                    <a href="{% url 'lovesync' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 border-b-2 border-transparent hover:border-primary whitespace-nowrap">双人日记</a>

                    <!-- 更多下拉菜单 -->
                    <div class="relative" id="moreDropdown">
                        <button
                            class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm flex items-center px-2 py-2 whitespace-nowrap"
                            id="moreButton">
                            更多 <i class="fa-solid fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
                            id="moreOptions">
                            <a href="{% url 'couple_web:couple' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-heart mr-2 w-5 text-center"></i>情侣设置
                            </a>
                            <a href="{% url 'couple_web:couple_places' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-map-marker mr-2 w-5 text-center"></i>推荐地点
                            </a>
                            <a href="{% url 'couple_web:couple_test' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-question-circle mr-2 w-5 text-center"></i>爱情测试
                            </a>
                            <a href="{% url 'game_web:game_list' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-gamepad mr-2 w-5 text-center"></i>情侣游戏
                            </a>
                        </div>
                    </div>
                </nav>

                <!-- 桌面端筛选+搜索+用户操作区 -->
                <div class="flex items-center gap-4 flex-shrink-0">
                    <!-- 内容过滤器 -->
                    <div
                        class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-2 flex items-center gap-2 hover-scale">
                        <div class="flex space-x-1 flex-shrink-0">
                            <button
                                class="filter-btn active px-3 py-1.5 rounded-full bg-primary text-white text-sm font-medium"
                                data-filter="recommended">
                                推荐
                            </button>
                            <button
                                class="filter-btn px-3 py-1.5 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom"
                                data-filter="latest">
                                最新
                            </button>
                            <button
                                class="filter-btn px-3 py-1.5 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom"
                                data-filter="popular">
                                热门
                            </button>
                        </div>
                        <div class="relative min-w-[150px]">
                            <input type="text" id="searchInput" placeholder="搜索..."
                                class="w-full pl-8 pr-3 py-1.5 rounded-full border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 form-input-focus text-sm">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2">
                                <i id="search-icon" class="fa-solid fa-search text-neutral-400"></i>
                                <div id="search-loading"
                                    class="hidden inline-block animate-spin rounded-full h-3 w-3 border-t-2 border-b-2 border-primary">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 桌面端用户操作区 -->
                    <div class="flex items-center space-x-3 flex-shrink-0">
                        <a href="{% url 'moments' %}" id="createPostLinkDesktop"
                            class="flex items-center space-x-1 px-4 py-1.5 rounded-full bg-gradient-love text-white hover:opacity-90 transition-custom shadow-md hover:shadow-lg text-sm">
                            <i class="fa-solid fa-pencil"></i>
                            <span class="inline">发布动态</span>
                        </a>

                        <!-- 用户头像下拉 -->
                        <div class="relative" id="userDropdownDesktop">
                            <div class="w-9 h-9 rounded-full overflow-hidden border-2 border-primary cursor-pointer hover:scale-105 transition-transform"
                                id="userAvatarDesktop">
                                <img src="{{ user.profile.userAvatar.url }}" alt="用户头像"
                                    class="w-full h-full object-cover">
                            </div>
                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden transform origin-top-right scale-95 opacity-0 transition-all duration-200"
                                id="userOptionsDesktop">
                                <a href="{% url 'settings' %}"
                                    class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                    <i class="fa-solid fa-cog mr-2 w-5 text-center"></i>设置
                                </a>
                                <div class="border-t border-neutral-200 my-1"></div>
                                <a href="{% url 'logout' %}"
                                    class="block px-4 py-2 text-red-500 hover:bg-red-50 transition-custom flex items-center">
                                    <i class="fa-solid fa-sign-out mr-2 w-5 text-center"></i>退出登录
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 移动端导航栏 (md以下屏幕显示) -->
            <div class="flex md:hidden items-center justify-between gap-4 w-full">
                <!-- 移动端品牌标识 -->
                <a href="{% url 'index' %}" class="flex items-center space-x-1.5 flex-shrink-0">
                    <div
                        class="w-6 h-6 rounded-full bg-gradient-love flex items-center justify-center text-white shadow-md">
                        <i class="fa-solid fa-heart text-sm"></i>
                    </div>
                    <span class="text-base font-bold text-neutral-800 tracking-tight">LoveSync</span>
                </a>
                <!-- 移动端主导航 -->
                <nav class="flex space-x-4 flex-shrink-0">
                    <a href="{% url 'community' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 whitespace-nowrap">首页</a>
                    <a href="{% url 'moments' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 whitespace-nowrap">动态</a>
                    <a href="{% url 'photo_album' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 whitespace-nowrap">相簿</a>
                    <a href="{% url 'lovesync' %}"
                        class="text-neutral-700 hover:text-primary transition-custom font-medium text-sm px-2 py-2 whitespace-nowrap">日记</a>
                </nav>

                <!-- 移动端操作区 (仅显示发布+头像) -->
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <!-- 移动端发布按钮 (圆形图标) -->
                    <a href="{% url 'moments' %}" id="createPostLinkMobile"
                        class="flex items-center justify-center w-8 h-8 rounded-full bg-gradient-love text-white hover:opacity-90 transition-custom shadow-md">
                        <i class="fa-solid fa-pencil text-sm"></i>
                    </a>

                    <!-- 移动端用户头像 -->
                    <div class="relative" id="userDropdownMobile">
                        <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary cursor-pointer hover:scale-105 transition-transform"
                            id="userAvatarMobile">
                            <img src="{{ user.profile.userAvatar.url }}" alt="用户头像" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden transform origin-top-right scale-95 opacity-0 transition-all duration-200"
                            id="userOptionsMobile">
                            <a href="{% url 'couple_web:couple' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-heart mr-3 w-5 text-center"></i>情侣设置
                            </a>
                            <a href="{% url 'couple_web:couple_places' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-map-marker mr-3 w-5 text-center"></i>推荐地点
                            </a>
                            <a href="{% url 'couple_web:couple_test' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-question-circle mr-3 w-5 text-center"></i>爱情测试
                            </a>
                            <a href="{% url 'game_web:game_list' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-gamepad mr-3 w-5 text-center"></i>情侣游戏
                            </a>
                            <div class="border-t border-neutral-200 my-1 text-primary"></div>
                            <a href="{% url 'settings' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-cog mr-2 w-5 text-center"></i>设置
                            </a>
                            <a href="{% url 'logout' %}"
                                class="block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center">
                                <i class="fa-solid fa-sign-out mr-2 w-5 text-center"></i>退出登录
                            </a>
                        </div>
                    </div>

                    <!-- 移动端菜单按钮 (汉堡图标) -->
                    <button id="mobileMenuBtn"
                        class="flex items-center justify-center w-8 h-8 rounded-full bg-neutral-100 text-neutral-700 hover:bg-neutral-200 transition-custom">
                        <i class="fa-solid fa-bars text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 背景装饰元素 -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
        <div class="absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation">
        </div>
        <div class="absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
            style="animation-delay: -2s;"></div>
        <div class="absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
            style="animation-delay: -4s;"></div>
    </div>

    {%endblock%}



    <!-- 主要内容区域 -->
    {% block content %}
    <main class="container mx-auto px-4 py-20">
    </main>
    {% endblock %}

    <!-- JavaScript -->
    <script>
        // 移动端菜单切换
        document.addEventListener('DOMContentLoaded', function () {
            // 移动端菜单
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');

            if (menuToggle && mobileMenu) {
                menuToggle.addEventListener('click', function () {
                    mobileMenu.classList.toggle('hidden');
                    // 添加动画效果
                    if (!mobileMenu.classList.contains('hidden')) {
                        mobileMenu.classList.remove('-translate-y-2', 'opacity-0');
                        mobileMenu.classList.add('translate-y-0', 'opacity-100');
                    } else {
                        mobileMenu.classList.add('-translate-y-2', 'opacity-0');
                        mobileMenu.classList.remove('translate-y-0', 'opacity-100');
                    }
                });
            }

            // 更多下拉菜单
            const moreDropdown = document.getElementById('moreDropdown');
            const moreButton = document.getElementById('moreButton');
            const moreOptions = document.getElementById('moreOptions');

            if (moreDropdown && moreButton && moreOptions) {
                moreButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    moreOptions.classList.toggle('hidden');
                });

                // 点击外部关闭下拉菜单
                document.addEventListener('click', function (e) {
                    if (!moreDropdown.contains(e.target)) {
                        moreOptions.classList.add('hidden');
                    }
                });
            }

            // 用户下拉菜单
            const userDropdown = document.getElementById('userDropdownDesktop');
            const userAvatar = document.getElementById('userAvatarDesktop');
            const userOptions = document.getElementById('userOptionsDesktop');

            if (userDropdown && userAvatar && userOptions) {
                userAvatar.addEventListener('click', function () {
                    userOptions.classList.toggle('hidden');
                    // 添加动画效果
                    if (!userOptions.classList.contains('hidden')) {
                        userOptions.classList.remove('scale-95', 'opacity-0');
                        userOptions.classList.add('scale-100', 'opacity-100');
                    } else {
                        userOptions.classList.add('scale-95', 'opacity-0');
                        userOptions.classList.remove('scale-100', 'opacity-100');
                    }
                });

                // 点击外部关闭下拉菜单
                document.addEventListener('click', function (e) {
                    if (!userDropdown.contains(e.target)) {
                        userOptions.classList.add('hidden');
                        userOptions.classList.add('scale-95', 'opacity-0');
                        userOptions.classList.remove('scale-100', 'opacity-100');
                    }
                });
            }

            // 移动端用户下拉菜单
            const userDropdownMobile = document.getElementById('userDropdownMobile');
            const userAvatarMobile = document.getElementById('userAvatarMobile');
            const userOptionsMobile = document.getElementById('userOptionsMobile');

            if (userDropdownMobile && userAvatarMobile && userOptionsMobile) {
                userAvatarMobile.addEventListener('click', function () {
                    userOptionsMobile.classList.toggle('hidden');
                    // 添加动画效果
                    if (!userOptionsMobile.classList.contains('hidden')) {
                        userOptionsMobile.classList.remove('scale-95', 'opacity-0');
                        userOptionsMobile.classList.add('scale-100', 'opacity-100');
                    } else {
                        userOptionsMobile.classList.add('scale-95', 'opacity-0');
                        userOptionsMobile.classList.remove('scale-100', 'opacity-100');
                    }
                });

                // 点击外部关闭下拉菜单
                document.addEventListener('click', function (e) {
                    if (!userDropdownMobile.contains(e.target)) {
                        userOptionsMobile.classList.add('hidden');
                    }
                });
            }

            let closeTimer;

            // 鼠标经过头像时打开菜单
            if (userDropdown && userAvatar && userOptions) {
                userAvatar.addEventListener('mouseenter', function () {
                    clearTimeout(closeTimer); // 清除之前的定时器
                    userOptions.classList.remove('hidden');
                    userOptions.classList.remove('scale-95', 'opacity-0');
                    userOptions.classList.add('scale-100', 'opacity-100');
                });

                // 鼠标悬停在下拉菜单时保持菜单打开
                userDropdown.addEventListener('mouseenter', function () {
                    clearTimeout(closeTimer); // 清除之前的定时器
                    userOptions.classList.remove('hidden');
                    userOptions.classList.remove('scale-95', 'opacity-0');
                    userOptions.classList.add('scale-100', 'opacity-100');
                });

                // 鼠标离开下拉菜单时关闭菜单
                userDropdown.addEventListener('mouseleave', function () {
                    closeTimer = setTimeout(() => {
                        userOptions.classList.add('hidden');
                        userOptions.classList.add('scale-95', 'opacity-0');
                        userOptions.classList.remove('scale-100', 'opacity-100');
                    }, 500);
                });
            }
        });

        // 更多下拉菜单鼠标悬停效果
        document.addEventListener('DOMContentLoaded', function () {
            // 获取更多下拉菜单元素
            const moreDropdown = document.getElementById('moreDropdown');
            const moreButton = document.getElementById('moreButton');
            const moreOptions = document.getElementById('moreOptions');

            if (moreDropdown && moreButton && moreOptions) {
                let closeTimer;

                // 鼠标经过按钮时打开菜单
                moreButton.addEventListener('mouseenter', function () {
                    clearTimeout(closeTimer); // 清除之前的定时器
                    moreOptions.classList.remove('hidden');
                });

                // 鼠标悬停在下拉菜单时保持菜单打开
                moreDropdown.addEventListener('mouseenter', function () {
                    clearTimeout(closeTimer); // 清除之前的定时器
                    moreOptions.classList.remove('hidden');
                });

                // 鼠标离开下拉菜单时关闭菜单
                moreDropdown.addEventListener('mouseleave', function () {
                    closeTimer = setTimeout(() => {
                        moreOptions.classList.add('hidden');
                    }, 500); // 延迟200毫秒
                });
            }
        });

        // 筛选功能
        const filterBtns = document.querySelectorAll('.filter-btn');

        if (filterBtns.length > 0) {
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const filter = this.getAttribute('data-filter');

                    // 更新按钮状态
                    filterBtns.forEach(b => {
                        b.classList.remove('active', 'bg-primary', 'text-white');
                        b.classList.add('bg-neutral-100', 'text-neutral-700');
                    });
                    this.classList.add('active', 'bg-primary', 'text-white');
                    this.classList.remove('bg-neutral-100', 'text-neutral-700');

                    // 检查当前页面是否是社区页面
                    if (window.location.pathname.includes('/community/')) {
                        // 在社区页面，调用loadFilteredMoments函数
                        if (typeof loadFilteredMoments === 'function') {
                            loadFilteredMoments(filter);
                        }
                    } else {
                        // 在其他页面，重定向到社区页面并应用筛选
                        window.location.href = `/community/?filter=${filter}`;
                    }
                });
            });
        }

        // 搜索功能
        const searchInput = document.getElementById('searchInput');

        if (searchInput) {
            // 监听回车键
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // 监听搜索图标点击
            const searchIcon = document.getElementById('search-icon');
            if (searchIcon) {
                searchIcon.addEventListener('click', function (e) {
                    performSearch();
                });
            }
        }

        function performSearch() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                // 添加搜索中状态
                const searchIcon = document.getElementById('search-icon');
                const searchLoading = document.getElementById('search-loading');
                if (searchIcon && searchLoading) {
                    searchIcon.classList.add('hidden');
                    searchLoading.classList.remove('hidden');
                }

                // 检查当前页面是否是社区页面
                if (window.location.pathname.includes('/community/')) {
                    // 在社区页面，调用搜索函数
                    if (typeof searchMoments === 'function') {
                        // 直接调用搜索函数
                        const searchPromise = searchMoments(searchTerm);

                        // 检查是否返回了Promise
                        if (searchPromise && typeof searchPromise.then === 'function') {
                            // 即使返回了Promise，也添加一个最小延迟，确保用户能看到加载过程
                            const startTime = Date.now();
                            searchPromise.finally(() => {
                                const elapsedTime = Date.now() - startTime;
                                const minDelay = 500; // 最小显示时间：500ms

                                if (elapsedTime < minDelay) {
                                    // 如果搜索完成得太快，等待剩余时间
                                    setTimeout(() => {
                                        // 清空搜索框
                                        searchInput.value = '';
                                        // 恢复搜索图标
                                        if (searchIcon && searchLoading) {
                                            searchIcon.classList.remove('hidden');
                                            searchLoading.classList.add('hidden');
                                        }
                                    }, minDelay - elapsedTime);
                                } else {
                                    // 搜索时间足够长，直接恢复图标
                                    // 清空搜索框
                                    searchInput.value = '';
                                    // 恢复搜索图标
                                    if (searchIcon && searchLoading) {
                                        searchIcon.classList.remove('hidden');
                                        searchLoading.classList.add('hidden');
                                    }
                                }
                            });
                        } else {
                            // 如果没有返回Promise，延迟一下再恢复图标，确保用户能看到加载过程
                            setTimeout(() => {
                                // 清空搜索框
                                searchInput.value = '';
                                // 恢复搜索图标
                                if (searchIcon && searchLoading) {
                                    searchIcon.classList.remove('hidden');
                                    searchLoading.classList.add('hidden');
                                }
                            }, 500); // 增加延迟时间到500ms
                        }
                    } else {
                        // 如果没有searchMoments函数，刷新页面并添加搜索参数
                        window.location.href = `/community/?search=${encodeURIComponent(searchTerm)}`;
                    }
                } else {
                    // 在其他页面，重定向到社区页面并添加搜索参数
                    window.location.href = `/community/?search=${encodeURIComponent(searchTerm)}`;
                }
            }
        }

        // 会话状态管理
        let chatSession = {
            sessionId: null,
            isInitialized: false
        };
    </script>
    {% block extra_js %}{% endblock %}
</body>

</html>