<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>实时协作</title>
</head>
<body>
    <textarea id="editor" rows="10" cols="50"></textarea>
    <script>
        const socket = new WebSocket('ws://' + window.location.host + '/ws/collaboration/');

        socket.onopen = function(event) {
            console.log('WebSocket 连接已建立');
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const editor = document.getElementById('editor');
            const text = editor.value;
            if (data.op_type === 'insert') {
                const newText = text.slice(0, data.position) + data.text + text.slice(data.position);
                editor.value = newText;
            } else if (data.op_type === 'delete') {
                const newText = text.slice(0, data.position) + text.slice(data.position + data.text.length);
                editor.value = newText;
            }
        };

        socket.onclose = function(event) {
            console.log('WebSocket 连接已关闭');
        };

        const editor = document.getElementById('editor');
        editor.addEventListener('input', function(event) {
            const selectionStart = editor.selectionStart;
            const selectionEnd = editor.selectionEnd;
            const oldText = editor.value.slice(0, selectionStart) + editor.value.slice(selectionEnd);
            const newText = editor.value;
            if (newText.length > oldText.length) {
                const insertedText = newText.slice(selectionStart, selectionStart + (newText.length - oldText.length));
                const operation = {
                    op_type: 'insert',
                    position: selectionStart,
                    text: insertedText
                };
                socket.send(JSON.stringify(operation));
            } else if (newText.length < oldText.length) {
                const deletedText = oldText.slice(selectionStart, selectionStart + (oldText.length - newText.length));
                const operation = {
                    op_type: 'delete',
                    position: selectionStart,
                    text: deletedText
                };
                socket.send(JSON.stringify(operation));
            }
        });
    </script>
</body>
</html>