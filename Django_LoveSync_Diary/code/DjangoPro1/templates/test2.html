<!DOCTYPE html>
<html lang = "zh-CN" >
<head >
    <meta charset = "UTF-8" >
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0" >
    <title >LoveSync åŒäººæ—¥è®°</title >
    <script src = "https://cdn.tailwindcss.com" ></script >
    <link href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel = "stylesheet" >
    <link href = "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
          rel = "stylesheet" >

    <!-- Tailwind é…ç½® -->
    <script >
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B8B', // çˆ±æƒ…ç²‰è‰²
                        secondary: '#722ED1', // ç´«è‰²è¾…åŠ©è‰²
                        heart: '#FF6B8B',    // å¿ƒåŠ¨
                        happy: '#81E67F',    // å¼€å¿ƒ
                        laugh: '#FFD700',    // å¤§ç¬‘
                        sad: '#3B82F6',      // éš¾è¿‡
                        angry: '#8B008B',    // ç”Ÿæ°”
                        calm: '#64748B',     // å¹³é™
                        neutral: {
                            100: '#F9F9F9',
                            200: '#F0F0F0',
                            300: '#E0E0E0',
                            400: '#BDBDBD',
                            500: '#9E9E9E',
                            600: '#757575',
                            700: '#616161',
                            800: '#424242',
                            900: '#212121',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            }
        }
    </script >

    <style type = "text/tailwindcss" >
        @layer utilities {
            .diary-trigger {
                transition: all 0.3s ease;
            }

            .diary-trigger:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .mood-modal {
                background-color: var(--mood-color, #FF6B8B);
            }

            .blur-effect {
                backdrop-filter: blur(4px);
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .transition-custom {
                transition: all 0.3s ease;
            }

            .hover-scale {
                transition: transform 0.3s ease;
            }

            .hover-scale:hover {
                transform: scale(1.02);
            }

            .bg-gradient-love {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .diary-trigger {
                position: relative;
            }

            .diary-trigger:hover::after {
                position: absolute;
                bottom: -24px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                font-size: 0.875rem;
                padding: 2px 8px;
                border-radius: 4px;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
            }

            .diary-trigger:hover::after {
                opacity: 1;
                visibility: visible;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        .animate-bounce {
            animation: bounce 1.5s infinite;
        }
    </style >
</head >

<body class = "font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col overflow-x-hidden relative scroll-smooth" >
    <!-- èƒŒæ™¯è£…é¥°å…ƒç´  -->
    <div class = "absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none" >
        <div class = "absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation" ></div >
        <div class = "absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
             style = "animation-delay: -2s;" ></div >
        <div class = "absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
             style = "animation-delay: -4s;" ></div >
    </div >

    <!-- å¯¼èˆªæ  -->
    <header class = "fixed w-full top-0 z-50 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-sm py-3" >
        <div class = "container mx-auto px-4 flex items-center justify-between" >
            <!-- å“ç‰Œæ ‡è¯† -->
            <a href = "{% url 'index' %}" class = "flex items-center space-x-2" >
                <div class = "w-10 h-10 rounded-full bg-gradient-love flex items-center justify-center text-white shadow-md" >
                    <i class = "fa-solid fa-heart text-xl" ></i >
                </div >
                <span class = "text-xl font-bold text-neutral-800 tracking-tight" >LoveSync</span >
            </a >
            <!-- æ¡Œé¢ç«¯å¯¼èˆªèœå• -->
            <nav class = "hidden md:flex items-center space-x-6" >
                <a href = "{% url 'community' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >çˆ±äº«å…¬ç¤¾</a >
                <a href = "{% url 'moments' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >å¿ƒåŠ¨è½¨è¿¹</a >
                <a href = "{% url 'photo_album' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >å¿ƒè·³ç›¸ç°¿</a >
                <a href = "{% url 'lovesync' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >åŒäººæ—¥è®°</a >

                <!-- æ›´å¤šä¸‹æ‹‰èœå• -->
                <div class = "relative" id = "moreDropdown" >
                    <button
                            class = "text-neutral-700 hover:text-primary transition-custom font-medium flex items-center px-1 py-2"
                            id = "moreButton" >
                        æ›´å¤š <i class = "fa-solid fa-chevron-down ml-1 text-xs" ></i >
                    </button >
                    <div class = "absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
                         id = "moreOptions" >
                        <a href = "{% url 'couple' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-calendar-heart mr-2 w-5 text-center" ></i >æƒ…ä¾£è®¾ç½®
                        </a >
                        <a href = "{% url 'couple_recommendation' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-gift mr-2 w-5 text-center" ></i >æƒ…ä¾£æ¨è
                        </a >
                        <a href = "{% url 'couple_places' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-map-marker-heart mr-2 w-5 text-center" ></i >æƒ…ä¾£åœ°ç‚¹
                        </a >
                        <a href = "{% url 'couple_test' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-question-circle mr-2 w-5 text-center" ></i >çˆ±æƒ…æµ‹è¯•
                        </a >
                    </div >
                </div >
            </nav >

            <!-- å†…å®¹è¿‡æ»¤å™¨ -->
            <div class = "bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-2 flex justify-between items-center hover-scale" >
                <div class = "flex space-x-2" >
                    <button class = "px-4 py-2 rounded-full bg-primary text-white text-sm font-medium" >
                        æ¨è
                    </button >
                    <button class = "px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom" >
                        æœ€æ–°
                    </button >
                    <button class = "px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom" >
                        çƒ­é—¨
                    </button >
                </div >
                <div class = "relative" >
                    <input type = "text" placeholder = "LoveSync: æœç´¢..."
                           class = "pl-10 pr-4 py-2 rounded-full border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 form-input-focus text-sm" >
                    <i class = "fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" ></i >
                </div >
            </div >

            <!-- ç”¨æˆ·æ“ä½œåŒº -->
            <div class = "flex items-center space-x-4" >
                <a href = "{% url 'moments' %}" id = "createPostLink"
                   class = "hidden md:flex items-center space-x-2 px-5 py-2 rounded-full bg-gradient-love text-white hover:opacity-90 transition-custom shadow-md hover:shadow-lg" >
                    <i class = "fa-solid fa-pencil" ></i >
                    <span >å‘å¸ƒåŠ¨æ€</span >
                </a >

                <!-- ç”¨æˆ·å¤´åƒä¸ä¸‹æ‹‰èœå• -->
                <div class = "relative" id = "userDropdown" >
                    <div class = "w-10 h-10 rounded-full overflow-hidden border-2 border-primary cursor-pointer shadow-sm"
                         id = "userAvatar" >
                        <img src = "{{ user.profile.userAvatar.url }}" alt = "ç”¨æˆ·å¤´åƒ"
                             class = "w-full h-full object-cover" >
                    </div >
                    <div class = "absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
                         id = "userOptions" >
                        <a href = "{% url 'personal_center' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-user mr-2 w-5 text-center" ></i >ä¸»é¡µ
                        </a >
                        <a href = "{% url 'message' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-bookmark mr-2 w-5 text-center" ></i >æ¶ˆæ¯
                        </a >
                        <a href = "{% url 'settings' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-cog mr-2 w-5 text-center" ></i >è®¾ç½®
                        </a >
                        <div class = "border-t border-neutral-200 my-1" ></div >
                        <a href = "{% url 'logout' %}"
                           class = "block px-4 py-2 text-red-500 hover:bg-red-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-sign-out mr-2 w-5 text-center" ></i >é€€å‡ºç™»å½•
                        </a >
                    </div >
                </div >

                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button class = "md:hidden text-neutral-700 focus:outline-none" id = "menu-toggle" >
                    <i class = "fa-solid fa-bars text-xl" ></i >
                </button >
            </div >
        </div >

        <!-- ç§»åŠ¨ç«¯èœå• -->
        <div id = "mobile-menu"
             class = "hidden md:hidden bg-white shadow-lg absolute w-full transform -translate-y-2 opacity-0 transition-all duration-200 ease-in-out"
             style = "top: 100%;" >
            <div class = "container mx-auto px-4 py-3 flex flex-col space-y-3" >
                <a href = "{% url 'community' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-users mr-3 w-5 text-center" ></i >çˆ±äº«å…¬ç¤¾
                </a >
                <a href = "{% url 'moments' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-bolt mr-3 w-5 text-center" ></i >å¿ƒåŠ¨è½¨è¿¹
                </a >
                <a href = "{% url 'photo_album' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-images mr-3 w-5 text-center" ></i >å¿ƒè·³ç›¸ç°¿
                </a >
                <a href = "{% url 'lovesync' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-bookmark mr-3 w-5 text-center" ></i >åŒäººæ—¥è®°
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-calendar-heart mr-3 w-5 text-center" ></i >çºªå¿µæ—¥æé†’
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-gift mr-3 w-5 text-center" ></i >ç¤¼ç‰©æ¨è
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-map-marker-heart mr-3 w-5 text-center" ></i >æƒ…ä¾£åœ°ç‚¹
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-question-circle mr-3 w-5 text-center" ></i >çˆ±æƒ…æµ‹è¯•
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "{% url 'personal_center' %}"
                   class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-user mr-3 w-5 text-center" ></i >ä¸»é¡µ
                </a >
                <a href = "{% url 'message' %}" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-bookmark mr-3 w-5 text-center" ></i >æ¶ˆæ¯
                </a >
                <a href = "{% url 'message' %}" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-cog mr-3 w-5 text-center" ></i >è®¾ç½®
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "{% url 'logout' %}" class = "text-red-500 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-sign-out mr-3 w-5 text-center" ></i >é€€å‡ºç™»å½•
                </a >
            </div >
        </div >
    </header >


    <!-- ä¸»å†…å®¹åŒº -->
    <main class = "flex-grow pt-24 pb-16 relative z-10" >
        <div class = "container mx-auto px-4" >
            <!-- é¡¶éƒ¨æ•°æ®æ¦‚è§ˆ -->
            <div class = "bg-white rounded-xl shadow-lg p-6 mb-8 animate-fade-in" >
                <div class = "flex flex-col md:flex-row items-center justify-between" >
                    <div class = "mb-4 md:mb-0" >
                        <h2 class = "text-2xl font-bold text-neutral-800 mb-1" >æˆ‘ä»¬çš„çˆ±æƒ…æ—¥è®°</h2 >
                        <p class = "text-neutral-600" >å·²å…±åŒè®°å½• <span class = "text-primary font-semibold" >42</span > ç¯‡æ—¥è®° Â· ç›¸æ‹ <span
                                class = "text-primary font-semibold" >{{user.profile.couple_joined_at}}</span > å¤©</p >
                    </div >

                    <div class = "flex space-x-4" >
                        <div class = "bg-neutral-100 rounded-lg p-3 flex items-center space-x-3" >
                            <div class = "w-10 h-10 rounded-full overflow-hidden" >
                                <img src = {{ user.profile.userAvatar.url }} alt = "æˆ‘çš„å¤´åƒ"
                                     class = "w-full h-full object-cover" >
                            </div >
                            <div >
                                <p class = "text-sm font-medium" >æˆ‘</p >
                                <p class = "text-xs text-neutral-500" >å·²å†™ 23 ç¯‡</p >
                            </div >
                        </div >

                        <div class = "bg-neutral-100 rounded-lg p-3 flex items-center space-x-3" >
                            <div class = "w-10 h-10 rounded-full overflow-hidden" >
                                <img src = {{ user.profile.couple.user.profile.userAvatar.url }} alt = "ä¼´ä¾£å¤´åƒ"
                                     class = "w-full h-full object-cover" >
                            </div >
                            <div >
                                <p class = "text-sm font-medium" >TA</p >
                                <p class = "text-xs text-neutral-500" >å·²å†™ 19 ç¯‡</p >
                            </div >
                        </div >
                    </div >
                </div >

                <!-- æœ¬å‘¨å¿ƒæƒ…ç»Ÿè®¡ï¼ˆè§¦å‘æ—¥è®°è¡¨å•ï¼‰ -->
                <div class = "mt-6 pt-6 border-t border-neutral-200" >
                        <h3 class = "text-lg font-semibold text-neutral-800 mb-4" >æœ¬å‘¨å¿ƒæƒ…</h3 >
                        <div class = "grid grid-cols-2 md:grid-cols-6 gap-3" >
                            <div class = "bg-heart/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "heart" data-color = "#FF6B8B" >
                                <div class = "text-2xl mb-1" >â¤ï¸</div >
                                <p class = "text-sm font-medium" >å¿ƒåŠ¨</p >
                                <p class = "text-xs text-heart" >3 æ¬¡</p >
                                <p class = "mt-1 text-xs text-primary" >ç‚¹å‡»å†™æ—¥è®°</p >
                            </div >

                            <div class = "bg-happy/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "happy" data-color = "#81E67F" >
                                <div class = "text-2xl mb-1" >ğŸ˜Š</div >
                                <p class = "text-sm font-medium" >å¼€å¿ƒ</p >
                                <p class = "text-xs text-happy" >5 æ¬¡</p >
                            </div >

                            <div class = "bg-laugh/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "laugh" data-color = "#FFD700" >
                                <div class = "text-2xl mb-1" >ğŸ˜†</div >
                                <p class = "text-sm font-medium" >å¤§ç¬‘</p >
                                <p class = "text-xs text-laugh" >2 æ¬¡</p >
                            </div >

                            <div class = "bg-sad/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "sad" data-color = "#3B82F6" >
                                <div class = "text-2xl mb-1" >ğŸ˜¢</div >
                                <p class = "text-sm font-medium" >éš¾è¿‡</p >
                                <p class = "text-xs text-sad" >1 æ¬¡</p >
                            </div >

                            <div class = "bg-angry/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "angry" data-color = "#8B008B" >
                                <div class = "text-2xl mb-1" >ğŸ˜¤</div >
                                <p class = "text-sm font-medium" >ç”Ÿæ°”</p >
                                <p class = "text-xs text-angry" >0 æ¬¡</p >
                            </div >

                            <div class = "bg-calm/10 rounded-lg p-3 text-center cursor-pointer diary-trigger animate-bounce"
                                 data-mood = "calm" data-color = "#64748B" >
                                <div class = "text-2xl mb-1" >ğŸ˜</div >
                                <p class = "text-sm font-medium" >å¹³é™</p >
                                <p class = "text-xs text-calm" >2 æ¬¡</p >
                            </div >
                        </div >
                    </div >
            </div>

                <!-- æ—¶é—´è½´åŒè§†è§’å¸ƒå±€ -->
                <div class = "relative" >

                <!-- æ—¶é—´è½´åˆ†å‰²çº¿ -->
                <div class = "hidden md:block absolute left-1/2 top-0 bottom-0 w-0.5 bg-neutral-200 transform -translate-x-1/2" ></div >

                <!-- æ—¶é—´è½´æ¡ç›® -->
                <div class = "space-y-12" >
                    <!-- æ—¥è®°åˆ—è¡¨ï¼ˆæŒ‰æ—¥æœŸåˆ†ç»„å±•ç¤ºï¼‰ -->
                    {% for date_group in grouped_notes %}
                        <div class="relative">
                            <!-- æ—¥æœŸæ ‡é¢˜ï¼ˆåŠ¨æ€æ˜¾ç¤ºä»Šå¤©/æ˜¨å¤©/å…·ä½“æ—¥æœŸï¼‰ -->
                            <div class="text-center mb-8">
                                <span class="inline-block px-4 py-1 bg-white rounded-full shadow-sm text-neutral-600 font-medium">
                                    <i class="fa-solid fa-calendar-day mr-2"></i>
                                    {{ date_group.date_title }}  <!-- åŠ¨æ€æ—¥æœŸæ ‡é¢˜ï¼šä»Šå¤©/æ˜¨å¤©/å…·ä½“æ—¥æœŸ -->
                                </span>
                            </div>

                            <!-- è¯¥æ—¥æœŸä¸‹çš„æ‰€æœ‰æ—¥è®° -->
                            {% for note in date_group.notes %}
                                <!-- åˆ¤æ–­æ—¥è®°å±äºå½“å‰ç”¨æˆ·è¿˜æ˜¯æƒ…ä¾£ï¼Œè®¾ç½®ä¸åŒå¸ƒå±€ -->
                                <div class="{% if note.user == request.user %}md:w-1/2 md:pl-12{% else %}md:ml-auto md:w-1/2 md:pr-12 partner-card{% endif %} {% if not forloop.first %}mt-8{% endif %}">
                                    <div class="bg-white rounded-xl shadow-md p-5 relative diary-card-hover"
                                         style="--mood-color: {{ note.mood_color }};"  <!-- åŠ¨æ€å¿ƒæƒ…é¢œè‰² -->
                                         data-mood="{{ note.mood }}">

                                        <!-- å¿ƒæƒ…æŒ‡ç¤ºå™¨ï¼ˆåŠ¨æ€å›¾æ ‡ï¼‰ -->
                                        <div class="mood-indicator" data-icon="{{ note.mood_icon }}"></div>

                                        <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ—¶é—´ -->
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 rounded-full overflow-hidden mr-2">
                                                    <!-- åŠ¨æ€ç”¨æˆ·å¤´åƒ-->
                                                    <img src="{{ note.user.profile.avatar.url}}"
                                                         alt="{{ note.user.username }}çš„å¤´åƒ"
                                                         class="w-full h-full object-cover">
                                                </div>
                                                <!-- åŠ¨æ€æ˜¾ç¤ºç”¨æˆ·åï¼ˆåŒºåˆ†"æˆ‘"å’ŒTAï¼‰ -->
                                                <span class="font-medium">
                                                    {% if note.user == request.user %}æˆ‘{% else %}{{ note.user.profile.couple.user.name }}{% endif %}
                                                </span>
                                            </div>
                                            <!-- åŠ¨æ€æ˜¾ç¤ºæ—¶é—´ï¼ˆæ ¼å¼åŒ–åˆ°å°æ—¶åˆ†é’Ÿï¼‰ -->
                                            <span class="text-sm text-neutral-500">
                                                {{ note.created_at|date:"H:i" }}
                                            </span>
                                        </div>

                                        <!-- æ—¥è®°å†…å®¹ -->
                                        <p class="text-neutral-700 mb-4">
                                            {{ note.context }}  <!-- åŠ¨æ€æ—¥è®°å†…å®¹ -->
                                        </p>

                                        <!-- æ—¥è®°å›¾ç‰‡ï¼ˆåŠ¨æ€å¾ªç¯æ˜¾ç¤ºæ‰€æœ‰å…³è”å›¾ç‰‡ï¼‰ -->
                                        {% if note.note_images.exists %}
                                            <div class="{% if note.note_images.count > 1 %}grid grid-cols-2 gap-2{% else %}block{% endif %} mb-4">
                                                {% for image in note.note_images.all %}
                                                    <div class="rounded-lg overflow-hidden">
                                                        <img src="{{ image.noteimage.url }}"
                                                             alt="æ—¥è®°å›¾ç‰‡"
                                                             class="w-full {% if note.note_images.count == 1 %}h-auto{% else %}h-32{% endif %} object-cover">
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}

                                        <!-- æ“ä½œåŒºï¼ˆç‚¹èµæ•°ã€è¯„è®ºæŒ‰é’®ï¼‰ -->
                                        <div class="flex justify-between items-center">
                                            <!-- åŠ¨æ€å¿ƒæƒ…æ ‡ç­¾ -->
                                            <span class="text-xs text-{{ note.mood_css }} bg-{{ note.mood_css }}/10 px-2 py-1 rounded-full">
                                                {{ note.mood_display }}  <!-- åŠ¨æ€å¿ƒæƒ…æ–‡æœ¬ -->
                                            </span>
                                            <div class="flex items-center space-x-3">
                                                <!-- åŠ¨æ€ç‚¹èµæ•° -->
                                                <button class="text-{% if note.is_liked %}primary{% else %}neutral-400{% endif %} hover:text-primary transition-custom">
                                                    <i class="fa-solid fa-heart"></i>
                                                    {% if note.likes > 0 %} {{ note.likes }} {% endif %}
                                                </button>
                                                <!-- è¯„è®ºæŒ‰é’® -->
                                                <button class="text-neutral-400 hover:text-primary transition-custom response-btn"
                                                        data-diary-id="{{ note.id }}">
                                                    <i class="fa-solid fa-reply"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- å›åº”åŒºåŸŸï¼ˆåŠ¨æ€æ˜¾ç¤ºè¯„è®ºï¼‰ -->
                                        {% if note.comments > 0 and note.comment_set.exists %}
                                            <div class="mt-4 pt-4 border-t border-neutral-100">
                                                {% for comment in note.comment_set.all|slice:":1" %}  <!-- åªæ˜¾ç¤ºç¬¬ä¸€æ¡è¯„è®º -->
                                                    <div class="flex items-start mb-2">
                                                        <div class="w-6 h-6 rounded-full overflow-hidden mr-2">
                                                            <img src="{{ comment.user.profile.avatar.url|default:'https://picsum.photos/200/200?random=1' }}"
                                                                 alt="{{ comment.user.username }}çš„å¤´åƒ"
                                                                 class="w-full h-full object-cover">
                                                        </div>
                                                        <div class="flex-1">
                                                            <div class="bg-neutral-100 rounded-lg p-3">
                                                                <p class="text-sm text-neutral-700">{{ comment.content }}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                <!-- æ˜¾ç¤ºæ›´å¤šè¯„è®ºæŒ‰é’®ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                                                {% if note.comments > 1 %}
                                                    <button class="text-xs text-primary mt-1">
                                                        æŸ¥çœ‹å…¨éƒ¨{{ note.comments }}æ¡è¯„è®º
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                        </div>
                            {% endfor %}
                    {% empty %}
                        <!-- æ— æ—¥è®°æ—¶æ˜¾ç¤º -->
                        <div class="text-center py-12">
                            <div class="w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-book-open text-neutral-400 text-xl"></i>
                            </div>
                            <p class="text-neutral-500">è¿˜æ²¡æœ‰æ—¥è®°å“¦ï¼Œå¼€å§‹è®°å½•ä½ ä»¬çš„æ•…äº‹å§ï½</p>
                        </div>
                    {% endfor %}
                </div >
            </div >
    </main >

    <!-- é¡µè„š -->
    <footer class = "bg-white border-t border-neutral-200 py-8" >
        <div class = "container mx-auto px-4" >
            <div class = "flex flex-col md:flex-row justify-between items-center" >
                <div class = "flex items-center space-x-2" >
                    <div class = "w-8 h-8 bg-gradient-love rounded-full text-white" >
                        <i class = "fa-solid fa-heart" ></i >
                    </div >
                    <span class = "text-lg font-bold" >LoveSync</span >
                </div >
                <div class = "text-neutral-500 text-sm" >
                    &copy; 2025 LoveSync. æ¯ç¯‡æ—¥è®°éƒ½æ˜¯ä¸€æ£µæ ‘ï¼Œå¹´è½®é‡Œè—ç€æˆ‘ä»¬çš„æ•…äº‹
                </div >
            </div >
        </div >
    </footer >

    <!-- æ—¥è®°ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id = "new-diary-modal" class = "fixed inset-0 z-50 flex items-center justify-center hidden" >
        <div class = "absolute inset-0 bg-black/50 backdrop-blur-sm" ></div >
        <div class = "bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-slide-up relative z-10" >
            <div class = "p-6 border-b border-neutral-200 flex justify-between items-center" >
                <h3 class = "text-xl font-bold text-neutral-800" >å†™æ—¥è®°</h3 >
                <button id = "close-diary-modal" class = "text-neutral-500 hover:text-neutral-800" >
                    <i class = "fa-solid fa-times" ></i >
                </button >
            </div >

            <form id = "diary-form" method = "POST" enctype = "multipart/form-data" class = "p-6" >
                {% csrf_token %}
                <input type = "hidden" name = "mood" id = "mood-input" >
                <input type = "hidden" id = "mood-color-input" >

                <!-- æ—¥è®°å†…å®¹ -->
                <div class = "mb-6" >
                    <label class = "block text-sm font-medium text-neutral-700 mb-2" >è®°å½•ä»Šæ—¥å¿ƒåŠ¨</label >
                    <textarea id = "content" name = "content" rows = "6"
                              class = "w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-custom resize-none"
                              placeholder = "è®°å½•ä»Šå¤©çš„å¿ƒæƒ…å’Œæ•…äº‹..." ></textarea >
                </div >

                <!-- ä¸Šä¼ ç…§ç‰‡ -->
                <div class = "mb-6" >
                    <label class = "block text-sm font-medium text-neutral-700 mb-2" >ä¸Šä¼ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label >
                    <div class = "border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-custom cursor-pointer"
                         id = "photo-upload-area" >
                        <input type = "file" id = "photo-input" name = "photos" multiple accept = "image/*"
                               class = "hidden" >
                        <i class = "fa-solid fa-cloud-upload-alt text-3xl text-neutral-400 mb-3" ></i >
                        <p class = "text-neutral-600 mb-2" >ç‚¹å‡»æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œ</p >
                        <p class = "text-neutral-500 text-sm" >æ”¯æŒ JPG, PNG, GIF æ ¼å¼</p >
                    </div >
                    <div id = "photo-preview-container" class = "grid grid-cols-3 gap-2 mt-3 hidden" ></div >
                </div >

                <!-- æäº¤æŒ‰é’® -->
                <div class = "flex justify-end space-x-3" >
                    <button type = "button" id = "cancel-diary"
                            class = "px-6 py-2 border border-neutral-300 rounded-md text-neutral-700 hover:bg-neutral-50 transition-custom" >
                        å–æ¶ˆ
                    </button >
                    <button type = "submit" id = "saveButton"
                            class = "px-6 py-2 text-white rounded-lg hover:opacity-90 transition-custom shadow-md hover:shadow-lg flex items-center" >
                        <i class = "fa-solid fa-paper-plane mr-2" ></i >
                        <span >ä¿å­˜æ—¥è®°</span >
                    </button >
                </div >
            </form >
        </div >
    </div >

    <!-- äº¤äº’é€»è¾‘ -->
    <script >
        const moodColors = {};
        document.querySelectorAll('.diary-trigger').forEach(trigger => {
            moodColors[trigger.dataset.mood] = trigger.dataset.color;
        });

        let currentMoodColor = '#FF6B8B';
        let lastValue = ''; // å…¨å±€å˜é‡ï¼šè®°å½•ç¼–è¾‘å™¨ä¸Šä¸€æ¬¡å€¼ï¼ˆç”¨äºåä½œå¯¹æ¯”ï¼‰
        let currentDocumentId = "{{ document.id|default:'' }}"; // å½“å‰æ—¥è®°IDï¼ˆä»åç«¯æ¨¡æ¿è·å–ï¼‰
        let currentRevision = 0; // å½“å‰æ“ä½œç‰ˆæœ¬å·
        let isProcessingRemoteOp = false; // æ˜¯å¦å¤„ç†è¿œç¨‹æ“ä½œï¼ˆé¿å…é€’å½’ï¼‰
        let collaborationSocket = null; // WebSocketå®ä¾‹

        // DOMåŠ è½½ååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initMoodTriggers();
            initDiaryModal();
            initPhotoUpload();
            initNavDropdowns();
            initMobileMenu();
            initCollaboration(); // åˆå§‹åŒ–å®æ—¶åä½œ
        });

        // åˆå§‹åŒ–å¿ƒæƒ…è§¦å‘
        function initMoodTriggers() {
            const triggers = document.querySelectorAll('.diary-trigger');
            const moodInput = document.getElementById('mood-input');
            const moodColorInput = document.getElementById('mood-color-input');

            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const mood = trigger.dataset.mood;
                    currentMoodColor = moodColors[mood];
                    moodInput.value = mood;
                    moodColorInput.value = currentMoodColor;
                    updateSaveButtonColor();
                    openDiaryModal();
                });
            });
        }

        // æ›´æ–°ä¿å­˜æŒ‰é’®é¢œè‰²
        function updateSaveButtonColor() {
            const saveButton = document.getElementById('saveButton');
            saveButton.style.backgroundColor = currentMoodColor;
            saveButton.style.backgroundImage = `linear-gradient(135deg, ${currentMoodColor} 0%, ${currentMoodColor} 100%)`;
            saveButton.classList.remove('bg-gradient-love');
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        function initDiaryModal() {
            document.getElementById('close-diary-modal')?.addEventListener('click', closeDiaryModal);
            document.getElementById('cancel-diary')?.addEventListener('click', closeDiaryModal);

            const saveButton = document.getElementById('saveButton');
            saveButton.addEventListener('click', function () {
                this.classList.add('bg-gradient-love');
            });
        }

        // æ‰“å¼€æ—¥è®°æ¨¡æ€æ¡†
        function openDiaryModal() {
            const modal = document.getElementById('new-diary-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // é‡ç½®ç¼–è¾‘å™¨çŠ¶æ€ï¼ˆé’ˆå¯¹æ–°æ—¥è®°ï¼‰
            const editor = document.getElementById('content');
            lastValue = editor.value; // åˆå§‹åŒ–åŸºå‡†å€¼
        }

        // å…³é—­æ—¥è®°æ¨¡æ€æ¡†
        function closeDiaryModal() {
            const modal = document.getElementById('new-diary-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // åˆå§‹åŒ–ç…§ç‰‡ä¸Šä¼ 
        function initPhotoUpload() {
            const uploadArea = document.getElementById('photo-upload-area');
            const input = document.getElementById('photo-input');
            const previewContainer = document.getElementById('photo-preview-container');

            uploadArea.addEventListener('click', () => input.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    previewPhotos(input.files, previewContainer);
                }
            });

            input.addEventListener('change', (e) => {
                previewPhotos(e.target.files, previewContainer);
            });
        }

        // é¢„è§ˆç…§ç‰‡
        function previewPhotos(files, container) {
            container.innerHTML = '';
            if (!files.length) return container.classList.add('hidden');

            container.classList.remove('hidden');
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'w-full h-24 object-cover rounded-lg';
                container.appendChild(img);
            });
        }

        // åˆå§‹åŒ–å¯¼èˆªä¸‹æ‹‰èœå•
        function initNavDropdowns() {
            // ç”¨æˆ·å¤´åƒä¸‹æ‹‰
            const userAvatar = document.getElementById('userAvatar');
            const userOptions = document.getElementById('userOptions');
            let userDropdownTimer;

            userAvatar.addEventListener('mouseenter', () => {
                clearTimeout(userDropdownTimer);
                userOptions.classList.remove('hidden');
            });
            userAvatar.addEventListener('click', () => {
                userOptions.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#userDropdown')) {
                    userOptions.classList.add('hidden');
                }
            });

            // æ›´å¤šä¸‹æ‹‰èœå•
            const moreButton = document.getElementById('moreButton');
            const moreOptions = document.getElementById('moreOptions');
            let moreDropdownTimer;

            moreButton.addEventListener('mouseenter', () => {
                clearTimeout(moreDropdownTimer);
                moreOptions.classList.remove('hidden');
            });
            moreButton.addEventListener('click', () => {
                moreOptions.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#moreDropdown')) {
                    moreOptions.classList.add('hidden');
                }
            });
        }

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•
        function initMobileMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');

            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('translate-y-0');
                mobileMenu.classList.toggle('opacity-100');
            });
        }

        // åˆå§‹åŒ–å®æ—¶åä½œï¼ˆWebSocketè¿æ¥ï¼‰
        function initCollaboration() {
            if (!currentDocumentId && !document.getElementById('content')) return;

            // è¿æ¥WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${protocol}//${window.location.host}/ws/collaboration/${currentDocumentId || 'new'}/`;

            collaborationSocket = new WebSocket(socketUrl);

            // è¿æ¥æˆåŠŸ
            collaborationSocket.onopen = function () {
                console.log("å®æ—¶åä½œè¿æ¥å·²å»ºç«‹");
                // åˆå§‹åŒ–ç¼–è¾‘å™¨åŸºå‡†å€¼
                const editor = document.getElementById('content');
                if (editor) lastValue = editor.value;
            };

            // æ¥æ”¶è¿œç¨‹æ“ä½œ
            collaborationSocket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                // å¿½ç•¥è‡ªå·±å‘é€çš„æ“ä½œ
                if (data.user_id === "{{ request.user.id }}") return;

                isProcessingRemoteOp = true;
                try {
                    applyOperationToEditor(data); // åº”ç”¨è¿œç¨‹æ“ä½œ
                    currentRevision = data.revision; // æ›´æ–°ç‰ˆæœ¬å·
                } finally {
                    isProcessingRemoteOp = false;
                }
            };

            // è¿æ¥å…³é—­é‡è¿
            collaborationSocket.onclose = function () {
                console.log("åä½œè¿æ¥å…³é—­ï¼Œ3ç§’åé‡è¿...");
                setTimeout(initCollaboration, 3000);
            };

            // ç»‘å®šç¼–è¾‘å™¨äº‹ä»¶ï¼ˆå‘é€æœ¬åœ°æ“ä½œï¼‰
            bindEditorEvents();
        }

        // ç»‘å®šç¼–è¾‘å™¨äº‹ä»¶ï¼ˆæ•è·æœ¬åœ°æ“ä½œå¹¶å‘é€ï¼‰
        function bindEditorEvents() {
            const editor = document.getElementById('content');
            if (!editor) return;

            editor.addEventListener('input', function () {
                if (isProcessingRemoteOp) return; // å¿½ç•¥è¿œç¨‹æ“ä½œè§¦å‘çš„æœ¬åœ°å˜åŒ–

                const newValue = editor.value;
                const oldValue = lastValue;

                // è®¡ç®—æ“ä½œç±»å‹ï¼ˆæ’å…¥/åˆ é™¤ï¼‰
                if (newValue.length > oldValue.length) {
                    // æ’å…¥æ“ä½œ
                    const diffStart = findDiffStart(oldValue, newValue);
                    const insertedText = newValue.substring(diffStart);
                    sendOperation({
                        op_type: 'insert',
                        position: diffStart,
                        text: insertedText,
                        revision: currentRevision
                    });
                } else if (newValue.length < oldValue.length) {
                    // åˆ é™¤æ“ä½œ
                    const diffStart = findDiffStart(newValue, oldValue);
                    const deletedText = oldValue.substring(diffStart);
                    sendOperation({
                        op_type: 'delete',
                        position: diffStart,
                        text: deletedText,
                        revision: currentRevision
                    });
                }

                lastValue = newValue; // æ›´æ–°åŸºå‡†å€¼
            });
        }

        // å‘é€æ“ä½œåˆ°åç«¯
        function sendOperation(operation) {
            if (collaborationSocket && collaborationSocket.readyState === WebSocket.OPEN) {
                collaborationSocket.send(JSON.stringify(operation));
            }
        }

        // æ‰¾åˆ°ä¸¤ä¸ªå­—ç¬¦ä¸²é¦–æ¬¡å·®å¼‚çš„ä½ç½®
        function findDiffStart(str1, str2) {
            const minLength = Math.min(str1.length, str2.length);
            for (let i = 0; i < minLength; i++) {
                if (str1[i] !== str2[i]) return i;
            }
            return minLength; // å‰minLengthä¸ªå­—ç¬¦ç›¸åŒ
        }

        // åº”ç”¨è¿œç¨‹æ“ä½œåˆ°æœ¬åœ°ç¼–è¾‘å™¨
        function applyOperationToEditor(operation) {
            const editor = document.getElementById('content');
            if (!editor) return;

            const currentValue = editor.value;
            let newValue = currentValue;

            // æ ¹æ®æ“ä½œç±»å‹å¤„ç†
            if (operation.op_type === 'insert') {
                // æ’å…¥æ“ä½œ
                newValue = currentValue.substring(0, operation.position)
                        + operation.text
                        + currentValue.substring(operation.position);
            } else if (operation.op_type === 'delete') {
                // åˆ é™¤æ“ä½œ
                newValue = currentValue.substring(0, operation.position)
                        + currentValue.substring(operation.position + operation.text.length);
            }

            // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹å¹¶ä¿æŒå…‰æ ‡ä½ç½®
            const cursorPos = operation.position + operation.text.length;
            editor.value = newValue;
            editor.setSelectionRange(cursorPos, cursorPos);

            // æ›´æ–°æœ¬åœ°åŸºå‡†å€¼ï¼ˆé¿å…è§¦å‘æœ¬åœ°inputäº‹ä»¶ï¼‰
            lastValue = newValue;
        }
    </script >
</body >
</html >