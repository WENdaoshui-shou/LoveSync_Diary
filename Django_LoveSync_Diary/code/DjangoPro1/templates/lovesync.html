<!DOCTYPE html>
<html lang = "zh-CN" >
<head >
    <meta charset = "UTF-8" >
    <meta name = "viewport" content = "width=device-width, initial-scale=1.0" >
    <title >LoveSync 双人日记</title >
    <script src = "https://cdn.tailwindcss.com" ></script >
    <link href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel = "stylesheet" >
    <link href = "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
          rel = "stylesheet" >

    <!-- Tailwind 配置 -->
    <script >
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B8B', // 爱情粉色
                        secondary: '#722ED1', // 紫色辅助色
                        heart: '#FF6B8B',    // 心动
                        happy: '#81E67F',    // 开心
                        laugh: '#FFD700',    // 大笑
                        sad: '#3B82F6',      // 难过
                        angry: '#8B008B',    // 生气
                        calm: '#64748B',     // 平静
                        neutral: {
                            100: '#F9F9F9',
                            200: '#F0F0F0',
                            300: '#E0E0E0',
                            400: '#BDBDBD',
                            500: '#9E9E9E',
                            600: '#757575',
                            700: '#616161',
                            800: '#424242',
                            900: '#212121',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            }
        }
    </script >

    <style type = "text/tailwindcss" >
        @layer utilities {
            .diary-trigger {
                transition: all 0.3s ease;
            }

            .diary-trigger:hover {
                transform: scale(1.02);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .mood-modal {
                background-color: var(--mood-color, #FF6B8B);
            }

            .blur-effect {
                backdrop-filter: blur(4px);
            }

            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }

            .transition-custom {
                transition: all 0.3s ease;
            }

            .hover-scale {
                transition: transform 0.3s ease;
            }

            .hover-scale:hover {
                transform: scale(1.02);
            }

            .bg-gradient-love {
                background: linear-gradient(135deg, #FF6B8B 0%, #722ED1 100%);
            }

            .diary-trigger {
                position: relative;
            }

            .diary-trigger:hover::after {
                position: absolute;
                bottom: -24px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                font-size: 0.875rem;
                padding: 2px 8px;
                border-radius: 4px;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s ease;
            }

            .diary-trigger:hover::after {
                opacity: 1;
                visibility: visible;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        .animate-bounce {
            animation: bounce 1.5s infinite;
        }
    </style >
</head >

<body class = "font-inter bg-neutral-100 text-neutral-800 min-h-screen flex flex-col overflow-x-hidden relative scroll-smooth" >
    <!-- 背景装饰元素 -->
    <div class = "absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none" >
        <div class = "absolute -top-40 -left-40 w-80 h-80 bg-primary/10 rounded-full filter blur-3xl float-animation" ></div >
        <div class = "absolute -bottom-20 -right-20 w-80 h-80 bg-secondary/10 rounded-full filter blur-3xl float-animation"
             style = "animation-delay: -2s;" ></div >
        <div class = "absolute top-1/3 right-1/4 w-40 h-40 bg-primary/5 rounded-full filter blur-2xl float-animation"
             style = "animation-delay: -4s;" ></div >
    </div >

    <!-- 导航栏 -->
    <header class = "fixed w-full top-0 z-50 transition-all duration-300 bg-white/95 backdrop-blur-md shadow-sm py-3" >
        <div class = "container mx-auto px-4 flex items-center justify-between" >
            <!-- 品牌标识 -->
            <a href = "{% url 'index' %}" class = "flex items-center space-x-2" >
                <div class = "w-10 h-10 rounded-full bg-gradient-love flex items-center justify-center text-white shadow-md" >
                    <i class = "fa-solid fa-heart text-xl" ></i >
                </div >
                <span class = "text-xl font-bold text-neutral-800 tracking-tight" >LoveSync</span >
            </a >
            <!-- 桌面端导航菜单 -->
            <nav class = "hidden md:flex items-center space-x-6" >
                <a href = "{% url 'community' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >爱享公社</a >
                <a href = "{% url 'moments' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >心动轨迹</a >
                <a href = "{% url 'photo_album' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >心跳相簿</a >
                <a href = "{% url 'lovesync' %}"
                   class = "text-neutral-700 hover:text-primary transition-custom font-medium px-1 py-2 border-b-2 border-transparent hover:border-primary" >双人日记</a >

                <!-- 更多下拉菜单 -->
                <div class = "relative" id = "moreDropdown" >
                    <button
                            class = "text-neutral-700 hover:text-primary transition-custom font-medium flex items-center px-1 py-2"
                            id = "moreButton" >
                        更多 <i class = "fa-solid fa-chevron-down ml-1 text-xs" ></i >
                    </button >
                    <div class = "absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
                         id = "moreOptions" >
                        <a href = "{% url 'couple' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-calendar-heart mr-2 w-5 text-center" ></i >情侣设置
                        </a >
                        <a href = "{% url 'couple_recommendation' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-gift mr-2 w-5 text-center" ></i >情侣推荐
                        </a >
                        <a href = "{% url 'couple_places' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-map-marker-heart mr-2 w-5 text-center" ></i >情侣地点
                        </a >
                        <a href = "{% url 'couple_test' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-question-circle mr-2 w-5 text-center" ></i >爱情测试
                        </a >
                    </div >
                </div >
            </nav >

            <!-- 内容过滤器 -->
            <div class = "bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-2 flex justify-between items-center hover-scale" >
                <div class = "flex space-x-2" >
                    <button class = "px-4 py-2 rounded-full bg-primary text-white text-sm font-medium" >
                        推荐
                    </button >
                    <button class = "px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom" >
                        最新
                    </button >
                    <button class = "px-4 py-2 rounded-full bg-neutral-100 text-neutral-700 text-sm font-medium hover:bg-neutral-200 transition-custom" >
                        热门
                    </button >
                </div >
                <div class = "relative" >
                    <input type = "text" placeholder = "LoveSync: 搜索..."
                           class = "pl-10 pr-4 py-2 rounded-full border border-neutral-200 focus:outline-none focus:ring-2 focus:ring-primary/50 form-input-focus text-sm" >
                    <i class = "fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" ></i >
                </div >
            </div >

            <!-- 用户操作区 -->
            <div class = "flex items-center space-x-4" >
                <a href = "{% url 'moments' %}" id = "createPostLink"
                   class = "hidden md:flex items-center space-x-2 px-5 py-2 rounded-full bg-gradient-love text-white hover:opacity-90 transition-custom shadow-md hover:shadow-lg" >
                    <i class = "fa-solid fa-pencil" ></i >
                    <span >发布动态</span >
                </a >

                <!-- 用户头像与下拉菜单 -->
                <div class = "relative" id = "userDropdown" >
                    <div class = "w-10 h-10 rounded-full overflow-hidden border-2 border-primary cursor-pointer shadow-sm"
                         id = "userAvatar" >
                        <img src = "{{ user.profile.userAvatar.url }}" alt = "用户头像"
                             class = "w-full h-full object-cover" >
                    </div >
                    <div class = "absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2 z-50 hidden"
                         id = "userOptions" >
                        <a href = "{% url 'personal_center' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-user mr-2 w-5 text-center" ></i >主页
                        </a >
                        <a href = "{% url 'message' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-bookmark mr-2 w-5 text-center" ></i >消息
                        </a >
                        <a href = "{% url 'settings' %}"
                           class = "block px-4 py-2 text-neutral-700 hover:bg-neutral-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-cog mr-2 w-5 text-center" ></i >设置
                        </a >
                        <div class = "border-t border-neutral-200 my-1" ></div >
                        <a href = "{% url 'logout' %}"
                           class = "block px-4 py-2 text-red-500 hover:bg-red-50 transition-custom flex items-center" >
                            <i class = "fa-solid fa-sign-out mr-2 w-5 text-center" ></i >退出登录
                        </a >
                    </div >
                </div >

                <!-- 移动端菜单按钮 -->
                <button class = "md:hidden text-neutral-700 focus:outline-none" id = "menu-toggle" >
                    <i class = "fa-solid fa-bars text-xl" ></i >
                </button >
            </div >
        </div >

        <!-- 移动端菜单 -->
        <div id = "mobile-menu"
             class = "hidden md:hidden bg-white shadow-lg absolute w-full transform -translate-y-2 opacity-0 transition-all duration-200 ease-in-out"
             style = "top: 100%;" >
            <div class = "container mx-auto px-4 py-3 flex flex-col space-y-3" >
                <a href = "{% url 'community' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-users mr-3 w-5 text-center" ></i >爱享公社
                </a >
                <a href = "{% url 'moments' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-bolt mr-3 w-5 text-center" ></i >心动轨迹
                </a >
                <a href = "{% url 'photo_album' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-images mr-3 w-5 text-center" ></i >心跳相簿
                </a >
                <a href = "{% url 'lovesync' %}"
                   class = "text-neutral-700 hover:text-primary py-2 transition-custom font-medium flex items-center" >
                    <i class = "fa-solid fa-bookmark mr-3 w-5 text-center" ></i >双人日记
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-calendar-heart mr-3 w-5 text-center" ></i >纪念日提醒
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-gift mr-3 w-5 text-center" ></i >礼物推荐
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-map-marker-heart mr-3 w-5 text-center" ></i >情侣地点
                </a >
                <a href = "#" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-question-circle mr-3 w-5 text-center" ></i >爱情测试
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "{% url 'personal_center' %}"
                   class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-user mr-3 w-5 text-center" ></i >主页
                </a >
                <a href = "{% url 'message' %}" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-bookmark mr-3 w-5 text-center" ></i >消息
                </a >
                <a href = "{% url 'message' %}" class = "text-neutral-700 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-cog mr-3 w-5 text-center" ></i >设置
                </a >
                <div class = "border-t border-neutral-200 my-1" ></div >
                <a href = "{% url 'logout' %}" class = "text-red-500 py-2 transition-custom flex items-center" >
                    <i class = "fa-solid fa-sign-out mr-3 w-5 text-center" ></i >退出登录
                </a >
            </div >
        </div >
    </header >


    <!-- 主内容区 -->
    <main class = "flex-grow pt-24 pb-16 relative z-10" >
        <div class = "container mx-auto px-4" >
            <!-- 顶部数据概览 -->
            <div class = "bg-white rounded-xl shadow-lg p-6 mb-8 animate-fade-in" >
                <div class = "flex flex-col md:flex-row items-center justify-between" >
                    <div class = "mb-4 md:mb-0" >
                        <h2 class = "text-2xl font-bold text-neutral-800 mb-1" >我们的爱情日记</h2 >
                        <p class = "text-neutral-600" >已共同记录 <span
                                class = "text-primary font-semibold" >{{ total_notes }}</span > 篇日记 · 相恋 <span
                                class = "text-primary font-semibold" id = "days-together"
                                data-joined-date = "{{ user.profile.couple_joined_at|date:"Y-m-d"}}" ></span > 天</p >
                    </div >

                    <div class = "flex space-x-4" >
                        <!-- 我的信息卡片 -->
                        <div class = "bg-neutral-100 rounded-lg p-3 flex items-center space-x-3" >
                            <div class = "w-10 h-10 rounded-full overflow-hidden" >
                                <!-- 使用default过滤器确保没有头像时显示默认图片 -->
                                <img src = "
                                        {{ user.profile.userAvatar.url|default:'https://picsum.photos/200/200?random=1' }}"
                                     alt = "我的头像"
                                     class = "w-full h-full object-cover" >
                            </div >
                            <div >
                                <p class = "text-sm font-medium" >我</p >
                                <p class = "text-xs text-neutral-500" >已写 {{ user_notes_count|default:0 }} 篇</p >
                            </div >
                        </div >

                        <!-- 伴侣信息卡片 -->
                        {% if user.profile.couple %}
                            <div class = "bg-neutral-100 rounded-lg p-3 flex items-center space-x-3" >
                            <div class = "w-10 h-10 rounded-full overflow-hidden" >
                                <!-- 确保伴侣有头像，没有则显示默认 -->
                                <img src = "
                                        {{ user.profile.couple.user.profile.userAvatar.url|default:'https://picsum.photos/200/200?random=2' }}"
                                     alt = "{{ user.profile.couple.user.name }}的头像"
                                     class = "w-full h-full object-cover" >
                            </div >
                            <div >
                                <p class = "text-sm font-medium" >{{ user.profile.couple.user.name|default:"伴侣" }}</p >
                                <p class = "text-xs text-neutral-500" >已写 {{ partner_notes_count|default:0 }} 篇</p >
                            </div >
                        </div >
                        {% else %}
                        <!-- 没有伴侣时显示邀请卡片 -->
                            <div class = "bg-neutral-100 rounded-lg p-3 flex items-center space-x-3 cursor-pointer hover:bg-neutral-200 transition-colors"
                                 onclick = "location.href='{% url 'invite_partner' %}'" >
                            <div class = "w-10 h-10 rounded-full overflow-hidden bg-neutral-200 flex items-center justify-center" >
                                <i class = "fa fa-user-plus text-neutral-400" ></i >
                            </div >
                            <div >
                                <p class = "text-sm font-medium text-neutral-700" >邀请伴侣</p >
                                <p class = "text-xs text-primary" >一起记录美好时光</p >
                            </div >
                        </div >
                        {% endif %}
                    </div >
                </div >

                <!-- 本周心情统计 -->
                <div class = "mt-6 pt-6 border-t border-neutral-200" >
                    <h3 class="text-lg font-semibold text-neutral-800 flex items-center justify-between mb-4">
                        <span>本周心情</span>
                        <span class="text-xs text-primary/70 hover:text-primary transition-colors cursor-pointer"
                              id="write-diary-hint">
                            点击卡片写日记
                        </span>
                    </h3>
                    <div class = "grid grid-cols-2 md:grid-cols-6 gap-3" >
                        {% for item in mood_stats %}
                            <!-- 即使count为0，也会渲染卡片 -->
                            <div class = "bg-{{ item.css_class }}/10 rounded-lg p-3 text-center cursor-pointer diary-trigger hover:scale-105 transition-transform duration-300"
                                 data-mood = "{{ item.mood }}" data-color = "{{ item.color }}" >
                                <div class = "text-2xl mb-1" >{{ item.icon }}</div >
                                <p class = "text-sm font-medium" >{{ item.display }}</p >
                                <p class = "text-xs text-{{ item.css_class }}" >{{ item.count }} 次</p >

                            </div >
                        {% endfor %}
                    </div >
                </div >
            </div >

            <!-- 时间轴双视角布局 -->
            <div class = "relative" >

                <!-- 时间轴分割线 -->
                <div class = "hidden md:block absolute left-1/2 top-0 bottom-0 w-0.5 bg-neutral-200 transform -translate-x-1/2" ></div >

                <!-- 时间轴条目 -->
                <div class = "space-y-12" >
                    <!-- 日记列表（按日期分组展示） -->
                    {% for date_group in grouped_notes %}
                        <div class = "relative" >
                        <!-- 日期标题（动态显示今天/昨天/具体日期） -->
                        <div class = "text-center mb-8" >
                            <span class = "inline-block px-4 py-1 bg-white rounded-full shadow-sm text-neutral-600 font-medium" >
                                <i class = "fa-solid fa-calendar-day mr-2" ></i >
                                {{ date_group.date_title }}  <!-- 动态日期标题：今天/昨天/具体日期 -->
                            </span >
                        </div >

                        <!-- 该日期下的所有日记 -->
                            {% for note in date_group.notes %}
                        <!-- 判断日记属于当前用户还是情侣，设置不同布局 -->
                                <div class = "{% if note.user == request.user %}md:w-1/2 md:pl-12{% else %}md:ml-auto md:w-1/2 md:pr-12 partner-card{% endif %} {% if not forloop.first %}mt-8{% endif %}" >
                            <div class = "bg-white rounded-xl shadow-md p-5 relative diary-card-hover"
                                 style = "--mood-color: {{ note.get_mood_color }};"
                                 data-mood = "{{ note.mood }}" >

                                 <!-- 心情指示器（动态图标） -->
                                <div class = "absolute -left-3 -top-3 w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center mood-indicator"
                                     style = "color: {{ note.get_mood_color }}" >
                                    {{ note.get_mood_icon }}
                                </div >

                                 <!-- 用户信息和时间 -->
                                <div class = "flex justify-between items-start mb-3" >
                                    <div class = "flex items-center" >
                                        <div class = "w-8 h-8 rounded-full overflow-hidden mr-2" >
                                            <!-- 动态用户头像 -->
                                            <img src = "{{ note.user.profile.userAvatar.url }}"
                                                 alt = "{{ note.user.name }}的头像"
                                                 class = "w-full h-full object-cover" >
                                        </div >
                                        <!-- 动态显示用户名（区分"我"和TA） -->
                                        <span class = "font-medium" >
                                            {% if note.user == request.user %}我{% else %}
                                                {{ note.user.name }}{% endif %}
                                        </span >
                                    </div >
                                    <!-- 动态显示时间（格式化到小时分钟） -->
                                    <span class = "text-sm text-neutral-500" >
                                        {{ note.created_at|date:"H:i" }}
                                    </span >
                                </div >

                                 <!-- 日记内容 -->
                                <p class = "text-neutral-700 mb-4" >
                                    {{ note.context }}
                                </p >

                                 <!-- 日记图片 -->
                                {% if note.note_images.exists %}
                                    <div class = "{% if note.note_images.count > 1 %}grid grid-cols-2 gap-2{% else %}block{% endif %} mb-4" >
                                    {% for image in note.note_images.all %}
                                        <div class = "rounded-lg overflow-hidden" >
                                        <img src = "{{ image.noteimage.url }}"
                                             alt = "日记图片"
                                             class = "w-full {% if note.note_images.count == 1 %}h-auto{% else %}h-32{% endif %} object-cover" >
                                    </div >
                                    {% endfor %}
                                </div >
                                {% endif %}

                                 <!-- 操作区（点赞数、评论按钮） -->
                                <div class = "flex justify-between items-center" >
                                    <!-- 动态心情标签 -->
                                    <span class = "text-xs text-{{ note.mood }} bg-{{ note.mood }}/10 px-2 py-1 rounded-full" >
                                        {{ note.get_mood_display_text }}
                                    </span >
                                    <div class = "flex items-center space-x-3" >
                                        <!-- 动态点赞数 -->
                                        <button class = "like-btn text-neutral-400 hover:text-primary transition-colors"
                                                data-note-id = "{{ note.id }}" >
                                            <i class = "fa-solid fa-heart" ></i >
                                            {% if note.likes > 0 %} {{ note.likes }} {% endif %}
                                        </button >
                                        <!-- 评论按钮 -->
                                        <button class = "text-neutral-400 hover:text-primary transition-colors response-btn"
                                                data-diary-id = "{{ note.id }}" >
                                            <i class = "fa-solid fa-reply" ></i >
                                            {% if note.comments > 0 %} {{ note.comments }} {% endif %}
                                        </button >
                                    </div >
                                </div >

                                 <!-- 评论输入框 -->
                                <div id = "comment-input-{{ note.id }}"
                                     class = "hidden mt-4 pt-4 border-t border-neutral-100" >
                                    <div class = "flex items-start space-x-2" >
                                        <div class = "w-6 h-6 rounded-full overflow-hidden" >
                                            <img src = "{{ user.profile.userAvatar.url }}" alt = "我的头像"
                                                 class = "w-full h-full object-cover" >
                                        </div >
                                        <div class = "flex-1" >
                                            <textarea
                                                    class = "w-full p-2 text-sm border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary"
                                                    placeholder = "写下你的回应..." rows = "1"
                                                    data-note-id = "{{ note.id }}"
                                                    class = "comment-input" ></textarea >
                                            <div class = "flex justify-end mt-2" >
                                                <button class = "text-xs bg-primary text-white px-3 py-1 rounded-full hover:bg-primary/90 transition-colors comment-submit"
                                                        data-note-id = "{{ note.id }}" >
                                                    发送
                                                </button >
                                            </div >
                                        </div >
                                    </div >
                                </div >

                                 <!-- 回应区域（动态显示评论） -->
                                {% if note.comments > 0 %}
                                    <div class = "mt-4 pt-4 border-t border-neutral-100" >
                                    {% for comment in note.comment_set.all|slice:":1" %}
                                        <div class = "flex items-start mb-2" >
                                        <div class = "w-6 h-6 rounded-full overflow-hidden mr-2" >
                                            <img src = "{{ comment.user.profile.userAvatar.url }}"
                                                 alt = "{{ comment.user.username }}的头像"
                                                 class = "w-full h-full object-cover" >
                                        </div >
                                        <div class = "flex-1" >
                                            <div class = "bg-neutral-100 rounded-lg p-3" >
                                                <p class = "text-sm text-neutral-700" >{{ comment.context }}</p >
                                            </div >
                                        </div >
                                    </div >
                                    {% endfor %}
                                        <!-- 显示更多评论按钮（如果有） -->
                                        {% if note.comments > 1 %}
                                            <button class = "text-xs text-primary mt-1 view-all-comments"
                                                    data-note-id = "{{ note.id }}" >
                                        查看全部{{ note.comments }}条评论
                                    </button >
                                        {% endif %}
                                </div >
                                {% endif %}
                            </div >
                                </div >
                            {% endfor %}
                        </div >
                        {% empty %}

                    <!-- 无日记时显示 -->
                        <div class = "text-center py-12" >
                        <div class = "w-16 h-16 rounded-full bg-neutral-100 flex items-center justify-center mx-auto mb-4" >
                            <i class = "fa-solid fa-book-open text-neutral-400 text-xl" ></i >
                        </div >
                        <p class = "text-neutral-500" >还没有日记哦，开始记录你们的故事吧～</p >
{#                        <button class = "mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors diary-trigger"#}
{#                                data-mood = "happy" data-color = "#81E67F" >#}
{#                            <i class = "fa-solid fa-pencil-alt mr-2" ></i >开始写日记#}
{#                        </button >#}
                    </div >
                    {% endfor %}
                </div >
            </div >
        </div >
    </main >

    <!-- 页脚 -->
    <footer class = "bg-white border-t border-neutral-200 py-8" >
        <div class = "container mx-auto px-4" >
            <div class = "flex flex-col md:flex-row justify-between items-center" >
                <div class = "flex items-center space-x-2" >
                    <div class = "w-8 h-8 bg-gradient-love rounded-full text-white" >
                        <i class = "fa-solid fa-heart" ></i >
                    </div >
                    <span class = "text-lg font-bold" >LoveSync</span >
                </div >
                <div class = "text-neutral-500 text-sm" >
                    &copy; 2025 LoveSync. 每篇日记都是一棵树，年轮里藏着我们的故事
                </div >
            </div >
        </div >
    </footer >

    <!-- 日记编辑模态框 -->
    <div id = "new-diary-modal" class = "fixed inset-0 z-50 flex items-center justify-center hidden" >
        <div class = "absolute inset-0 bg-black/50 backdrop-blur-sm" ></div >
        <div class = "bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-slide-up relative z-10" >
            <div class = "p-6 border-b border-neutral-200 flex justify-between items-center" >
                <h3 class = "text-xl font-bold text-neutral-800" >写日记</h3 >
                <button id = "close-diary-modal" class = "text-neutral-500 hover:text-neutral-800" >
                    <i class = "fa-solid fa-times" ></i >
                </button >
            </div >

            <form id = "diary-form" method = "POST" enctype = "multipart/form-data" class = "p-6" >
                {% csrf_token %}
                <input type = "hidden" name = "mood" id = "mood-input" >
                <input type = "hidden" id = "mood-color-input" >

                <!-- 日记内容 -->
                <div class = "mb-6" >
                    <label class = "block text-sm font-medium text-neutral-700 mb-2" >记录今日心动</label >
                    <textarea id = "context" name = "context" rows = "6"
                              class = "w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-custom resize-none"
                              placeholder = "记录今天的心情和故事..." ></textarea >
                </div >

                <!-- 上传照片 -->
                <div class = "mb-6" >
                    <label class = "block text-sm font-medium text-neutral-700 mb-2" >上传照片（可选）</label >
                    <div class = "border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary transition-custom cursor-pointer"
                         id = "photo-upload-area" >
                        <input type = "file" id = "photo-input" name = "photos" multiple accept = "image/*"
                               class = "hidden" >
                        <i class = "fa-solid fa-cloud-upload-alt text-3xl text-neutral-400 mb-3" ></i >
                        <p class = "text-neutral-600 mb-2" >点击或拖拽照片到这里</p >
                        <p class = "text-neutral-500 text-sm" >支持 JPG, PNG, GIF 格式</p >
                    </div >
                    <div id = "photo-preview-container" class = "grid grid-cols-3 gap-2 mt-3 hidden" ></div >
                </div >

                <!-- 分享选项 -->
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm font-medium text-neutral-700">分享给TA</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="share-with-partner" name="share_with_partner" class="sr-only peer" checked>
                            <div id="share-toggle" class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary" ></div>
                        </label>
                    </div>
                    <p class="text-xs text-neutral-500 mt-1">开启后，你的伴侣将看到这篇日记</p>
                </div>

                <!-- 提交按钮 -->
                <div class = "flex justify-end space-x-3" >
                    <button type = "button" id = "cancel-diary"
                            class = "px-6 py-2 border border-neutral-300 rounded-md text-neutral-700 hover:bg-neutral-50 transition-custom" >
                        取消
                    </button >
                    <button type = "submit" id = "saveButton"
                            class = "px-6 py-2 text-white rounded-lg hover:opacity-90 transition-custom shadow-md hover:shadow-lg flex items-center" >
                        <i class = "fa-solid fa-paper-plane mr-2" ></i >
                        <span >保存日记</span >
                    </button >
                </div >
            </form >
        </div >
    </div >


    <script >
        const moodColors = {};
        document.querySelectorAll('.diary-trigger').forEach(trigger => {
            moodColors[trigger.dataset.mood] = trigger.dataset.color;
        });

        let currentMoodColor = '#FF6B8B';
        let lastValue = ''; // 全局变量：记录编辑器上一次值（用于协作对比）
        let currentDocumentId = "{{ document.id|default:'' }}"; // 当前日记ID
        let currentRevision = 0;
        let isProcessingRemoteOp = false;
        let collaborationSocket = null;

        // DOM加载后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initMoodTriggers();
            initDiaryModal();
            initPhotoUpload();
            initNavDropdowns();
            initMobileMenu();
            initCollaboration(); // 初始化实时协作
        });

        // 初始化心情触发
        function initMoodTriggers() {
            const triggers = document.querySelectorAll('.diary-trigger');
            const moodInput = document.getElementById('mood-input');
            const moodColorInput = document.getElementById('mood-color-input');

            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const mood = trigger.dataset.mood;
                    currentMoodColor = moodColors[mood];
                    moodInput.value = mood;
                    moodColorInput.value = currentMoodColor;
                    updateSaveButtonColor();
                    openDiaryModal();
                });
            });
        }

        // 更新保存按钮颜色
        function updateSaveButtonColor() {
            const saveButton = document.getElementById('saveButton');
            const shareToggle = document.getElementById('share-toggle');

            saveButton.style.backgroundColor = currentMoodColor;
            saveButton.style.backgroundImage = `linear-gradient(135deg, ${currentMoodColor} 0%, ${currentMoodColor} 100%)`;
            saveButton.classList.remove('bg-gradient-love');
        }

        // 初始化模态框
        function initDiaryModal() {
            document.getElementById('close-diary-modal')?.addEventListener('click', closeDiaryModal);
            document.getElementById('cancel-diary')?.addEventListener('click', closeDiaryModal);

            const saveButton = document.getElementById('saveButton');
            saveButton.addEventListener('click', function () {
                this.classList.add('bg-gradient-love');
            });
        }

        // 打开日记模态框
        function openDiaryModal() {
            const modal = document.getElementById('new-diary-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // 重置编辑器状态（针对新日记）
            const editor = document.getElementById('context');
            lastValue = editor.value; // 初始化基准值
        }

        // 关闭日记模态框
        function closeDiaryModal() {
            const modal = document.getElementById('new-diary-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 初始化照片上传
        function initPhotoUpload() {
            const uploadArea = document.getElementById('photo-upload-area');
            const input = document.getElementById('photo-input');
            const previewContainer = document.getElementById('photo-preview-container');

            uploadArea.addEventListener('click', () => input.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    previewPhotos(input.files, previewContainer);
                }
            });

            input.addEventListener('change', (e) => {
                previewPhotos(e.target.files, previewContainer);
            });
        }

        // 预览照片
        function previewPhotos(files, container) {
            container.innerHTML = '';
            if (!files.length) return container.classList.add('hidden');

            container.classList.remove('hidden');
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'w-full h-24 object-cover rounded-lg';
                container.appendChild(img);
            });
        }

        // 初始化导航下拉菜单
        function initNavDropdowns() {
            // 用户头像下拉
            const userAvatar = document.getElementById('userAvatar');
            const userOptions = document.getElementById('userOptions');
            let userDropdownTimer;

            userAvatar.addEventListener('mouseenter', () => {
                clearTimeout(userDropdownTimer);
                userOptions.classList.remove('hidden');
            });
            userAvatar.addEventListener('click', () => {
                userOptions.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#userDropdown')) {
                    userOptions.classList.add('hidden');
                }
            });

            // 更多下拉菜单
            const moreButton = document.getElementById('moreButton');
            const moreOptions = document.getElementById('moreOptions');
            let moreDropdownTimer;

            moreButton.addEventListener('mouseenter', () => {
                clearTimeout(moreDropdownTimer);
                moreOptions.classList.remove('hidden');
            });
            moreButton.addEventListener('click', () => {
                moreOptions.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#moreDropdown')) {
                    moreOptions.classList.add('hidden');
                }
            });
        }

        // 初始化移动端菜单
        function initMobileMenu() {
            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');

            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('translate-y-0');
                mobileMenu.classList.toggle('opacity-100');
            });
        }

        // 初始化实时协作（WebSocket连接）
        function initCollaboration() {
            if (!currentDocumentId && !document.getElementById('context')) return;

            // 连接WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const socketUrl = `${protocol}//${window.location.host}/ws/collaboration/${currentDocumentId || 'new'}/`;

            collaborationSocket = new WebSocket(socketUrl);

            // 连接成功
            collaborationSocket.onopen = function () {
                console.log("实时协作连接已建立");
                // 初始化编辑器基准值
                const editor = document.getElementById('context');
                if (editor) lastValue = editor.value;
            };

            // 接收远程操作
            collaborationSocket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                // 忽略自己发送的操作
                if (data.user_id === "{{ request.user.id }}") return;

                isProcessingRemoteOp = true;
                try {
                    applyOperationToEditor(data); // 应用远程操作
                    currentRevision = data.revision; // 更新版本号
                } finally {
                    isProcessingRemoteOp = false;
                }
            };

            // 连接关闭重连
            collaborationSocket.onclose = function () {
                console.log("协作连接关闭，3秒后重连...");
                setTimeout(initCollaboration, 3000);
            };

            // 绑定编辑器事件（发送本地操作）
            bindEditorEvents();
        }

        // 绑定编辑器事件（捕获本地操作并发送）
        function bindEditorEvents() {
            const editor = document.getElementById('context');
            if (!editor) return;

            editor.addEventListener('input', function () {
                if (isProcessingRemoteOp) return; // 忽略远程操作触发的本地变化

                const newValue = editor.value;
                const oldValue = lastValue;

                // 计算操作类型（插入/删除）
                if (newValue.length > oldValue.length) {
                    // 插入操作
                    const diffStart = findDiffStart(oldValue, newValue);
                    const insertedText = newValue.substring(diffStart);
                    sendOperation({
                        op_type: 'insert',
                        position: diffStart,
                        text: insertedText,
                        revision: currentRevision
                    });
                } else if (newValue.length < oldValue.length) {
                    // 删除操作
                    const diffStart = findDiffStart(newValue, oldValue);
                    const deletedText = oldValue.substring(diffStart);
                    sendOperation({
                        op_type: 'delete',
                        position: diffStart,
                        text: deletedText,
                        revision: currentRevision
                    });
                }

                lastValue = newValue; // 更新基准值
            });
        }

        // 发送操作到后端
        function sendOperation(operation) {
            if (collaborationSocket && collaborationSocket.readyState === WebSocket.OPEN) {
                collaborationSocket.send(JSON.stringify(operation));
            }
        }

        // 找到两个字符串首次差异的位置
        function findDiffStart(str1, str2) {
            const minLength = Math.min(str1.length, str2.length);
            for (let i = 0; i < minLength; i++) {
                if (str1[i] !== str2[i]) return i;
            }
            return minLength; // 前minLength个字符相同
        }

        // 应用远程操作到本地编辑器
        function applyOperationToEditor(operation) {
            const editor = document.getElementById('context');
            if (!editor) return;

            const currentValue = editor.value;
            let newValue = currentValue;

            // 根据操作类型处理
            if (operation.op_type === 'insert') {
                // 插入操作
                newValue = currentValue.substring(0, operation.position)
                    + operation.text
                    + currentValue.substring(operation.position);
            } else if (operation.op_type === 'delete') {
                // 删除操作
                newValue = currentValue.substring(0, operation.position)
                    + currentValue.substring(operation.position + operation.text.length);
            }

            // 更新编辑器内容并保持光标位置
            const cursorPos = operation.position + operation.text.length;
            editor.value = newValue;
            editor.setSelectionRange(cursorPos, cursorPos);

            // 更新本地基准值（避免触发本地input事件）
            lastValue = newValue;
        }

        // 获取情侣关系建立日期
        const joinedDateElement = document.getElementById('days-together');
        const joinedDateStr = joinedDateElement.getAttribute('data-joined-date');

        if (joinedDateStr) {
            // 计算天数差
            const joinedDate = new Date(joinedDateStr);
            const today = new Date();
            const timeDiff = today.getTime() - joinedDate.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

            // 更新显示
            joinedDateElement.textContent = daysDiff;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 获取日记表单和内容输入框
            const diaryForm = document.getElementById('diary-form');
            const contentInput = document.getElementById('context');
            const is_shared = document.getElementById('share-with-partner');
            const images = document.getElementById('photo-input');


            // 如果表单不存在则不执行后续逻辑
            if (!diaryForm) return;

            // 表单提交处理
            diaryForm.addEventListener('submit', function (e) {
                e.preventDefault(); // 阻止默认提交行为

                // 验证内容是否为空
                if (!contentInput.value.trim()) {
                    alert('请输入日记内容');
                    return;
                }

                // 显示加载状态
                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 保存中...';

                // 准备表单数据
                const formData = new FormData(this);
                const shareWithPartner = document.getElementById('share-with-partner').checked;
                formData.append('share_with_partner', shareWithPartner ? '1' : '0');

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error('提交失败');
                    })
                    .then(data => {
                        // 可以在这里添加页面刷新或跳转到日记列表的逻辑
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('保存失败: ' + error.message);
                    })
                    .finally(() => {
                        // 恢复按钮状态
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    });
            });
        });
    </script >
</body >
</html >