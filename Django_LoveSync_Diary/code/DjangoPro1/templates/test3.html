// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 处理模态框
    const breakupBtn = document.getElementById('breakupBtn');
    const breakupModal = document.getElementById('breakupModal');
    const cancelBreakupBtn = document.getElementById('cancelBreakupBtn');
    const confirmBreakupBtn = document.getElementById('confirmBreakupBtn');
    
    const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const deleteAccountModal = document.getElementById('deleteAccountModal');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // 打开解除情侣关系模态框
    breakupBtn.addEventListener('click', function() {
        openModal(breakupModal);
    });
    
    // 打开删除账号模态框
    deleteAccountBtn.addEventListener('click', function() {
        openModal(deleteAccountModal);
    });
    
    // 关闭模态框通用函数
    function closeModal(modal) {
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.querySelector('div').classList.remove('scale-100');
        modal.querySelector('div').classList.add('scale-95');
        document.body.style.overflow = '';
    }
    
    // 打开模态框通用函数
    function openModal(modal) {
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.querySelector('div').classList.remove('scale-95');
        modal.querySelector('div').classList.add('scale-100');
        document.body.style.overflow = 'hidden';
    }
    
    // 关闭模态框事件监听
    cancelBreakupBtn.addEventListener('click', function() {
        closeModal(breakupModal);
    });
    
    cancelDeleteBtn.addEventListener('click', function() {
        closeModal(deleteAccountModal);
    });
    
    // 点击模态框外部关闭
    breakupModal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(breakupModal);
    });
    
    deleteAccountModal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(deleteAccountModal);
    });
    
    // 确认解除情侣关系
    confirmBreakupBtn.addEventListener('click', function() {
        // 这里添加解除情侣关系的AJAX请求
        simulateApiRequest('解除情侣关系中...', '情侣关系已解除', function() {
            closeModal(breakupModal);
            // 重定向到主页或关系管理页面
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        });
    });
    
    // 确认删除账号
    confirmDeleteBtn.addEventListener('click', function() {
        const password = deleteAccountModal.querySelector('input[type="password"]').value;
        if (!password) {
            showToast('请输入密码确认', 'error');
            return;
        }
        
        // 这里添加删除账号的AJAX请求
        simulateApiRequest('删除账号中...', '账号已成功删除', function() {
            closeModal(deleteAccountModal);
            // 重定向到登录页
            setTimeout(() => {
                window.location.href = '/login';
            }, 1000);
        });
    });
    
    // 返回按钮
    document.getElementById('backBtn').addEventListener('click', function() {
        window.history.back();
    });
    
    // 表单输入动画效果
    const formInputs = document.querySelectorAll('.form-input-focus');
    formInputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focus-within');
        });
        input.addEventListener('blur', function() {
            if (!this.value) {
                this.parentElement.classList.remove('focus-within');
            }
        });
    });
    
    // 计算相恋天数
    calculateDaysTogether();
    
    // 主题选择效果
    const themeOptions = document.querySelectorAll('[class*="border-2"]');
    themeOptions.forEach(option => {
        option.addEventListener('click', function() {
            // 移除所有选中状态
            themeOptions.forEach(opt => {
                opt.classList.remove('border-primary');
                opt.classList.add('border-transparent');
                
                const checkIcon = opt.querySelector('.fa-check');
                if (checkIcon) {
                    checkIcon.parentElement.classList.add('bg-white');
                    checkIcon.parentElement.classList.remove('bg-primary');
                    checkIcon.classList.add('opacity-0');
                }
            });
            
            // 设置当前选中状态
            this.classList.remove('border-transparent');
            this.classList.add('border-primary');
            
            const checkIcon = this.querySelector('.fa-check');
            if (checkIcon) {
                checkIcon.parentElement.classList.remove('bg-white');
                checkIcon.parentElement.classList.add('bg-primary');
                checkIcon.classList.remove('opacity-0');
            }
            
            // 获取主题颜色
            const themeColor = this.querySelector('.h-24').style.background;
            if (themeColor) {
                // 这里可以添加动态改变主题颜色的逻辑
                updateThemeColors(themeColor);
            }
        });
    });
    
    // 颜色选择器
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        input.addEventListener('input', function() {
            const colorPreview = this.previousElementSibling;
            colorPreview.style.backgroundColor = this.value;
            
            // 更新主题颜色
            if (this.id === 'primaryColor') {
                document.documentElement.style.setProperty('--primary-color', this.value);
            } else if (this.id === 'secondaryColor') {
                document.documentElement.style.setProperty('--secondary-color', this.value);
            }
        });
    });
    
    // 保存设置按钮
    document.querySelector('button.btn-pulse').addEventListener('click', function() {
        // 收集表单数据
        const formData = collectFormData();
        
        // 验证表单
        if (!validateForm(formData)) {
            return;
        }
        
        // 保存设置
        simulateApiRequest('保存设置中...', '设置已成功保存', function() {
            // 更新本地存储
            localStorage.setItem('coupleSettings', JSON.stringify(formData));
        });
    });
    
    // 收集表单数据
    function collectFormData() {
        return {
            coupleNames: [
                document.querySelector('input[type="text"]:first-of-type').value,
                document.querySelector('input[type="text"]:last-of-type').value
            ],
            anniversary: document.querySelector('input[type="date"]').value,
            story: document.querySelector('textarea').value,
            theme: getSelectedTheme(),
            primaryColor: document.querySelector('#primaryColor').value,
            secondaryColor: document.querySelector('#secondaryColor').value,
            privacy: {
                relationshipVisibility: document.querySelector('input[name="visibility"]:checked').value,
                postsVisible: document.querySelector('#postsVisible').checked,
                anniversariesVisible: document.querySelector('#anniversariesVisible').checked,
                giftsVisible: document.querySelector('#giftsVisible').checked
            },
            notifications: {
                partnerMessages: document.querySelector('#partnerMessages').checked,
                activities: document.querySelector('#activities').checked,
                anniversaries: document.querySelector('#anniversaries').checked
            }
        };
    }
    
    // 获取选中的主题
    function getSelectedTheme() {
        const selectedTheme = document.querySelector('[class*="border-primary"]');
        return selectedTheme ? selectedTheme.querySelector('h3').textContent : '热恋粉紫';
    }
    
    // 表单验证
    function validateForm(formData) {
        if (!formData.coupleNames[0] || !formData.coupleNames[1]) {
            showToast('请输入情侣名', 'error');
            return false;
        }
        
        if (!formData.anniversary) {
            showToast('请选择恋爱纪念日', 'error');
            return false;
        }
        
        return true;
    }
    
    // 计算相恋天数
    function calculateDaysTogether() {
        // 从localStorage获取保存的纪念日，如果没有则使用当前日期
        let anniversary = localStorage.getItem('coupleAnniversary');
        
        if (!anniversary) {
            // 设置默认日期为今天
            const today = new Date();
            anniversary = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            localStorage.setItem('coupleAnniversary', anniversary);
        }
        
        // 更新日期输入框
        document.querySelector('input[type="date"]').value = anniversary;
        
        // 计算天数
        const startDate = new Date(anniversary);
        const today = new Date();
        const timeDiff = today.getTime() - startDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
        
        // 更新显示
        document.getElementById('days-together').querySelector('span').textContent = daysDiff;
    }
    
    // 更新主题颜色
    function updateThemeColors(themeColor) {
        // 解析主题颜色并应用到根元素
        document.documentElement.style.setProperty('--theme-gradient', themeColor);
        
        // 这里可以添加更复杂的颜色解析和应用逻辑
    }
    
    // 模拟API请求
    function simulateApiRequest(loadingMsg, successMsg, callback) {
        showToast(loadingMsg, 'loading');
        
        // 模拟API请求延迟
        setTimeout(() => {
            showToast(successMsg, 'success');
            if (callback) callback();
        }, 1500);
    }
    
    // 显示提示消息
    function showToast(message, type = 'info') {
        // 移除已有的toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) existingToast.remove();
        
        // 创建新的toast
        const toast = document.createElement('div');
        toast.className = 'toast-notification fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-20 opacity-0';
        
        // 设置不同类型的样式
        if (type === 'success') {
            toast.classList.add('bg-green-500', 'text-white');
            toast.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
        } else if (type === 'error') {
            toast.classList.add('bg-red-500', 'text-white');
            toast.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
        } else if (type === 'loading') {
            toast.classList.add('bg-blue-500', 'text-white');
            toast.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>${message}`;
        } else {
            toast.classList.add('bg-gray-500', 'text-white');
            toast.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
        }
        
        // 添加到页面
        document.body.appendChild(toast);
        
        // 显示动画
        setTimeout(() => {
            toast.classList.remove('translate-y-20', 'opacity-0');
        }, 10);
        
        // 自动关闭
        if (type !== 'loading') {
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    }
    
    // 初始化页面
    function initPage() {
        // 从localStorage加载保存的设置
        const savedSettings = localStorage.getItem('coupleSettings');
        if (savedSettings) {
            try {
                const settings = JSON.parse(savedSettings);
                
                // 恢复情侣名
                document.querySelector('input[type="text"]:first-of-type').value = settings.coupleNames[0] || '';
                document.querySelector('input[type="text"]:last-of-type').value = settings.coupleNames[1] || '';
                
                // 恢复故事
                document.querySelector('textarea').value = settings.story || '';
                
                // 恢复主题
                const themeOption = Array.from(themeOptions).find(option => 
                    option.querySelector('h3').textContent === settings.theme
                );
                if (themeOption) {
                    themeOption.click();
                }
                
                // 恢复颜色
                document.querySelector('#primaryColor').value = settings.primaryColor || '#FF6B8B';
                document.querySelector('#secondaryColor').value = settings.secondaryColor || '#722ED1';
                
                // 恢复隐私设置
                document.querySelector(`input[name="visibility"][value="${settings.privacy.relationshipVisibility}"]`).checked = true;
                document.querySelector('#postsVisible').checked = settings.privacy.postsVisible;
                document.querySelector('#anniversariesVisible').checked = settings.privacy.anniversariesVisible;
                document.querySelector('#giftsVisible').checked = settings.privacy.giftsVisible;
                
                // 恢复通知设置
                document.querySelector('#partnerMessages').checked = settings.notifications.partnerMessages;
                document.querySelector('#activities').checked = settings.notifications.activities;
                document.querySelector('#anniversaries').checked = settings.notifications.anniversaries;
            } catch (e) {
                console.error('Failed to load saved settings', e);
            }
        }
        
        // 添加ID到开关元素以便更容易操作
        document.querySelectorAll('input[type="checkbox"]').forEach((checkbox, index) => {
            checkbox.id = ['postsVisible', 'anniversariesVisible', 'giftsVisible', 'partnerMessages', 'activities', 'anniversaries'][index] || `checkbox-${index}`;
            checkbox.nextElementSibling.setAttribute('for', checkbox.id);
        });
        
        // 添加ID到颜色选择器
        document.querySelectorAll('input[type="color"]')[0].id = 'primaryColor';
        document.querySelectorAll('input[type="color"]')[1].id = 'secondaryColor';
    }
    
    // 获取原始日期字符串（格式：2025年7月29日 13:58）
        const dateElement = document.querySelector('#days-together span');
        const dateStr = dateElement.textContent.trim();

        // 解析日期字符串为 Date 对象
        const [year, month, day, hour, minute] = dateStr.match(/\d+/g);
        const joinedDate = new Date(year, month - 1, day, hour, minute); // 月份从0开始

        // 计算当前时间与指定日期的差值（毫秒）
        const now = new Date();
        const diffMs = now - joinedDate;

        // 转换为天数（取绝对值）
        const diffDays = Math.abs(Math.floor(diffMs / (1000 * 60 * 60 * 24)));

        // 更新DOM显示
        dateElement.textContent = diffDays;
    
    // 初始化页面
    initPage();


});